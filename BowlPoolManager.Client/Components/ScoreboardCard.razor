@using BowlPoolManager.Core.Domain
@using BowlPoolManager.Core

<div class="card h-100 shadow-sm scoreboard-card">
    <div class="card-header bg-white border-bottom-0 pt-3 pb-2 d-flex justify-content-between align-items-center">
        <span class="small text-uppercase fw-bold text-muted text-truncate" title="@Game.BowlName">@Game.BowlName</span>
        @if (Game.Status == GameStatus.InProgress)
        {
            <span class="badge bg-danger animate-pulse">LIVE</span>
        }
        else if (Game.Status == GameStatus.Final)
        {
            <span class="badge bg-secondary">FINAL</span>
        }
        else
        {
            <span class="small text-muted">@GetFormattedTime()</span>
        }
    </div>
    <div class="card-body pt-0 pb-3">
        <!-- Away Team -->
        @{ var awayName = GetTeamName(false); var isAwayTbd = IsTBD(awayName); }
        <div class="d-flex align-items-center mb-2 team-row @(IsWinner(Game.TeamAway) ? "fw-bold" : "")" 
             style="border-left: 5px solid @(GetColor(Game.AwayTeamInfo, awayName)); padding-left: 10px;">
            @if (isAwayTbd || string.IsNullOrEmpty(GetLogo(Game.AwayTeamInfo)))
            {
                <i class="bi bi-shield-shaded me-2 text-secondary" style="font-size: 32px; width: 32px; text-align: center;"></i>
            }
            else
            {
                <img src="@GetLogo(Game.AwayTeamInfo)" alt="@awayName" class="me-2 team-logo" 
                     width="32" height="32" style="object-fit: contain;"
                     onerror="this.style.display='none'; this.nextElementSibling.style.display='inline-block';" />
                <i class="bi bi-shield-shaded me-2 text-secondary" style="font-size: 32px; width: 32px; text-align: center; display: none;"></i>
            }
            
            <div class="flex-grow-1 text-truncate @(isAwayTbd ? "fst-italic text-muted" : "")">
                @awayName
                @if (Game.TeamAwaySeed.HasValue)
                {
                    <span class="small text-muted ms-1">(@Game.TeamAwaySeed)</span>
                }
            </div>
            <div class="fs-5">@GetScore(Game.TeamAwayScore)</div>
        </div>

        <!-- Home Team -->
        @{ var homeName = GetTeamName(true); var isHomeTbd = IsTBD(homeName); }
        <div class="d-flex align-items-center team-row @(IsWinner(Game.TeamHome) ? "fw-bold" : "")" 
             style="border-left: 5px solid @(GetColor(Game.HomeTeamInfo, homeName)); padding-left: 10px;">
            @if (isHomeTbd || string.IsNullOrEmpty(GetLogo(Game.HomeTeamInfo)))
            {
                 <i class="bi bi-shield-shaded me-2 text-secondary" style="font-size: 32px; width: 32px; text-align: center;"></i>
            }
            else
            {
                <img src="@GetLogo(Game.HomeTeamInfo)" alt="@homeName" class="me-2 team-logo" 
                     width="32" height="32" style="object-fit: contain;"
                     onerror="this.style.display='none'; this.nextElementSibling.style.display='inline-block';" />
                <i class="bi bi-shield-shaded me-2 text-secondary" style="font-size: 32px; width: 32px; text-align: center; display: none;"></i>
            }
            
            <div class="flex-grow-1 text-truncate @(isHomeTbd ? "fst-italic text-muted" : "")">
                @homeName
                @if (Game.TeamHomeSeed.HasValue)
                {
                    <span class="small text-muted ms-1">(@Game.TeamHomeSeed)</span>
                }
            </div>
            <div class="fs-5">@GetScore(Game.TeamHomeScore)</div>
        </div>
        
        <div class="mt-2 d-flex justify-content-between align-items-center">
            <div class="text-muted text-truncate pe-2" style="font-size: 0.8rem;">
                @if (!string.IsNullOrEmpty(Game.Location))
                {
                    @Game.Location
                }
            </div>
            @if (!string.IsNullOrEmpty(Game.Television))
            {
                 <span class="badge bg-light text-dark border flex-shrink-0">@Game.Television</span>
            }
        </div>
    </div>
</div>

<style>
    .team-row {
        transition: background-color 0.2s;
        border-radius: 4px;
    }
    .animate-pulse {
        animation: pulse 2s infinite;
    }
    @@keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
    }
</style>

@code {
    [Parameter] public BowlGame Game { get; set; } = default!;
    [Parameter] public List<BowlGame>? AllGames { get; set; }

    private string GetFormattedTime()
    {
        return DateTimeHelper.ToCentral(Game.StartTime).ToString("MMM d â€¢ h:mm tt");
    }

    private string GetColor(TeamInfo? info, string resolvedName)
    {
        if (IsTBD(resolvedName)) return "#e9ecef"; // Grey for TBD
        return !string.IsNullOrEmpty(info?.Color) ? info.Color : "#ccc";
    }

    private string GetLogo(TeamInfo? info)
    {
        return !string.IsNullOrEmpty(info?.PrimaryLogoUrl) ? info.PrimaryLogoUrl : "";
    }
    
    // Helper since score can be null
    private string GetScore(int? score)
    {
        return score.HasValue ? score.Value.ToString() : "";
    }

    private bool IsWinner(string teamName)
    {
        if (!Game.IsFinal) return false;
        return Game.WinningTeamName == teamName;
    }

    private bool IsTBD(string name)
    {
        if (string.IsNullOrEmpty(name)) return true;
        if (name.Equals("TBD", StringComparison.OrdinalIgnoreCase)) return true;
        if (name.StartsWith("Winner of", StringComparison.OrdinalIgnoreCase)) return true;
        return false;
    }

    private string GetTeamName(bool isHome)
    {
        string currentName = isHome ? Game.TeamHome : Game.TeamAway;
        
        // If we have a valid name, and it's not literally "TBD", return it
        if (!string.IsNullOrEmpty(currentName) && !currentName.Equals("TBD", StringComparison.OrdinalIgnoreCase))
        {
            return currentName;
        }

        if (AllGames == null) return "TBD";

        // Logic from Results.razor
        var feeders = AllGames
            .Where(g => g.NextGameId == Game.Id)
            .OrderBy(g => g.StartTime)
            .ToList();

        if (feeders.Count == 0) return "TBD";

        if (feeders.Count == 1) 
        {
            return $"Winner of {feeders[0].BowlName}";
        }

        // 2 Feeders: Disambiguate
        string otherSlotName = isHome ? Game.TeamAway : Game.TeamHome;
        BowlGame? claimedFeeder = null;

        if (!string.IsNullOrEmpty(otherSlotName) && !otherSlotName.Equals("TBD", StringComparison.OrdinalIgnoreCase))
        {
            claimedFeeder = feeders.FirstOrDefault(f => f.Status == GameStatus.Final && f.WinningTeamName == otherSlotName);
        }

        if (claimedFeeder != null)
        {
            var unclaimed = feeders.FirstOrDefault(f => f.Id != claimedFeeder.Id);
            return unclaimed != null ? $"Winner of {unclaimed.BowlName}" : "TBD";
        }
        else
        {
            // Deterministic assignment
            return isHome ? $"Winner of {feeders[0].BowlName}" : $"Winner of {feeders[1].BowlName}";
        }
    }
}
