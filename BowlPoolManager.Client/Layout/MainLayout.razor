@inherits LayoutComponentBase
@using BowlPoolManager.Core.Domain
@using Microsoft.AspNetCore.Components.Authorization
@inject AuthenticationStateProvider AuthStateProvider
@inject HttpClient Http
@inject NavigationManager Nav

<div class="page">
    <div class="sidebar">
        <NavMenu />
    </div>

    <main>
        <div class="top-row px-4">
            <BowlPoolManager.Client.Shared.LoginDisplay />
        </div>

        <article class="content px-4">
            @Body
        </article>
    </main>

    @* GLOBAL SECURITY TOAST *@
    @if (showSecurityToast)
    {
         @* UPDATED: Changed bottom-0 to top-0 for high visibility *@
         <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 2000">
            <div class="toast show align-items-center text-white bg-danger border-0 shadow" role="alert">
                <div class="d-flex">
                    <div class="toast-body fs-6">
                         <i class="bi bi-exclamation-octagon-fill me-2"></i> @securityMessage
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private bool showSecurityToast = false;
    private string securityMessage = "";

    protected override async Task OnInitializedAsync()
    {
        try 
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var userPrincipal = authState.User;

            // Only check if they are actually logged in
            if (userPrincipal.Identity?.IsAuthenticated == true)
            {
                // Verify against our DB (The "Bouncer" Check)
                // We use GetMe to silently fetch the full profile
                var userProfile = await Http.GetFromJsonAsync<UserProfile>("api/GetMe");

                if (userProfile != null && userProfile.IsDisabled)
                {
                    // 1. Show Red Card
                    securityMessage = "Access Denied: Your account has been disabled.";
                    showSecurityToast = true;
                    StateHasChanged();

                    // 2. Wait for them to read it
                    await Task.Delay(3000);
                    
                    // 3. Eject (Force Logout)
                    Nav.NavigateTo("/.auth/logout?post_logout_redirect_uri=/", forceLoad: true);
                }
            }
        }
        catch (Exception ex)
        {
            // Fail open effectively, or log silently. 
            // If the API is down, we don't want to boot legitimate users, 
            // but we also can't check for bans. 
            Console.WriteLine($"Auth Check Failed: {ex.Message}");
        }
    }
}
