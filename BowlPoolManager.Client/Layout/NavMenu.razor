@using BowlPoolManager.Core.Domain
@using BowlPoolManager.Core
@using System.Net.Http.Json
@using BowlPoolManager.Client.Services
@implements IDisposable
@inject HttpClient Http
@inject AuthenticationStateProvider AuthStateProvider
@inject AppState AppState

<div class="top-row ps-3 navbar navbar-dark">
    <div class="container-fluid">
        <a class="navbar-brand d-flex align-items-center" href="">
            <img src="favicon.png" width="48" height="48" class="me-2" alt="Bowl Madness" />
            <span>Bowl Madness</span>
        </a>
        <button title="Navigation menu" class="navbar-toggler" @onclick="ToggleNavMenu">
            <span class="navbar-toggler-icon"></span>
        </button>
    </div>
</div>

<div class="@NavMenuCssClass nav-scrollable" @onclick="ToggleNavMenu">
    <nav class="flex-column">
        
        @* 1. LEADERBOARD (Home) *@
        <div class="nav-item px-3">
            <NavLink class="nav-link" href="" Match="NavLinkMatch.All">
                <span class="bi bi-trophy-fill me-2" aria-hidden="true"></span> Leaderboard
            </NavLink>
        </div>

        @* 2. SCOREBOARD *@
        <div class="nav-item px-3">
            <NavLink class="nav-link" href="results">
                <span class="bi bi-display me-2" aria-hidden="true"></span> Scoreboard
                @if (IsLive)
                {
                    <span class="badge bg-danger ms-2" style="font-size: 0.7em;">
                        <span class="spinner-grow spinner-grow-sm me-1" role="status" aria-hidden="true" style="width: 5px; height: 5px;"></span>
                        LIVE
                    </span>
                }
            </NavLink>
        </div>



        @* 3. MY PICKS / LOG IN *@
        <AuthorizeView>
            <Authorized>
                <div class="nav-item px-3">
                    <NavLink class="nav-link" href="mypicks">
                        <span class="bi bi-clipboard-check-fill me-2" aria-hidden="true"></span> @MyPicksText
                    </NavLink>
                </div>
            </Authorized>
            <NotAuthorized>
                <div class="nav-item px-3">
                    <NavLink class="nav-link" href="login">
                         <span class="bi bi-box-arrow-in-right me-2" aria-hidden="true"></span> Log In To Enter Picks
                    </NavLink>
                </div>
            </NotAuthorized>
        </AuthorizeView>

        @* 4. PATH TO VICTORY (New Feature) *@
        <div class="nav-item px-3">
            <NavLink class="nav-link" href="what-if">
                <span class="bi bi-signpost-split me-2" aria-hidden="true"></span> Path to Victory
            </NavLink>
        </div>

        @* 5. PRINT BRACKET *@
        <div class="nav-item px-3">
            <NavLink class="nav-link" href="print-bracket">
                <span class="bi bi-printer-fill me-2" aria-hidden="true"></span> Print Bracket
            </NavLink>
        </div>

        @* 6. HISTORY *@
        <div class="nav-item px-3">
            <NavLink class="nav-link" href="archives">
                <span class="bi bi-clock-history me-2" aria-hidden="true"></span> History
            </NavLink>
        </div>
        
        @* ADMIN SECTION *@
        <AuthorizeView Roles="SuperAdmin,Admin">
            <Authorized>
                <div class="nav-item px-3 mt-4">
                    <div class="text-white-50 small text-uppercase fw-bold px-3 mb-1">Admin</div>
                </div>
                <div class="nav-item px-3">
                    <NavLink class="nav-link" href="admin/dashboard">
                        <span class="bi bi-speedometer2 me-2" aria-hidden="true"></span> Dashboard
                    </NavLink>
                </div>
                <div class="nav-item px-3">
                    <NavLink class="nav-link" href="admin/api-manager">
                        <span class="bi bi-cloud-arrow-down-fill me-2" aria-hidden="true"></span> API Integrations
                    </NavLink>
                </div>
            </Authorized>
        </AuthorizeView>
    </nav>
</div>

@code {
    private bool collapseNavMenu = true;
    private string MyPicksText = "My Picks";
    private bool IsLive = false;
    
    private string? NavMenuCssClass => collapseNavMenu ? "collapse" : null;
    private void ToggleNavMenu() => collapseNavMenu = !collapseNavMenu;

    protected override async Task OnInitializedAsync()
    {
        AppState.OnChange += StateHasChangedWrapper;
        await UpdateNavText();
        await CheckLiveStatus();
    }

    private async void StateHasChangedWrapper()
    {
        await UpdateNavText();
        StateHasChanged();
    }

    private async Task UpdateNavText()
    {
        try
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            if (authState.User.Identity?.IsAuthenticated ?? false)
            {
                var myEntries = await Http.GetFromJsonAsync<List<BracketEntry>>("api/GetMyEntries");
                MyPicksText = (myEntries == null || !myEntries.Any()) ? "Enter Your Picks" : "My Picks";
            }
        }
        catch 
        {
            MyPicksText = "My Picks";
        }
    }

    private async Task CheckLiveStatus()
    {
        try
        {
            // Lightweight check to see if any games are active
            var games = await Http.GetFromJsonAsync<List<BowlGame>>("api/GetGames");
            if (games != null && games.Any(g => g.Status == GameStatus.InProgress))
            {
                IsLive = true;
            }
        }
        catch (Exception ex)
        {
            // Silent fail to avoid disrupting nav
            Console.WriteLine($"Live status check failed: {ex.Message}");
        }
    }

    public void Dispose()
    {
        AppState.OnChange -= StateHasChangedWrapper;
    }
}
