@page "/results"
@using BowlPoolManager.Core.Domain
@using BowlPoolManager.Core
@using BowlPoolManager.Client.Helpers
@using BowlPoolManager.Client.Services
@inject HttpClient Http
@inject ISeasonService SeasonService

<PageTitle>Scoreboard</PageTitle>

<div class="container mt-4">
    <div class="text-center mb-5">
        <h1 class="display-4 fw-bold text-primary"><i class="bi bi-display"></i> Scoreboard</h1>
        <p class="lead text-muted mb-1">Scores & Schedules</p>
        
        @if (LastUpdate != DateTime.MinValue)
        {
            <div class="small text-secondary fst-italic">
                Updates automatically &bull; Last update: @DateTimeHelper.ToCentral(LastUpdate).ToString("MMM d, h:mm tt") CT
            </div>
        }
    </div>

    @if (isLoading)
    {
        <div class="d-flex justify-content-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else
    {
        <div class="card shadow-sm mb-4">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover table-striped mb-0 align-middle">
                        <thead class="table-dark">
                            <tr>
                                <th>Date</th>
                                <th>Bowl / Info</th>
                                <th class="text-center">Result</th>
                                <th class="text-center">Status</th> @* NEW COLUMN *@
                                <th class="text-center">Pts</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var game in games.OrderBy(g => g.StartTime))
                            {
                                string homeClass = "";
                                string awayClass = "";
                                
                                if (game.Status == GameStatus.Final)
                                {
                                    if (game.TeamHomeScore > game.TeamAwayScore)
                                    {
                                        homeClass = "text-success fw-bold";
                                        awayClass = "text-danger text-opacity-75";
                                    }
                                    else
                                    {
                                        homeClass = "text-danger text-opacity-75";
                                        awayClass = "text-success fw-bold";
                                    }
                                }
                                else
                                {
                                    homeClass = string.IsNullOrEmpty(game.TeamHome) ? "text-muted fst-italic" : "fw-bold";
                                    awayClass = string.IsNullOrEmpty(game.TeamAway) ? "text-muted fst-italic" : "fw-bold";
                                }

                                <tr>
                                    @* --- DATE --- *@
                                    <td style="width: 15%">
                                        @DateTimeHelper.ToCentral(game.StartTime).ToString("MMM d")
                                        <div class="small text-muted">@DateTimeHelper.ToCentral(game.StartTime).ToString("h:mm tt") CT</div>
                                    </td>

                                    @* --- BOWL INFO (Removed Status Tags) --- *@
                                    <td style="width: 30%">
                                        <strong>@game.BowlName</strong>
                                        
                                        @if (game.IsPlayoff)
                                        {
                                            <span class="badge bg-warning text-dark ms-1">Playoff</span>
                                        }

                                        <div class="small text-muted mt-1">
                                            <i class="bi bi-geo-alt"></i> @game.Location
                                            <span class="mx-1">&bull;</span>
                                            <i class="bi bi-tv"></i> @game.Television
                                        </div>
                                    </td>

                                    @* --- RESULT (SCORES) --- *@
                                    <td class="text-center">
                                        <div class="mx-auto" style="max-width: 260px;">
                                            <div class="@homeClass d-flex justify-content-between">
                                                <span>@(string.IsNullOrEmpty(game.TeamHome) ? "TBD" : game.TeamHome)</span>
                                                @if(game.TeamHomeScore.HasValue)
                                                {
                                                    <span>@game.TeamHomeScore</span>
                                                }
                                            </div>

                                            <div class="@awayClass d-flex justify-content-between mt-1">
                                                <span>@(string.IsNullOrEmpty(game.TeamAway) ? "TBD" : game.TeamAway)</span>
                                                @if(game.TeamAwayScore.HasValue)
                                                {
                                                    <span>@game.TeamAwayScore</span>
                                                }
                                            </div>
                                        </div>
                                    </td>

                                    @* --- STATUS (NEW LOCATION) --- *@
                                    <td class="text-center text-nowrap">
                                        @if (game.Status == GameStatus.Final)
                                        {
                                            <span class="badge bg-danger">Final</span>
                                        }
                                        else if (game.Status == GameStatus.InProgress)
                                        {
                                            <span class="badge bg-success">
                                                <span class="spinner-grow spinner-grow-sm me-1" role="status" aria-hidden="true" style="width: 6px; height: 6px;"></span>
                                                @(string.IsNullOrEmpty(game.GameDetail) ? "In Progress" : game.GameDetail)
                                            </span>
                                        }
                                    </td>

                                    @* --- PTS --- *@
                                    <td class="text-center fw-bold fs-5">
                                        @game.PointValue
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private bool isLoading = true;
    private List<BowlGame> games = new();
    private DateTime LastUpdate = DateTime.MinValue;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // 1. Fetch all games (this endpoint returns ALL games, so we must filter client-side or update API)
            //    For now, we filter client-side as per plan.
            var allGames = await Http.GetFromJsonAsync<List<BowlGame>>("api/GetGames") ?? new();

            // 2. Fetch Seasons to know which is "Current"
            var seasons = await SeasonService.GetSeasonsAsync();
            var currentSeason = seasons.FirstOrDefault(s => s.IsCurrent);

            // 3. Determine the target SeasonId
            //    If no season is marked current in DB, fallback to Constants (or "2025").
            string targetSeasonId = currentSeason?.Id ?? Constants.CurrentSeason;

            // 4. Filter
            games = allGames.Where(g => g.SeasonId == targetSeasonId).ToList();

            try {
                LastUpdate = await Http.GetFromJsonAsync<DateTime>("api/GetLastScoreUpdate");
            } catch { /* Handle gracefully if missing */ }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading games: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }
}
