@page "/"
@using BowlPoolManager.Core.Domain
@using BowlPoolManager.Core
@using BowlPoolManager.Client.Helpers
@inject HttpClient Http

<PageTitle>Leaderboard</PageTitle>

<div class="container-fluid mt-4">
    <div class="text-center mb-5">
        <h1 class="display-4 fw-bold text-primary">Bowl Madness 2025</h1>
        <p class="lead text-muted">Current Standings</p>
    </div>

    @if (isLoading)
    {
        <div class="d-flex justify-content-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else if (leaderboard == null || !leaderboard.Any())
    {
        <div class="alert alert-info text-center">
            No entries found. The season hasn't started yet!
        </div>
    }
    else
    {
        <div class="card shadow-sm border-0">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover table-striped mb-0 align-middle text-center">
                        <thead class="bg-primary text-white">
                            <tr>
                                <th class="ps-4 text-start">Rank</th>
                                <th class="text-start">Player</th>
                                
                                <th class="fw-bold">Total</th>
                                
                                <th class="d-none d-md-table-cell" title="Standard Bowl Games">Bowls</th>
                                <th class="d-none d-md-table-cell" title="Round 1 (First Round)">1st Rnd</th>
                                <th class="d-none d-md-table-cell" title="Quarterfinals">Quart</th>
                                <th class="d-none d-md-table-cell" title="Semifinals">Semis</th>
                                <th class="d-none d-md-table-cell" title="Championship">Champ</th>
                                
                                <th title="Maximum Potential Score" class="text-dark">Max</th>
                                
                                <th class="d-none d-sm-table-cell">Correct</th>
                                <th class="text-end pe-4 d-none d-lg-table-cell">Tiebreaker</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var row in leaderboard)
                            {
                                <tr>
                                    <td class="ps-4 text-start">@row.Rank</td>
                                    <td class="text-start fw-bold">@row.Entry.PlayerName</td>
                                    
                                    <td class="fs-5 text-primary fw-bold">@row.Score</td>
                                    
                                    <td class="d-none d-md-table-cell text-muted">@row.RoundScores[PlayoffRound.Standard]</td>
                                    <td class="d-none d-md-table-cell text-muted">@row.RoundScores[PlayoffRound.Round1]</td>
                                    <td class="d-none d-md-table-cell text-muted">@row.RoundScores[PlayoffRound.QuarterFinal]</td>
                                    <td class="d-none d-md-table-cell text-muted">@row.RoundScores[PlayoffRound.SemiFinal]</td>
                                    <td class="d-none d-md-table-cell text-muted">@row.RoundScores[PlayoffRound.Championship]</td>

                                    <td class="fw-bold text-muted">@row.MaxPossible</td>
                                    
                                    <td class="d-none d-sm-table-cell text-muted small">@row.CorrectPicks / @totalFinalGames</td>
                                    <td class="text-end pe-4 text-muted small d-none d-lg-table-cell">@row.Entry.TieBreakerPoints pts</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div class="mt-3 text-center text-muted small">
            <i class="bi bi-info-circle"></i> Leaderboard updates automatically as game results are entered.
        </div>
    }
    <div class="text-center mt-5 mb-5 pt-4 border-top">
        <a href="print-bracket" target="_blank" class="btn btn-outline-primary">
            <i class="bi bi-file-earmark-pdf"></i> Get Printable Bracket
        </a>
    </div>
</div>

@code {
    private bool isLoading = true;
    private List<BowlGame> games = new();
    private List<BracketEntry> entries = new();
    private List<LeaderboardRow> leaderboard = new();
    private int totalFinalGames = 0;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var gamesTask = Http.GetFromJsonAsync<List<BowlGame>>("api/GetGames");
            var entriesTask = Http.GetFromJsonAsync<List<BracketEntry>>("api/GetEntries");

            await Task.WhenAll(gamesTask, entriesTask);

            games = await gamesTask ?? new();
            entries = await entriesTask ?? new();

            totalFinalGames = games.Count(g => g.Status == GameStatus.Final);
            leaderboard = ScoringEngine.Calculate(games, entries);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading leaderboard: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }
}
