@page "/"
@using BowlPoolManager.Core.Domain
@using BowlPoolManager.Core
@using BowlPoolManager.Client.Helpers
@using BowlPoolManager.Core.Helpers
@inject HttpClient Http

<PageTitle>Leaderboard</PageTitle>

<div class="container-fluid mt-4">
    <div class="text-center mb-5">
        <h1 class="display-4 fw-bold text-primary">Bowl Madness 2025</h1>
        <p class="lead text-muted">
            Current Standings 
            @if (currentPool != null)
            {
                <span class="mx-2">|</span> 
                <span class="text-danger fw-bold fs-6">
                    <i class="bi bi-clock"></i> Picks Lock at @DateTimeHelper.ToCentral(currentPool.LockDate).ToString("MMM d, h:mm tt")
                </span>
            }
        </p>
    </div>

    @if (isLoading)
    {
        <div class="d-flex justify-content-center">
            <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>
        </div>
    }
    else if (leaderboard == null || !leaderboard.Any())
    {
        <div class="alert alert-info text-center">No entries found. The season hasn't started yet!</div>
    }
    else
    {
        <div class="card shadow-sm border-0">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover table-striped mb-0 align-middle text-center">
                        <thead class="bg-primary text-white">
                            <tr>
                                <th class="ps-4 text-start cursor-pointer" @onclick='() => Sort("Rank")'>Rank @RenderSortIcon("Rank")</th>
                                <th class="text-start cursor-pointer" @onclick='() => Sort("Player")'>Player @RenderSortIcon("Player")</th>
                                <th class="fw-bold cursor-pointer" @onclick='() => Sort("Score")'>Total @RenderSortIcon("Score")</th>
                                <th class="d-none d-md-table-cell cursor-pointer" @onclick='() => Sort("Bowls")'>Bowls @RenderSortIcon("Bowls")</th>
                                <th class="d-none d-md-table-cell cursor-pointer" @onclick='() => Sort("Round1")'>1st Rnd @RenderSortIcon("Round1")</th>
                                <th class="d-none d-md-table-cell cursor-pointer" @onclick='() => Sort("QuarterFinal")'>Quart @RenderSortIcon("QuarterFinal")</th>
                                <th class="d-none d-md-table-cell cursor-pointer" @onclick='() => Sort("SemiFinal")'>Semis @RenderSortIcon("SemiFinal")</th>
                                <th class="d-none d-md-table-cell cursor-pointer" @onclick='() => Sort("Championship")'>Champ @RenderSortIcon("Championship")</th>
                                <th title="Maximum Potential Score" class="text-dark cursor-pointer" @onclick='() => Sort("Max")'>Max @RenderSortIcon("Max")</th>
                                <th class="d-none d-sm-table-cell cursor-pointer" @onclick='() => Sort("Correct")'>Correct @RenderSortIcon("Correct")</th>
                                <th class="text-end pe-4 d-none d-lg-table-cell cursor-pointer" @onclick='() => Sort("Tiebreaker")'>Tiebreaker @RenderSortIcon("Tiebreaker")</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var row in leaderboard)
                            {
                                bool isRedacted = row.Entry.Picks == null;
                                <tr>
                                    <td class="ps-4 text-start">@row.Rank</td>
                                    
                                    <td class="text-start fw-bold">
                                        <a href="entry/@row.Entry.Id" class="text-decoration-none text-dark">
                                            @if (isRedacted)
                                            {
                                                <i class="bi bi-lock-fill text-muted me-1" title="Picks Hidden"></i>
                                            }
                                            @row.Entry.PlayerName
                                        </a>
                                    </td>
                                    
                                    <td class="fs-5 text-primary fw-bold">@row.Score</td>
                                    <td class="d-none d-md-table-cell text-muted">@row.RoundScores[PlayoffRound.Standard]</td>
                                    <td class="d-none d-md-table-cell text-muted">@row.RoundScores[PlayoffRound.Round1]</td>
                                    <td class="d-none d-md-table-cell text-muted">@row.RoundScores[PlayoffRound.QuarterFinal]</td>
                                    <td class="d-none d-md-table-cell text-muted">@row.RoundScores[PlayoffRound.SemiFinal]</td>
                                    <td class="d-none d-md-table-cell text-muted">@row.RoundScores[PlayoffRound.Championship]</td>
                                    <td class="fw-bold text-muted">@row.MaxPossible</td>
                                    <td class="d-none d-sm-table-cell text-muted small">@row.CorrectPicks / @totalFinalGames</td>
                                    <td class="text-end pe-4 text-muted small d-none d-lg-table-cell">
                                        @(isRedacted ? "-" : $"{row.Entry.TieBreakerPoints} pts")
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
         </div>
        <div class="mt-3 text-center text-muted small">
             <i class="bi bi-info-circle"></i> Leaderboard updates automatically.
             <i class="bi bi-lock-fill"></i> indicates picks are hidden until the pool unlocks.
        </div>
    }
    <div class="text-center mt-5 mb-5 pt-4 border-top">
        <a href="print-bracket" target="_blank" class="btn btn-outline-primary">
            <i class="bi bi-file-earmark-pdf"></i> Get Printable Bracket
        </a>
    </div>
</div>

<style>
    .cursor-pointer { cursor: pointer; user-select: none; }
    .cursor-pointer:hover { background-color: rgba(255,255,255,0.2); }
</style>

@code {
    private bool isLoading = true;
    private BowlPool? currentPool;
    private List<BowlGame> games = new();
    private List<BracketEntry> entries = new();
    private List<LeaderboardRow> leaderboard = new();
    private int totalFinalGames = 0;
    
    // Sorting
    private string sortColumn = "Score";
    private bool isAscending = false;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // UPDATED: Fetch pools to get lock date
            var poolsTask = Http.GetFromJsonAsync<List<BowlPool>>("api/GetPools");
            var gamesTask = Http.GetFromJsonAsync<List<BowlGame>>("api/GetGames");
            var entriesTask = Http.GetFromJsonAsync<List<BracketEntry>>("api/GetEntries");

            await Task.WhenAll(poolsTask, gamesTask, entriesTask);
            
            var pools = await poolsTask ?? new();
            currentPool = pools.FirstOrDefault();
            
            games = await gamesTask ?? new();
            entries = await entriesTask ?? new();
            
            totalFinalGames = games.Count(g => g.Status == GameStatus.Final);
            
            leaderboard = ScoringEngine.Calculate(games, entries);
            Sort(sortColumn, forceToggle: false);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading leaderboard: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private void Sort(string column, bool forceToggle = true)
    {
        if (forceToggle)
        {
            if (sortColumn == column) isAscending = !isAscending;
            else
            {
                sortColumn = column;
                isAscending = true; 
                if (new[]{"Score","Max","Correct","Bowls","Round1","QuarterFinal","SemiFinal","Championship"}.Contains(column))
                    isAscending = false;
            }
        }

        switch (column)
        {
            case "Rank": leaderboard = isAscending ? leaderboard.OrderBy(r => r.Rank).ToList() : leaderboard.OrderByDescending(r => r.Rank).ToList(); break;
            case "Player": leaderboard = isAscending ? leaderboard.OrderBy(r => r.Entry.PlayerName).ToList() : leaderboard.OrderByDescending(r => r.Entry.PlayerName).ToList(); break;
            case "Score": leaderboard = isAscending ? leaderboard.OrderBy(r => r.Score).ToList() : leaderboard.OrderByDescending(r => r.Score).ToList(); break;
            case "Max": leaderboard = isAscending ? leaderboard.OrderBy(r => r.MaxPossible).ToList() : leaderboard.OrderByDescending(r => r.MaxPossible).ToList(); break;
            case "Correct": leaderboard = isAscending ? leaderboard.OrderBy(r => r.CorrectPicks).ToList() : leaderboard.OrderByDescending(r => r.CorrectPicks).ToList(); break;
            case "Tiebreaker": leaderboard = isAscending ? leaderboard.OrderBy(r => r.Entry.TieBreakerPoints).ToList() : leaderboard.OrderByDescending(r => r.Entry.TieBreakerPoints).ToList(); break;
            case "Bowls": leaderboard = isAscending ? leaderboard.OrderBy(r => r.RoundScores[PlayoffRound.Standard]).ToList() : leaderboard.OrderByDescending(r => r.RoundScores[PlayoffRound.Standard]).ToList(); break;
            case "Round1": leaderboard = isAscending ? leaderboard.OrderBy(r => r.RoundScores[PlayoffRound.Round1]).ToList() : leaderboard.OrderByDescending(r => r.RoundScores[PlayoffRound.Round1]).ToList(); break;
            case "QuarterFinal": leaderboard = isAscending ? leaderboard.OrderBy(r => r.RoundScores[PlayoffRound.QuarterFinal]).ToList() : leaderboard.OrderByDescending(r => r.RoundScores[PlayoffRound.QuarterFinal]).ToList(); break;
            case "SemiFinal": leaderboard = isAscending ? leaderboard.OrderBy(r => r.RoundScores[PlayoffRound.SemiFinal]).ToList() : leaderboard.OrderByDescending(r => r.RoundScores[PlayoffRound.SemiFinal]).ToList(); break;
            case "Championship": leaderboard = isAscending ? leaderboard.OrderBy(r => r.RoundScores[PlayoffRound.Championship]).ToList() : leaderboard.OrderByDescending(r => r.RoundScores[PlayoffRound.Championship]).ToList(); break;
        }
    }

    private RenderFragment RenderSortIcon(string column)
    {
        bool isActive = (sortColumn == column);
        string visibilityStyle = isActive ? "visibility: visible" : "visibility: hidden";
        string iconClass = (isActive && isAscending) ? "bi-caret-up-fill" : "bi-caret-down-fill";
        return @<i class="@($"bi {iconClass} small ms-1")" style="@visibilityStyle"></i>;
    }
}
