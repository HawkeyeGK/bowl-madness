@page "/"
@using BowlPoolManager.Core.Domain
@using BowlPoolManager.Core
@using BowlPoolManager.Client.Helpers
@inject HttpClient Http

<PageTitle>Bowl Madness</PageTitle>

<div class="container text-center mt-5">
    <h1 class="display-3 fw-bold text-primary mb-3">Bowl Madness</h1>
    <p class="lead text-muted mb-5">Welcome to the 2025 Bowl Pool Challenge!</p>

    @if (isLoading)
    {
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading leaderboard...</span>
        </div>
    }
    else
    {
        <div class="mt-5 text-muted small">
            @if (LastUpdate != DateTime.MinValue)
            {
                 <span>Leaderboard updates automatically &bull; Last update: @DateTimeHelper.ToCentral(LastUpdate).ToString("MMM d, h:mm tt") CT</span>
            }
            else
            {
                 <span>Leaderboard updates automatically</span>
            }
        </div>
    }
</div>

@code {
    private bool isLoading = true;
    private DateTime LastUpdate = DateTime.MinValue;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // We call GetGames to ensure the backend refreshes the data for the leaderboard calculation
            // Even if we don't display the games here, this triggers the Lazy Load
            await Http.GetFromJsonAsync<List<BowlGame>>("api/GetGames");
            
            // Get the timestamp
            LastUpdate = await Http.GetFromJsonAsync<DateTime>("api/GetLastScoreUpdate");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }
}
