@page "/"
@page "/leaderboard"
@using BowlPoolManager.Core.Domain
@using BowlPoolManager.Core.Dtos
@using BowlPoolManager.Core
@using BowlPoolManager.Client.Services
@inject ISeasonService SeasonService

@using Microsoft.AspNetCore.Components.Authorization
@inject HttpClient Http
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Nav
@inject IJSRuntime JSRuntime

<PageTitle>Leaderboard</PageTitle>

<div class="container-fluid mt-3 px-4">
    <div class="d-flex justify-content-between align-items-end mb-3">
        @* LEFT SIDE: Title + Pool Selector *@
        <div class="d-flex flex-column gap-2">
            <div class="d-flex align-items-center gap-3">
                <h1 class="h3 fw-bold mb-0"><i class="bi bi-trophy-fill text-primary"></i> Leaderboard</h1>
            </div>

        

        
            <div class="d-flex flex-column flex-md-row align-items-start align-items-md-center gap-1 gap-md-3">
                @* POOL SELECTOR *@
                @if (pools != null && pools.Count > 1)
                {
                    <div class="d-flex align-items-center gap-2">
                        <span class="text-muted small fw-bold">Pool:</span>
                        <select class="form-select form-select-sm shadow-sm" style="width: auto; min-width: 200px;" @onchange="OnPoolChanged">
                            @foreach (var pool in pools)
                            {
                                <option value="@pool.Id" selected="@(pool.Id == currentPool?.Id)">@pool.Name</option>
                            }
                        </select>
                    </div>
                }
                else if (currentPool != null)
                {
                    <h2 class="h5 text-secondary mb-0">@currentPool.Name</h2>
                }

                @* LOCK DATE INFO *@
                @if (currentPool != null)
                {
                    <div class="text-muted small">
                        @if (DateTime.UtcNow > currentPool.LockDate)
                        {
                            <span>Picks Locked: @DateTimeHelper.ToCentral(currentPool.LockDate).ToString("MMM d, h:mm tt") CT</span>
                        }
                        else
                        {
                            <i class="bi bi-clock-fill text-danger me-1"></i>
                            <span>Picks Lock: @DateTimeHelper.ToCentral(currentPool.LockDate).ToString("MMM d, h:mm tt") CT</span>
                        }
                    </div>
                }
                else
                {
                    <span class="text-muted small">Loading Pool...</span>
                }
            </div>
        </div>

        @* RIGHT SIDE: Actions *@
        <div>
             <a href="print-bracket" class="btn btn-outline-primary btn-sm">
                <i class="bi bi-printer-fill"></i> Print Bracket
            </a>
        </div>
    </div>

    @if (isLoading)
    {
        <div class="d-flex justify-content-center">
            <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>
        </div>
    }
    else if (leaderboard == null || !leaderboard.Any())
    {
        <div class="alert alert-info text-center">
            No entries found for <strong>@(currentPool?.Name ?? "this pool")</strong>.
        </div>
    }
    else
    {
        <div class="card shadow-sm border-0">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover table-striped mb-0 align-middle text-center">
                        <thead class="bg-primary text-white">
                            <tr>
                                <th class="ps-4 text-start cursor-pointer" @onclick='() => Sort("Rank")'><div class="d-flex flex-column align-items-start"><span>Rank</span>@RenderSortIcon("Rank", invertLogic: true)</div></th>
                                <th class="cursor-pointer" @onclick='() => Sort("Player")'><div class="d-flex flex-column align-items-center"><span>Player</span>@RenderSortIcon("Player")</div></th>
                                <th class="fw-bold cursor-pointer" @onclick='() => Sort("Score")'><div class="d-flex flex-column align-items-center"><span>Total</span>@RenderSortIcon("Score")</div></th>
                                <th class="d-none d-md-table-cell cursor-pointer" @onclick='() => Sort("Bowls")'><div class="d-flex flex-column align-items-center"><span>Bowls</span>@RenderSortIcon("Bowls")</div></th>
                                <th class="d-none d-md-table-cell cursor-pointer" @onclick='() => Sort("Round1")'><div class="d-flex flex-column align-items-center"><span>1st Rnd</span>@RenderSortIcon("Round1")</div></th>
                                <th class="d-none d-md-table-cell cursor-pointer" @onclick='() => Sort("QuarterFinal")'><div class="d-flex flex-column align-items-center"><span>Quart</span>@RenderSortIcon("QuarterFinal")</div></th>
                                <th class="d-none d-md-table-cell cursor-pointer" @onclick='() => Sort("SemiFinal")'><div class="d-flex flex-column align-items-center"><span>Semis</span>@RenderSortIcon("SemiFinal")</div></th>
                                <th class="d-none d-md-table-cell cursor-pointer" @onclick='() => Sort("Championship")'><div class="d-flex flex-column align-items-center"><span>Champ</span>@RenderSortIcon("Championship")</div></th>
                                <th title="Maximum Potential Score" class="text-dark cursor-pointer" @onclick='() => Sort("Max")'><div class="d-flex flex-column align-items-center"><span>Max</span>@RenderSortIcon("Max")</div></th>
                                <th class="d-none d-sm-table-cell cursor-pointer" @onclick='() => Sort("Correct")'><div class="d-flex flex-column align-items-center"><span>Correct</span>@RenderSortIcon("Correct")</div></th>
                                <th class="d-none d-lg-table-cell cursor-pointer" @onclick='() => Sort("Tiebreaker")'><div class="d-flex flex-column align-items-center"><span>Tiebreaker</span>@RenderSortIcon("Tiebreaker")</div></th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var row in leaderboard)
                            {
                                bool isLocked = currentPool != null && DateTime.UtcNow < currentPool.LockDate;
                                <tr>
                                    <td class="ps-4 text-start">@row.Rank</td>
                                    <td class="fw-bold">
                                        @if (isLocked)
                                        {
                                            <span class="text-secondary" title="Picks Hidden until @currentPool!.LockDate">
                                                <i class="bi bi-lock-fill text-muted me-1"></i>
                                                @row.PlayerName
                                            </span>
                                        }
                                        else
                                        {
                                            <a href="entry/@row.Id" class="text-decoration-none text-dark">
                                                @row.PlayerName
                                                @if (isPoolFinal)
                                                {
                                                    @if (row.Rank == 1)
                                                    {
                                                        <i class="bi bi-trophy-fill ms-2" style="color: #FFD700;" title="1st Place - Gold"></i>
                                                    }
                                                    else if (row.Rank == 2)
                                                    {
                                                        <i class="bi bi-trophy-fill ms-2" style="color: #C0C0C0;" title="2nd Place - Silver"></i>
                                                    }
                                                    else if (row.Rank == 3)
                                                    {
                                                        <i class="bi bi-trophy-fill ms-2" style="color: #CD7F32;" title="3rd Place - Bronze"></i>
                                                    }
                                                }
                                            </a>
                                        }
                                    </td>
                                    <td class="fs-5 text-primary fw-bold">@row.Score</td>
                                    <td class="d-none d-md-table-cell text-muted">@row.RoundScores[PlayoffRound.Standard]</td>
                                    <td class="d-none d-md-table-cell text-muted">@row.RoundScores[PlayoffRound.Round1]</td>
                                    <td class="d-none d-md-table-cell text-muted">@row.RoundScores[PlayoffRound.QuarterFinal]</td>
                                    <td class="d-none d-md-table-cell text-muted">@row.RoundScores[PlayoffRound.SemiFinal]</td>
                                    <td class="d-none d-md-table-cell text-muted">@row.RoundScores[PlayoffRound.Championship]</td>
                                    <td class="fw-bold text-muted">@row.MaxPossible</td>
                                    <td class="d-none d-sm-table-cell text-muted small">@row.CorrectPicks / @totalFinalGames</td>
                                    <td class="text-muted small d-none d-lg-table-cell">
                                        @if (isLocked)
                                        {
                                            <span title="Hidden until picks lock" class="text-secondary opacity-50">
                                                <i class="bi bi-eye-slash"></i>
                                            </span>
                                        }
                                        else
                                        {
                                            @($"{row.TieBreakerPoints} pts")
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
         </div>
        <div class="mt-3 text-center text-muted small">
             @if (LastUpdate != DateTime.MinValue)
             {
                 <span><i class="bi bi-info-circle"></i> Leaderboard updates automatically &bull; Last update: @DateTimeHelper.ToCentral(LastUpdate).ToString("MMM d, h:mm tt") CT</span>
             }
             else
             {
                 <span><i class="bi bi-info-circle"></i> Leaderboard updates automatically</span>
             }
             <div class="mt-1"><i class="bi bi-lock-fill"></i> indicates picks are hidden until the pool unlocks.</div>
        </div>
    }

</div>

<style>
    .cursor-pointer { cursor: pointer; user-select: none; }
    .cursor-pointer:hover { background-color: rgba(255,255,255,0.2); }
</style>

@code {
    private bool isLoading = true;
    private List<BowlPool> pools = new();
    private BowlPool? currentPool;
    private List<LeaderboardDto> leaderboard = new();
    private int totalFinalGames = 0;
    private int totalGames = 0;
    private bool isPoolFinal = false;
    private DateTime LastUpdate = DateTime.MinValue;
    private string currentSeasonId = "";
    
    // Sorting
    private string sortColumn = "Score";
    private bool isAscending = false;

    [SupplyParameterFromQuery(Name = "poolId")]
    public string? QueryPoolId { get; set; }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            isLoading = true;
            
            // 0. Fetch Current Season
            var currentSeason = await SeasonService.GetCurrentSeasonAsync();
            currentSeasonId = currentSeason?.Id ?? "";

            var poolsTask = Http.GetFromJsonAsync<List<BowlPool>>($"api/GetPools?seasonId={currentSeasonId}");
            var myEntriesTask = FetchMyEntriesSafe();
            
            await Task.WhenAll(poolsTask, myEntriesTask);
            var allPools = await poolsTask ?? new();
            
            var myEntries = await myEntriesTask;

            // Fetch the last update timestamp
            try {
                LastUpdate = await Http.GetFromJsonAsync<DateTime>("api/GetLastScoreUpdate");
            } catch { /* Ignore if fails */ }

            // 0. CHECK FOR DIRECT LINK TO ARCHIVED POOL
            if (!string.IsNullOrEmpty(QueryPoolId))
            {
                var requestedPool = allPools.FirstOrDefault(p => p.Id == QueryPoolId);
                if (requestedPool != null && requestedPool.IsArchived)
                {
                    Nav.NavigateTo($"/history/{requestedPool.Id}");
                    return;
                }
            }

            // 1. FILTER UI LIST (Only show active pools)
            pools = allPools.Where(p => !p.IsArchived).ToList();

            // 2. DETERMINE CURRENT POOL
            if (!string.IsNullOrEmpty(QueryPoolId))
            {
                currentPool = pools.FirstOrDefault(p => p.Id == QueryPoolId);
            }
            else
            {
                // Try from local storage
                try
                {
                    var savedPoolId = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "lastSelectedPoolId");
                    if (!string.IsNullOrEmpty(savedPoolId))
                    {
                        currentPool = pools.FirstOrDefault(p => p.Id == savedPoolId);
                    }
                }
                catch { /* Ignore JS interop errors during prerendering or if disallowed */ }

                // If not found in storage, try "My Entries"
                if (currentPool == null && myEntries.Any())
                {
                    var lastEntry = myEntries.OrderByDescending(e => e.CreatedOn).First();
                    // Only select if it matches an ACTIVE pool
                    currentPool = pools.FirstOrDefault(p => p.Id == lastEntry.PoolId);
                }
            }
            
            // 3. FALLBACK
            if (currentPool == null)
            {
                currentPool = pools.FirstOrDefault();
            }

            if (currentPool != null)
            {
                await LoadLeaderboardForPool(currentPool.Id);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading leaderboard: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task<List<BracketEntry>> FetchMyEntriesSafe()
    {
        try 
        {
            var auth = await AuthStateProvider.GetAuthenticationStateAsync();
            if (auth.User.Identity?.IsAuthenticated == true)
            {
                return await Http.GetFromJsonAsync<List<BracketEntry>>($"api/GetMyEntries?seasonId={currentSeasonId}") ?? new();
            }
        }
        catch { /* Ignore auth errors on public page */ }
        return new();
    }

    private async Task OnPoolChanged(ChangeEventArgs e)
    {
        var poolId = e.Value?.ToString();
        if (string.IsNullOrEmpty(poolId)) return;

        currentPool = pools.FirstOrDefault(p => p.Id == poolId);
        if (currentPool != null)
        {
            isLoading = true;
            await JSRuntime.InvokeVoidAsync("localStorage.setItem", "lastSelectedPoolId", currentPool.Id);
            await LoadLeaderboardForPool(currentPool.Id);
            isLoading = false;
        }
    }

    private async Task LoadLeaderboardForPool(string poolId)
    {
        try
        {
            // Call the new server-side GetLeaderboard API
            var response = await Http.GetFromJsonAsync<LeaderboardResponse>(
                $"api/GetLeaderboard?poolId={poolId}&seasonId={currentSeasonId}"
            );
            
            if (response != null)
            {
                leaderboard = response.Leaderboard ?? new();
                totalFinalGames = response.TotalFinalGames;
                totalGames = leaderboard.Count > 0 ? leaderboard.Count : 0;
                
                // Determine if pool is final (all games complete)
                // We can infer this from the data: if any entry has maxPossible == score for top player
                // Or we need additional metadata - for now, estimate from the pool
                isPoolFinal = totalFinalGames > 0 && leaderboard.All(r => r.MaxPossible == r.Score);
            }
            else
            {
                leaderboard = new();
                totalFinalGames = 0;
            }
            
            Sort(sortColumn, forceToggle: false);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error fetching leaderboard: {ex.Message}");
        }
    }
    
    // Response model for the GetLeaderboard API
    private class LeaderboardResponse
    {
        public int TotalFinalGames { get; set; }
        public List<LeaderboardDto>? Leaderboard { get; set; }
    }

    private void Sort(string column, bool forceToggle = true)
    {
        if (forceToggle)
        {
            if (sortColumn == column) isAscending = !isAscending;
            else
            {
                sortColumn = column;
                isAscending = true; 
                if (new[]{"Score","Max","Correct","Bowls","Round1","QuarterFinal","SemiFinal","Championship"}.Contains(column))
                    isAscending = false;
            }
        }

        switch (column)
        {
            case "Rank": leaderboard = isAscending ? leaderboard.OrderBy(r => r.Rank).ToList() : leaderboard.OrderByDescending(r => r.Rank).ToList(); break;
            case "Player": leaderboard = isAscending ? leaderboard.OrderBy(r => r.PlayerName).ToList() : leaderboard.OrderByDescending(r => r.PlayerName).ToList(); break;
            case "Score": leaderboard = isAscending ? leaderboard.OrderBy(r => r.Score).ToList() : leaderboard.OrderByDescending(r => r.Score).ToList(); break;
            case "Max": leaderboard = isAscending ? leaderboard.OrderBy(r => r.MaxPossible).ToList() : leaderboard.OrderByDescending(r => r.MaxPossible).ToList(); break;
            case "Correct": leaderboard = isAscending ? leaderboard.OrderBy(r => r.CorrectPicks).ToList() : leaderboard.OrderByDescending(r => r.CorrectPicks).ToList(); break;
            case "Tiebreaker": leaderboard = isAscending ? leaderboard.OrderBy(r => r.TieBreakerPoints).ToList() : leaderboard.OrderByDescending(r => r.TieBreakerPoints).ToList(); break;
            case "Bowls": leaderboard = isAscending ? leaderboard.OrderBy(r => r.RoundScores[PlayoffRound.Standard]).ToList() : leaderboard.OrderByDescending(r => r.RoundScores[PlayoffRound.Standard]).ToList(); break;
            case "Round1": leaderboard = isAscending ? leaderboard.OrderBy(r => r.RoundScores[PlayoffRound.Round1]).ToList() : leaderboard.OrderByDescending(r => r.RoundScores[PlayoffRound.Round1]).ToList(); break;
            case "QuarterFinal": leaderboard = isAscending ? leaderboard.OrderBy(r => r.RoundScores[PlayoffRound.QuarterFinal]).ToList() : leaderboard.OrderByDescending(r => r.RoundScores[PlayoffRound.QuarterFinal]).ToList(); break;
            case "SemiFinal": leaderboard = isAscending ? leaderboard.OrderBy(r => r.RoundScores[PlayoffRound.SemiFinal]).ToList() : leaderboard.OrderByDescending(r => r.RoundScores[PlayoffRound.SemiFinal]).ToList(); break;
            case "Championship": leaderboard = isAscending ? leaderboard.OrderBy(r => r.RoundScores[PlayoffRound.Championship]).ToList() : leaderboard.OrderByDescending(r => r.RoundScores[PlayoffRound.Championship]).ToList(); break;
        }
    }

    private RenderFragment RenderSortIcon(string column, bool invertLogic = false)
    {
        bool isActive = (sortColumn == column);
        string visibilityStyle = isActive ? "visibility: visible" : "visibility: hidden";
        bool effectiveAscending = invertLogic ? !isAscending : isAscending;
        string iconClass = (isActive && effectiveAscending) ? "bi-caret-up-fill" : "bi-caret-down-fill";
        return @<i class="@($"bi {iconClass} small")" style="@visibilityStyle"></i>;
    }
}
