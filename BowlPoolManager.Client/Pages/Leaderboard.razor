@page "/"
@page "/leaderboard"
@using BowlPoolManager.Core.Domain
@using BowlPoolManager.Core
@using BowlPoolManager.Client.Helpers
@using BowlPoolManager.Core.Helpers
@using Microsoft.AspNetCore.Components.Authorization
@inject HttpClient Http
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Nav
@inject IJSRuntime JSRuntime

<PageTitle>Leaderboard</PageTitle>

<div class="container-fluid mt-4">
    <div class="text-center mb-5">
        <h1 class="display-4 fw-bold text-primary">
            <i class="bi bi-trophy-fill"></i> Leaderboard
        </h1>
        

        
        @if (pools != null && pools.Count > 1)
        {
            <div class="d-flex justify-content-center align-items-center mb-2">
                <select class="form-select w-auto fw-bold text-center border-primary" @onchange="OnPoolChanged">
                    @foreach (var pool in pools)
                    {
                        <option value="@pool.Id" selected="@(pool.Id == currentPool?.Id)">@pool.Name</option>
                    }
                </select>
            </div>
        }
        else if (currentPool != null)
        {
            <h2 class="h4 text-secondary">@currentPool.Name</h2>
        }

        <p class="lead text-muted">
            @if (currentPool != null)
            {
                <span class="text-danger fw-bold fs-6">
                    <i class="bi bi-clock"></i> 
                    Picks Lock at @DateTimeHelper.ToCentral(currentPool.LockDate).ToString("MMM d, h:mm tt") CT
                </span>
            }
            else
            {
                <span>Loading Pool...</span>
            }
        </p>
    </div>

    @if (isLoading)
    {
        <div class="d-flex justify-content-center">
            <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>
        </div>
    }
    else if (leaderboard == null || !leaderboard.Any())
    {
        <div class="alert alert-info text-center">
            No entries found for <strong>@(currentPool?.Name ?? "this pool")</strong>.
        </div>
    }
    else
    {
        <div class="card shadow-sm border-0">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover table-striped mb-0 align-middle text-center">
                        <thead class="bg-primary text-white">
                            <tr>
                                <th class="ps-4 text-start cursor-pointer" @onclick='() => Sort("Rank")'><div class="d-flex flex-column align-items-start"><span>Rank</span>@RenderSortIcon("Rank", invertLogic: true)</div></th>
                                <th class="cursor-pointer" @onclick='() => Sort("Player")'><div class="d-flex flex-column align-items-center"><span>Player</span>@RenderSortIcon("Player")</div></th>
                                <th class="fw-bold cursor-pointer" @onclick='() => Sort("Score")'><div class="d-flex flex-column align-items-center"><span>Total</span>@RenderSortIcon("Score")</div></th>
                                <th class="d-none d-md-table-cell cursor-pointer" @onclick='() => Sort("Bowls")'><div class="d-flex flex-column align-items-center"><span>Bowls</span>@RenderSortIcon("Bowls")</div></th>
                                <th class="d-none d-md-table-cell cursor-pointer" @onclick='() => Sort("Round1")'><div class="d-flex flex-column align-items-center"><span>1st Rnd</span>@RenderSortIcon("Round1")</div></th>
                                <th class="d-none d-md-table-cell cursor-pointer" @onclick='() => Sort("QuarterFinal")'><div class="d-flex flex-column align-items-center"><span>Quart</span>@RenderSortIcon("QuarterFinal")</div></th>
                                <th class="d-none d-md-table-cell cursor-pointer" @onclick='() => Sort("SemiFinal")'><div class="d-flex flex-column align-items-center"><span>Semis</span>@RenderSortIcon("SemiFinal")</div></th>
                                <th class="d-none d-md-table-cell cursor-pointer" @onclick='() => Sort("Championship")'><div class="d-flex flex-column align-items-center"><span>Champ</span>@RenderSortIcon("Championship")</div></th>
                                <th title="Maximum Potential Score" class="text-dark cursor-pointer" @onclick='() => Sort("Max")'><div class="d-flex flex-column align-items-center"><span>Max</span>@RenderSortIcon("Max")</div></th>
                                <th class="d-none d-sm-table-cell cursor-pointer" @onclick='() => Sort("Correct")'><div class="d-flex flex-column align-items-center"><span>Correct</span>@RenderSortIcon("Correct")</div></th>
                                <th class="d-none d-lg-table-cell cursor-pointer" @onclick='() => Sort("Tiebreaker")'><div class="d-flex flex-column align-items-center"><span>Tiebreaker</span>@RenderSortIcon("Tiebreaker")</div></th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var row in leaderboard)
                            {
                                bool isRedacted = row.Entry.Picks == null;
                                <tr>
                                    <td class="ps-4 text-start">@row.Rank</td>
                                    <td class="fw-bold">
                                        @if (currentPool != null && DateTime.UtcNow < currentPool.LockDate)
                                        {
                                            <span class="text-secondary" title="Picks Hidden until @currentPool.LockDate">
                                                <i class="bi bi-lock-fill text-muted me-1"></i>
                                                @row.Entry.PlayerName
                                            </span>
                                        }
                                        else
                                        {
                                            <a href="entry/@row.Entry.Id" class="text-decoration-none text-dark">
                                                @if (isRedacted)
                                                {
                                                    <i class="bi bi-lock-fill text-muted me-1" title="Picks Hidden"></i>
                                                }
                                                @row.Entry.PlayerName
                                            </a>
                                        }
                                    </td>
                                    <td class="fs-5 text-primary fw-bold">@row.Score</td>
                                    <td class="d-none d-md-table-cell text-muted">@row.RoundScores[PlayoffRound.Standard]</td>
                                    <td class="d-none d-md-table-cell text-muted">@row.RoundScores[PlayoffRound.Round1]</td>
                                    <td class="d-none d-md-table-cell text-muted">@row.RoundScores[PlayoffRound.QuarterFinal]</td>
                                    <td class="d-none d-md-table-cell text-muted">@row.RoundScores[PlayoffRound.SemiFinal]</td>
                                    <td class="d-none d-md-table-cell text-muted">@row.RoundScores[PlayoffRound.Championship]</td>
                                    <td class="fw-bold text-muted">@row.MaxPossible</td>
                                    <td class="d-none d-sm-table-cell text-muted small">@row.CorrectPicks / @totalFinalGames</td>
                                    <td class="text-muted small d-none d-lg-table-cell">
                                        @if (currentPool != null && DateTime.UtcNow < currentPool.LockDate)
                                        {
                                            <span title="Hidden until picks lock" class="text-secondary opacity-50">
                                                <i class="bi bi-eye-slash"></i>
                                            </span>
                                        }
                                        else if (isRedacted)
                                        {
                                            <span>-</span>
                                        }
                                        else
                                        {
                                            @($"{row.Entry.TieBreakerPoints} pts")
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
         </div>
        <div class="mt-3 text-center text-muted small">
             @if (LastUpdate != DateTime.MinValue)
             {
                 <span><i class="bi bi-info-circle"></i> Leaderboard updates automatically &bull; Last update: @DateTimeHelper.ToCentral(LastUpdate).ToString("MMM d, h:mm tt") CT</span>
             }
             else
             {
                 <span><i class="bi bi-info-circle"></i> Leaderboard updates automatically</span>
             }
             <div class="mt-1"><i class="bi bi-lock-fill"></i> indicates picks are hidden until the pool unlocks.</div>
        </div>
    }
    <div class="text-center mt-5 mb-5 pt-4 border-top">
        <a href="print-bracket" class="btn btn-outline-primary">
            <i class="bi bi-printer-fill"></i> Print Bracket
        </a>
    </div>
</div>

<style>
    .cursor-pointer { cursor: pointer; user-select: none; }
    .cursor-pointer:hover { background-color: rgba(255,255,255,0.2); }
</style>

@code {
    private bool isLoading = true;
    private List<BowlPool> pools = new();
    private BowlPool? currentPool;
    private List<BowlGame> allSeasonGames = new();
    private List<BowlGame> games = new();
    private List<BracketEntry> entries = new();
    private List<LeaderboardRow> leaderboard = new();
    private int totalFinalGames = 0;
    private DateTime LastUpdate = DateTime.MinValue;
    
    // Sorting
    private string sortColumn = "Score";
    private bool isAscending = false;

    [SupplyParameterFromQuery(Name = "poolId")]
    public string? QueryPoolId { get; set; }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            isLoading = true;
            var poolsTask = Http.GetFromJsonAsync<List<BowlPool>>("api/GetPools");
            // Fetching games triggers the lazy update
            var gamesTask = Http.GetFromJsonAsync<List<BowlGame>>("api/GetGames");
            var myEntriesTask = FetchMyEntriesSafe();
            
            await Task.WhenAll(poolsTask, gamesTask, myEntriesTask);
            var allPools = await poolsTask ?? new();
            allSeasonGames = await gamesTask ?? new();
            // Initial Filtering will happen in LoadEntriesForPool
            
            var myEntries = await myEntriesTask;
            // totalFinalGames will be calculated after filtering

            // Fetch the last update timestamp
            try {
                LastUpdate = await Http.GetFromJsonAsync<DateTime>("api/GetLastScoreUpdate");
            } catch { /* Ignore if fails */ }

            // 0. CHECK FOR DIRECT LINK TO ARCHIVED POOL
            if (!string.IsNullOrEmpty(QueryPoolId))
            {
                var requestedPool = allPools.FirstOrDefault(p => p.Id == QueryPoolId);
                if (requestedPool != null && requestedPool.IsArchived)
                {
                    Nav.NavigateTo($"/history/{requestedPool.Id}");
                    return;
                }
            }

            // 1. FILTER UI LIST (Only show active pools)
            pools = allPools.Where(p => !p.IsArchived).ToList();

            // 2. DETERMINE CURRENT POOL
            if (!string.IsNullOrEmpty(QueryPoolId))
            {
                currentPool = pools.FirstOrDefault(p => p.Id == QueryPoolId);
            }
            else
            {
                // Try from local storage
                try
                {
                    var savedPoolId = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "lastSelectedPoolId");
                    if (!string.IsNullOrEmpty(savedPoolId))
                    {
                        currentPool = pools.FirstOrDefault(p => p.Id == savedPoolId);
                    }
                }
                catch { /* Ignore JS interop errors during prerendering or if disallowed */ }

                // If not found in storage, try "My Entries"
                if (currentPool == null && myEntries.Any())
                {
                    var lastEntry = myEntries.OrderByDescending(e => e.CreatedOn).First();
                    // Only select if it matches an ACTIVE pool
                    currentPool = pools.FirstOrDefault(p => p.Id == lastEntry.PoolId);
                }
            }
            
            // 3. FALLBACK
            if (currentPool == null)
            {
                currentPool = pools.FirstOrDefault();
            }

            if (currentPool != null)
            {
                await LoadEntriesForPool(currentPool.Id);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading leaderboard: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task<List<BracketEntry>> FetchMyEntriesSafe()
    {
        try 
        {
            var auth = await AuthStateProvider.GetAuthenticationStateAsync();
            if (auth.User.Identity?.IsAuthenticated == true)
            {
                return await Http.GetFromJsonAsync<List<BracketEntry>>("api/GetMyEntries") ?? new();
            }
        }
        catch { /* Ignore auth errors on public page */ }
        return new();
    }

    private async Task OnPoolChanged(ChangeEventArgs e)
    {
        var poolId = e.Value?.ToString();
        if (string.IsNullOrEmpty(poolId)) return;

        currentPool = pools.FirstOrDefault(p => p.Id == poolId);
        if (currentPool != null)
        {
            isLoading = true;
            await JSRuntime.InvokeVoidAsync("localStorage.setItem", "lastSelectedPoolId", currentPool.Id);
            await LoadEntriesForPool(currentPool.Id);
            isLoading = false;
        }
    }

    private async Task LoadEntriesForPool(string poolId)
    {
        try
        {
            entries = await Http.GetFromJsonAsync<List<BracketEntry>>($"api/GetEntries?poolId={poolId}") ?? new();
            
            // FILTER GAMES FOR THIS POOL
            if (currentPool != null && currentPool.GameIds != null && currentPool.GameIds.Any())
            {
               games = allSeasonGames.Where(g => currentPool.GameIds.Contains(g.Id)).ToList();
            }
            else
            {
               games = allSeasonGames.ToList();
            }
            
            totalFinalGames = games.Count(g => g.Status == GameStatus.Final);
            
            leaderboard = ScoringEngine.Calculate(games, entries);
            Sort(sortColumn, forceToggle: false);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error fetching entries: {ex.Message}");
        }
    }

    private void Sort(string column, bool forceToggle = true)
    {
        if (forceToggle)
        {
            if (sortColumn == column) isAscending = !isAscending;
            else
            {
                sortColumn = column;
                isAscending = true; 
                if (new[]{"Score","Max","Correct","Bowls","Round1","QuarterFinal","SemiFinal","Championship"}.Contains(column))
                    isAscending = false;
            }
        }

        switch (column)
        {
            case "Rank": leaderboard = isAscending ? leaderboard.OrderBy(r => r.Rank).ToList() : leaderboard.OrderByDescending(r => r.Rank).ToList(); break;
            case "Player": leaderboard = isAscending ? leaderboard.OrderBy(r => r.Entry.PlayerName).ToList() : leaderboard.OrderByDescending(r => r.Entry.PlayerName).ToList(); break;
            case "Score": leaderboard = isAscending ? leaderboard.OrderBy(r => r.Score).ToList() : leaderboard.OrderByDescending(r => r.Score).ToList(); break;
            case "Max": leaderboard = isAscending ? leaderboard.OrderBy(r => r.MaxPossible).ToList() : leaderboard.OrderByDescending(r => r.MaxPossible).ToList(); break;
            case "Correct": leaderboard = isAscending ? leaderboard.OrderBy(r => r.CorrectPicks).ToList() : leaderboard.OrderByDescending(r => r.CorrectPicks).ToList(); break;
            case "Tiebreaker": leaderboard = isAscending ? leaderboard.OrderBy(r => r.Entry.TieBreakerPoints).ToList() : leaderboard.OrderByDescending(r => r.Entry.TieBreakerPoints).ToList(); break;
            case "Bowls": leaderboard = isAscending ? leaderboard.OrderBy(r => r.RoundScores[PlayoffRound.Standard]).ToList() : leaderboard.OrderByDescending(r => r.RoundScores[PlayoffRound.Standard]).ToList(); break;
            case "Round1": leaderboard = isAscending ? leaderboard.OrderBy(r => r.RoundScores[PlayoffRound.Round1]).ToList() : leaderboard.OrderByDescending(r => r.RoundScores[PlayoffRound.Round1]).ToList(); break;
            case "QuarterFinal": leaderboard = isAscending ? leaderboard.OrderBy(r => r.RoundScores[PlayoffRound.QuarterFinal]).ToList() : leaderboard.OrderByDescending(r => r.RoundScores[PlayoffRound.QuarterFinal]).ToList(); break;
            case "SemiFinal": leaderboard = isAscending ? leaderboard.OrderBy(r => r.RoundScores[PlayoffRound.SemiFinal]).ToList() : leaderboard.OrderByDescending(r => r.RoundScores[PlayoffRound.SemiFinal]).ToList(); break;
            case "Championship": leaderboard = isAscending ? leaderboard.OrderBy(r => r.RoundScores[PlayoffRound.Championship]).ToList() : leaderboard.OrderByDescending(r => r.RoundScores[PlayoffRound.Championship]).ToList(); break;
        }
    }

    private RenderFragment RenderSortIcon(string column, bool invertLogic = false)
    {
        bool isActive = (sortColumn == column);
        string visibilityStyle = isActive ? "visibility: visible" : "visibility: hidden";
        bool effectiveAscending = invertLogic ? !isAscending : isAscending;
        string iconClass = (isActive && effectiveAscending) ? "bi-caret-up-fill" : "bi-caret-down-fill";
        return @<i class="@($"bi {iconClass} small")" style="@visibilityStyle"></i>;
    }
}
