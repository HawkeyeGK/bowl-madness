@page "/what-if"
@using BowlPoolManager.Core.Domain
@using BowlPoolManager.Core
@using BowlPoolManager.Core.Helpers
@using BowlPoolManager.Client.Services

@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.JSInterop
@inject ISeasonService SeasonService
@inject HttpClient Http
@inject IJSRuntime JSRuntime
@inject AuthenticationStateProvider AuthStateProvider

<PageTitle>Path to Victory</PageTitle>

@using BowlPoolManager.Client.Components
@using BowlPoolManager.Client.Helpers

<style>
    /* 1. SCROLL CONTAINER */
    .matrix-container {
        display: block;
        width: 100%;
        max-width: 100%;
        height: calc(100vh - 190px); 
        overflow: auto; 
        border: 1px solid #dee2e6;
        background-color: white;
        position: relative;
        -webkit-overflow-scrolling: touch;
    }

    /* 2. TABLE BASE */
    .matrix-table {
        border-collapse: separate; 
        border-spacing: 0;
        table-layout: fixed; /* Force fixed layout */
        width: auto; /* Let it grow manually based on columns */
        margin-bottom: 0;
    }

    /* 3. COLUMNS */
    .matrix-table th, 
    .matrix-table td {
        vertical-align: middle;
        text-align: center;
        width: 70px;      /* FIXED WIDTH */
        min-width: 70px;
        max-width: 70px;
        padding: 4px;
        overflow: hidden;
    }

    /* 4. STICKY HEADERS (Top Row) */
    .matrix-table th {
        position: sticky;
        top: 0;
        z-index: 20; 
        background-color: #f8f9fa;
        border-bottom: 2px solid #dee2e6;
        padding: 0.5rem;
        box-shadow: 0 2px 2px -1px rgba(0, 0, 0, 0.1);
        white-space: normal; /* ALLOW WRAP */
        height: auto;
        font-size: 0.75rem;
        line-height: 1.1;
    }

    /* 5. STICKY FIRST COLUMN (Left Column) */
    .matrix-table td.sticky-col, .matrix-table th.sticky-col-header  {
        position: sticky;
        left: 0;
        z-index: 10; 
        background-color: #fff !important; 
        border-right: 2px solid #dee2e6;
        font-weight: 500;
        width: 180px;      /* FIXED WIDTH FOR NAMES */
        min-width: 180px;
        max-width: 180px;
        text-align: left; /* Align names left */
        box-shadow: 2px 0 2px -1px rgba(0, 0, 0, 0.1);
    }
    .matrix-table th.sticky-col-header {
        z-index: 30; /* Corner overlap */
        background-color: #e9ecef !important;
        text-align: center;
    }

    /* 7. ROW HOVER */
    .matrix-table tr:hover td { background-color: #f1f3f5; }
    .matrix-table tr:hover td.sticky-col { background-color: #e9ecef !important; }

    /* Sim Controls */
    .sim-control-btn {
        cursor: pointer;
        padding: 2px;
        border-radius: 4px;
        border: 1px solid #ced4da;
        margin: 2px auto;
        display: flex;
        justify-content: center;
        align-items: center;
        width: 100%;
        height: 28px;
        background-color: white;
    }
    .sim-control-btn:hover { filter: brightness(0.95); background-color: #e9ecef; }
    .sim-control-btn.active-win {
        background-color: #d1e7dd; 
        border-color: #198754;
        box-shadow: inset 0 0 0 1px #198754;
    }
    .sim-control-btn.active-loss {
        opacity: 0.4;
        background-color: #f8d7da;
    }
    
    /* Colors */
    .cell-win { background-color: #d1e7dd !important; color: #0f5132; }
    .cell-loss { background-color: #f8d7da !important; color: #842029; opacity: 0.6; }

    .team-logo-sm { width: 18px; height: 18px; object-fit: contain; margin-right: 2px; }
    .team-abbrev { font-size: 0.75rem; font-weight: bold; }

    @@media print {
        @@page { size: landscape; margin: 0.5cm; }
        
        /* Hide Navigation & Layout */
        .sidebar, .top-row, .navbar, header, footer { display: none !important; }
        
        /* Layout Resets */
        .container-fluid {
            width: 100% !important;
            max-width: none !important;
            padding: 0 !important;
            margin: 0 !important;
        }

        /* Matrix Container: Remove scroll & constraints */
        .matrix-container {
            height: auto !important;
            overflow: visible !important;
            border: none !important;
            width: 100% !important;
            max-width: none !important;
            display: block !important;
        }

        /* Table: Allow full width & wrapping */
        .matrix-table {
            width: 100% !important;
            table-layout: auto !important;
        }

        /* Cells & Headers: Reduce size & remove stickiness */
        .matrix-table th, 
        .matrix-table td {
            position: static !important; /* Remove sticky */
            font-size: 8pt !important;   /* Reduce text size */
            padding: 1px !important;     /* Tighter padding */
            width: auto !important;      /* Allow automatic sizing */
            min-width: 0 !important;
            max-width: none !important; /* Uncap width */
            border: 1px solid #000 !important; /* High contrast borders */
        }
        
        /* Remove specific sticky styles */
        .sticky-col, .sticky-col-header {
            position: static !important;
            border: 1px solid #000 !important;
            box-shadow: none !important;
        }

        /* Visual Tweaks for Print */
        .team-logo-sm { width: 12px !important; height: 12px !important; margin-right: 1px !important; }
        .team-abbrev { font-size: 7pt !important; }
        .badge { border: none !important; padding: 0 !important; font-size: 7pt !important; }
        
        /* Force background colors */
        .cell-win, .cell-loss, .active-win, .active-loss {
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }
    }
</style>

<div class="container-fluid mt-3 px-4">
    <div class="d-flex justify-content-between align-items-end mb-3 d-print-none">
        
        @* LEFT SIDE: Title + Pool Selector *@
        <div class="d-flex flex-column gap-2">
            <div class="d-flex align-items-center gap-3">
                <h1 class="h3 fw-bold mb-0"><i class="bi bi-signpost-split-fill text-primary"></i> Path to Victory</h1>
            </div>

            @* POOL SELECTOR *@
            @if(poolList.Count > 1)
            {
                <div class="d-flex align-items-center gap-2">
                    <span class="text-muted small fw-bold">Pool:</span>
                    <select class="form-select form-select-sm shadow-sm" style="width: auto; min-width: 200px;" @onchange="OnPoolChanged">
                        @foreach(var pool in poolList)
                        {
                            <option value="@pool.Id" selected="@(pool.Id == selectedPoolId)">@pool.Name</option>
                        }
                    </select>
                </div>
            }
        </div>

        @* RIGHT SIDE: Actions *@
        <div class="d-flex gap-2">
             @if (HasActiveSimulation && !isPrintView)
             {
                <button class="btn btn-outline-danger btn-sm" @onclick="ResetSimulation">
                    <i class="bi bi-arrow-counterclockwise"></i> Reset to Reality
                </button>
             }
             
             <button class="btn btn-sm @(isPrintView ? "btn-secondary" : "btn-outline-secondary") d-print-none" 
                     @onclick="() => isPrintView = !isPrintView">
                 <i class="bi @(isPrintView ? "bi-table" : "bi-printer")"></i> 
                 @(isPrintView ? "Exit Print View" : "Printer Friendly View")
             </button>
        </div>
    </div>
    
    @if (isPrintView)
    {
        <div class="d-print-none alert alert-info py-2 mb-3">
            <i class="bi bi-info-circle-fill me-2"></i>
            <strong>Printer Friendly Mode Active:</strong> The table has been split into smaller chunks to fit on standard paper. Use <code>Ctrl+P</code> to print.
        </div>
    }

    @if (isLoading)
    {
        <div class="d-flex justify-content-center py-5">
            <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>
        </div>
    }
    else if (!poolList.Any())
    {
        <div class="text-center py-5">
            <i class="bi bi-hourglass-split display-1 text-secondary opacity-50"></i>
            <h2 class="mt-3 text-secondary">Awaiting Kickoff</h2>
            <p class="lead text-muted">Path to Victory unlocks when the first pool of the season opens.</p>
        </div>
    }
    else if (isPrintView)
    {
        @* PRINT VIEW: Split Table *@
        <div class="print-container">
            @foreach (var chunk in GetGameChunks())
            {
                <div class="mb-4 break-after-page">
                    <table class="table table-bordered table-sm matrix-table custom-print-table">
                        <thead>
                            <tr>
                                <th style="width: 150px;">Player</th>
                                @foreach (var game in chunk)
                                {
                                    <th class="text-center">
                                        <div class="small fw-bold text-truncate" style="max-width: 60px;">@game.BowlName</div>
                                        <div class="badge bg-light text-secondary border">@game.PointValue</div>
                                        <div class="d-block mt-1" style="font-size: 0.65rem;">
                                            @if(_simState.EffectiveWinners.TryGetValue(game.Id, out var w) && w != null)
                                            {
                                                <span class="badge bg-success text-white">@GetTeamAbbrev(w)</span>
                                            }
                                            else
                                            {
                                                <span>-</span>
                                            }
                                        </div>
                                    </th>
                                }
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var row in projectedStandings)
                            {
                                <tr>
                                    <td class="fw-bold">
                                        <div class="d-flex justify-content-between">
                                            <span class="text-truncate" style="max-width: 110px;">@row.Entry.PlayerName</span>
                                            <span class="badge bg-primary rounded-pill">@row.Score</span>
                                        </div>
                                    </td>
                                    @foreach (var game in chunk)
                                    {
                                        var pick = row.Entry.Picks != null && row.Entry.Picks.ContainsKey(game.Id) ? row.Entry.Picks[game.Id] : "";
                                        <td class="text-center @GetCellClass(game, pick)">
                                            @if (!string.IsNullOrEmpty(pick))
                                            {
                                                <span class="fw-bold" style="font-size: 0.7rem;">@GetTeamAbbrev(pick)</span>
                                            }
                                        </td>
                                    }
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    }
    else
    {
        <div class="matrix-container shadow-sm">
            <table class="table mb-0 matrix-table table-bordered">
                <thead>
                    <tr>
                        <th class="sticky-col-header">
                            <div class="d-flex justify-content-between text-muted small px-1">
                                <span>Player</span>
                                <span>Proj.</span>
                            </div>
                        </th>
                        @foreach (var game in games)
                        {
                            <th>
                                <div class="fw-bold mb-1 text-truncate" title="@game.BowlName">
                                    @game.BowlName
                                </div>
                                <div class="badge bg-light text-secondary border mb-1" style="font-size: 0.65rem;">@game.PointValue</div>
                                
                                @{
                                    var options = GetSelectableTeams(game);
                                }
                                
                                @if(options.Count <= 2) 
                                {
                                    <div class="d-flex flex-column gap-1">
                                        @foreach(var teamName in options)
                                        {
                                            var logo = GetTeamLogo(teamName);
                                            var abbr = GetTeamAbbrev(teamName);
                                            <div class="sim-control-btn @GetSimClass(game.Id, teamName, options)" 
                                                 title="@teamName"
                                                 @onclick="() => ToggleSimWinner(game.Id, teamName)">
                                                @if(!string.IsNullOrEmpty(logo))
                                                {
                                                    <img src="@logo" class="team-logo-sm" />
                                                }
                                                <span class="team-abbrev">@abbr</span>
                                            </div>
                                        }
                                    </div>
                                }
                                else
                                {
                                    <select class="form-select form-select-sm p-1" style="font-size: 0.65rem;" 
                                            value="@(_simState.EffectiveWinners.TryGetValue(game.Id, out var selected) && selected != null ? selected : "")"
                                            @onchange="@(e => SetSimWinner(game.Id, e.Value?.ToString()))">
                                        <option value="">?</option>
                                        @foreach(var teamName in options)
                                        {
                                            <option value="@teamName">@GetTeamAbbrev(teamName)</option>
                                        }
                                    </select>
                                }
                            </th>
                        }
                    </tr>
                </thead>
                <tbody>
                    @foreach (var row in projectedStandings)
                    {
                        <tr>
                            <td class="sticky-col">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="text-truncate" style="max-width: 160px;" title="@row.Entry.PlayerName">
                                        <span class="text-muted small me-1">@row.Rank.</span>
                                        @row.Entry.PlayerName
                                    </span>
                                    <span class="badge bg-primary rounded-pill">@row.Score</span>
                                </div>
                            </td>

                            @foreach (var game in games)
                            {
                                var pick = row.Entry.Picks != null && row.Entry.Picks.ContainsKey(game.Id) ? row.Entry.Picks[game.Id] : "";
                                <td class="@GetCellClass(game, pick)">
                                    @if (!string.IsNullOrEmpty(pick))
                                    {
                                        var logo = GetTeamLogo(pick);
                                        var abbr = GetTeamAbbrev(pick);
                                        <div class="d-flex align-items-center justify-content-center" title="@pick">
                                            @if(!string.IsNullOrEmpty(logo))
                                            {
                                                <img src="@logo" class="team-logo-sm" />
                                            }
                                            <span class="team-abbrev">@abbr</span>
                                        </div>
                                    }
                                    else
                                    {
                                        <span class="text-muted small">-</span>
                                    }
                                </td>
                            }
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>

@code {
    private bool isLoading = true;
    private List<BowlGame> games = new();
    private List<BowlGame> allGames = new();
    
    // Raw Data
    private List<BracketEntry> allEntries = new();
    private List<BowlPool> poolList = new();
    
    // Filtered State
    private string selectedPoolId = "";
    private List<BracketEntry> filteredEntries = new();
    
    // Print View State
    private bool isPrintView = false;
    private const int PRINT_CHUNK_SIZE = 15;

    private IEnumerable<List<BowlGame>> GetGameChunks()
    {
        return games
            .Select((x, i) => new { Index = i, Value = x })
            .GroupBy(x => x.Index / PRINT_CHUNK_SIZE)
            .Select(x => x.Select(v => v.Value).ToList());
    }
    
    // ========== NEW SIMULATION STATE DESIGN ==========
    
    // User's explicit simulation choices (only what user has clicked)
    private Dictionary<string, string> _userSimulations = new();
    
    // Pre-computed simulation state (recomputed on any change)
    private class SimulationState
    {
        // For each game: which teams can compete (based on upstream outcomes)
        public Dictionary<string, HashSet<string>> ValidEntrants { get; } = new();
        
        // For each game: the effective winner (null if undecided)
        public Dictionary<string, string?> EffectiveWinners { get; } = new();
    }
    private SimulationState _simState = new();
    
    // Leaderboard projection
    private List<LeaderboardRow> projectedStandings = new();
    
    // Cache for efficient Team Info Lookup
    private Dictionary<string, TeamInfo> teamLookup = new(StringComparer.OrdinalIgnoreCase);

    // Game lookup by ID for fast access
    private Dictionary<string, BowlGame> _gameById = new();
    
    // Feeder map: Key = TargetGameId, Value = List of feeder game IDs
    private Dictionary<string, List<string>> _feederGameIds = new();

    [SupplyParameterFromQuery(Name = "poolId")]
    public string? QueryPoolId { get; set; }
    
    private string currentSeasonId = "";

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // 0. Fetch Current Season
            var currentSeason = await SeasonService.GetCurrentSeasonAsync();
            currentSeasonId = currentSeason?.Id ?? "";

            var gamesTask = Http.GetFromJsonAsync<List<BowlGame>>($"api/GetGames?seasonId={currentSeasonId}");
            var entriesTask = Http.GetFromJsonAsync<List<BracketEntry>>($"api/GetEntries?seasonId={currentSeasonId}");
            var poolsTask = Http.GetFromJsonAsync<List<BowlPool>>($"api/GetPools?seasonId={currentSeasonId}");
            var myEntriesTask = FetchMyEntriesSafe();

            await Task.WhenAll(gamesTask, entriesTask, poolsTask, myEntriesTask);

            allGames = (await gamesTask ?? new()).OrderBy(g => g.StartTime).ToList();
            games = allGames.ToList();
            allEntries = await entriesTask ?? new();
            var allPools = await poolsTask ?? new();
            var myEntries = await myEntriesTask;

            // 1. Filter Pools (Active Season Only AND Open)
            poolList = allPools.Where(p => !p.IsArchived && DateTime.UtcNow >= p.LockDate).ToList();

            // 2. Build lookup structures
            _gameById = allGames.ToDictionary(g => g.Id);
            
            foreach (var g in allGames)
            {
                if (!string.IsNullOrEmpty(g.NextGameId))
                {
                    if (!_feederGameIds.ContainsKey(g.NextGameId))
                        _feederGameIds[g.NextGameId] = new List<string>();
                    _feederGameIds[g.NextGameId].Add(g.Id);
                }
                
                // Populate team lookup
                if (!string.IsNullOrEmpty(g.TeamHome) && g.HomeTeamInfo != null) 
                    teamLookup[g.TeamHome] = g.HomeTeamInfo;
                if (!string.IsNullOrEmpty(g.TeamAway) && g.AwayTeamInfo != null) 
                    teamLookup[g.TeamAway] = g.AwayTeamInfo;
            }

            // 3. Initialize user simulations with reality (Final game winners)
            foreach (var game in allGames.Where(g => g.Status == GameStatus.Final))
            {
                var winner = GetRealWinner(game);
                if (!string.IsNullOrEmpty(winner))
                {
                    _userSimulations[game.Id] = winner;
                }
            }

            // 4. Determine Current Pool (Smart Default Logic)
            BowlPool? targetPool = null;

            if (!string.IsNullOrEmpty(QueryPoolId))
                targetPool = poolList.FirstOrDefault(p => p.Id == QueryPoolId);

            if (targetPool == null)
            {
                try
                {
                    var savedPoolId = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "lastSelectedPoolId");
                    if (!string.IsNullOrEmpty(savedPoolId))
                        targetPool = poolList.FirstOrDefault(p => p.Id == savedPoolId);
                }
                catch { }
            }

            if (targetPool == null && myEntries.Any())
            {
                var lastEntry = myEntries.OrderByDescending(e => e.CreatedOn).FirstOrDefault();
                if (lastEntry != null)
                    targetPool = poolList.FirstOrDefault(p => p.Id == lastEntry.PoolId);
            }

            if (targetPool == null && poolList.Any())
                targetPool = poolList.First();

            selectedPoolId = targetPool?.Id ?? "";
            
            UpdateFilteredEntries();
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex.Message);
        }
        finally { isLoading = false; }
    }

    private async Task<List<BracketEntry>> FetchMyEntriesSafe()
    {
        try 
        {
            var auth = await AuthStateProvider.GetAuthenticationStateAsync();
            if (auth.User.Identity?.IsAuthenticated == true)
            {
                return await Http.GetFromJsonAsync<List<BracketEntry>>($"api/GetMyEntries?seasonId={currentSeasonId}") ?? new();
            }
        }
        catch { }
        return new();
    }

    // --- FILTERING LOGIC ---
    
    private async Task OnPoolChanged(ChangeEventArgs e)
    {
        selectedPoolId = e.Value?.ToString() ?? "";
        if (!string.IsNullOrEmpty(selectedPoolId))
        {
            await JSRuntime.InvokeVoidAsync("localStorage.setItem", "lastSelectedPoolId", selectedPoolId);
        }
        UpdateFilteredEntries();
    }

    private void UpdateFilteredEntries()
    {
        if (string.IsNullOrEmpty(selectedPoolId))
        {
            filteredEntries = new();
            games = allGames.ToList();
        }
        else
        {
            filteredEntries = allEntries.Where(e => e.PoolId == selectedPoolId).ToList();
            
            var pool = poolList.FirstOrDefault(p => p.Id == selectedPoolId);
            if (pool != null && pool.GameIds != null && pool.GameIds.Any())
            {
                games = allGames.Where(g => pool.GameIds.Contains(g.Id)).OrderBy(g => g.StartTime).ToList();
            }
            else
            {
                games = allGames.ToList();
            }
        }
        RecomputeSimulationState();
    }

    // ========== CORE SIMULATION LOGIC ==========

    /// <summary>
    /// Recomputes the entire simulation state based on current user selections.
    /// Processes games in topological order (feeders before downstream).
    /// </summary>
    private void RecomputeSimulationState()
    {
        _simState = new SimulationState();
        
        // Process games in chronological order (which respects the bracket structure)
        // Earlier games are feeders, later games are downstream
        foreach (var game in games.OrderBy(g => g.StartTime))
        {
            ComputeGameState(game);
        }
        
        // Recalculate leaderboard projections
        projectedStandings = WhatIfScoringEngine.Calculate(games, filteredEntries, _simState.EffectiveWinners
            .Where(kv => kv.Value != null)
            .ToDictionary(kv => kv.Key, kv => kv.Value!));
        
        StateHasChanged();
    }

    private void ComputeGameState(BowlGame game)
    {
        var entrants = new HashSet<string>(StringComparer.OrdinalIgnoreCase);
        
        // 1. Add teams from feeder games (use their effective winners)
        if (_feederGameIds.TryGetValue(game.Id, out var feederIds))
        {
            foreach (var feederId in feederIds)
            {
                // Get the effective winner of the feeder game
                if (_simState.EffectiveWinners.TryGetValue(feederId, out var feederWinner) && feederWinner != null)
                {
                    entrants.Add(feederWinner);
                }
                else
                {
                    // Feeder game is undecided - add all its entrants as potential
                    if (_simState.ValidEntrants.TryGetValue(feederId, out var feederEntrants))
                    {
                        foreach (var e in feederEntrants) entrants.Add(e);
                    }
                }
            }
        }
        
        // 2. Add fixed teams (teams that don't come from feeders)
        var hasFeederForHome = HasFeederProvidingTeam(game, game.TeamHome);
        var hasFeederForAway = HasFeederProvidingTeam(game, game.TeamAway);
        
        if (!IsStrictTBD(game.TeamHome) && !hasFeederForHome)
            entrants.Add(game.TeamHome);
        if (!IsStrictTBD(game.TeamAway) && !hasFeederForAway)
            entrants.Add(game.TeamAway);
        
        _simState.ValidEntrants[game.Id] = entrants;
        
        // 3. Determine effective winner
        string? effectiveWinner = null;
        
        // Priority 1: User's explicit simulation (if still valid)
        if (_userSimulations.TryGetValue(game.Id, out var userChoice))
        {
            if (entrants.Contains(userChoice))
            {
                effectiveWinner = userChoice;
            }
            // else: user's choice is no longer valid, treat as undecided
        }
        
        // Priority 2: Reality (for Final games, if real winner is still valid)
        if (effectiveWinner == null && game.Status == GameStatus.Final)
        {
            var realWinner = GetRealWinner(game);
            if (!string.IsNullOrEmpty(realWinner) && entrants.Contains(realWinner))
            {
                effectiveWinner = realWinner;
            }
        }
        
        _simState.EffectiveWinners[game.Id] = effectiveWinner;
    }

    private bool HasFeederProvidingTeam(BowlGame game, string? teamName)
    {
        if (string.IsNullOrEmpty(teamName) || !_feederGameIds.TryGetValue(game.Id, out var feederIds))
            return false;
        
        foreach (var feederId in feederIds)
        {
            if (_simState.ValidEntrants.TryGetValue(feederId, out var feederEntrants))
            {
                if (feederEntrants.Contains(teamName))
                    return true;
            }
        }
        return false;
    }

    private bool IsStrictTBD(string? name)
    {
        return string.IsNullOrEmpty(name) || name.Equals("TBD", StringComparison.OrdinalIgnoreCase);
    }

    // --- INTERACTION ---

    private void ToggleSimWinner(string gameId, string team)
    {
        if (_userSimulations.TryGetValue(gameId, out var current) && current == team)
        {
            _userSimulations.Remove(gameId);
        }
        else
        {
            _userSimulations[gameId] = team;
        }

        // Clear downstream user choices (they depend on this game's outcome)
        ClearDownstreamChoices(gameId);
        
        RecomputeSimulationState();
    }

    private void SetSimWinner(string gameId, string? team)
    {
        if (string.IsNullOrEmpty(team))
            _userSimulations.Remove(gameId);
        else
            _userSimulations[gameId] = team;
            
        ClearDownstreamChoices(gameId);
        RecomputeSimulationState();
    }

    private void ClearDownstreamChoices(string gameId)
    {
        if (!_gameById.TryGetValue(gameId, out var game) || string.IsNullOrEmpty(game.NextGameId))
            return;
        
        _userSimulations.Remove(game.NextGameId);
        ClearDownstreamChoices(game.NextGameId);
    }

    private void ResetSimulation()
    {
        _userSimulations.Clear();
        
        // Restore reality for Final games
        foreach (var game in games.Where(g => g.Status == GameStatus.Final))
        {
            var w = GetRealWinner(game);
            if (!string.IsNullOrEmpty(w)) 
                _userSimulations[game.Id] = w;
        }
        
        RecomputeSimulationState();
    }

    // --- SIMPLE STYLING HELPERS (read from pre-computed state) ---

    private bool HasActiveSimulation
    {
        get
        {
            foreach (var kvp in _userSimulations)
            {
                if (!_gameById.TryGetValue(kvp.Key, out var game)) continue;
                
                // If we predicted a future game, that's active
                if (game.Status != GameStatus.Final) return true;
                
                // If we changed history, that's active
                if (GetRealWinner(game) != kvp.Value) return true;
            }
            return false;
        }
    }

    private List<string> GetSelectableTeams(BowlGame game)
    {
        if (_simState.ValidEntrants.TryGetValue(game.Id, out var entrants))
            return entrants.OrderBy(t => t).ToList();
        return new List<string>();
    }

    private string GetSimClass(string gameId, string team, List<string> validOptions)
    {
        if (_simState.EffectiveWinners.TryGetValue(gameId, out var winner) && winner != null)
        {
            if (validOptions.Contains(winner, StringComparer.OrdinalIgnoreCase))
            {
                return string.Equals(winner, team, StringComparison.OrdinalIgnoreCase) ? "active-win" : "active-loss";
            }
        }
        return "bg-white";
    }

    private string GetRealWinner(BowlGame game)
    {
        if (game.Status != GameStatus.Final) return "";
        int h = game.TeamHomeScore ?? 0;
        int a = game.TeamAwayScore ?? 0;
        if (h > a) return game.TeamHome;
        if (a > h) return game.TeamAway;
        return "";
    }

    private string GetCellClass(BowlGame game, string pick)
    {
        if (string.IsNullOrEmpty(pick)) return "";
        
        // Check if the picked team is a valid entrant for this game
        if (!_simState.ValidEntrants.TryGetValue(game.Id, out var entrants) || 
            !entrants.Contains(pick))
        {
            return "cell-loss"; // Eliminated upstream
        }
        
        // Check if there's an effective winner
        if (_simState.EffectiveWinners.TryGetValue(game.Id, out var winner) && winner != null)
        {
            return string.Equals(pick, winner, StringComparison.OrdinalIgnoreCase) ? "cell-win" : "cell-loss";
        }
        
        // Undecided and pick is valid
        return "";
    }
    
    private string GetTeamLogo(string teamName)
    {
        if (string.IsNullOrEmpty(teamName)) return "";
        return teamLookup.TryGetValue(teamName, out var info) ? info.PrimaryLogoUrl : "";
    }

    private string GetTeamAbbrev(string teamName)
    {
        if (string.IsNullOrEmpty(teamName)) return "";
        if (teamLookup.TryGetValue(teamName, out var info) && !string.IsNullOrEmpty(info.Abbreviation)) 
            return info.Abbreviation;
        if (teamName.Length > 4 && !teamName.Contains(" ")) 
            return teamName.Substring(0, 3).ToUpper();
        return teamName;
    }
}
