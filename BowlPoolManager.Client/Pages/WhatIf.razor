@page "/what-if"
@using BowlPoolManager.Core.Domain
@using BowlPoolManager.Core
@using BowlPoolManager.Core.Helpers
@using BowlPoolManager.Client.Helpers
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Roles = Constants.Roles.SuperAdmin)]
@inject HttpClient Http

<PageTitle>Scenario Matrix</PageTitle>

<style>
    /* 1. SCROLL CONTAINER */
    .matrix-container {
        display: block;
        width: 100%;
        max-width: 100%; /* Critical: Ensures it respects the parent width */
        height: calc(100vh - 190px); 
        overflow: auto; /* Handles BOTH x and y scrolling */
        
        border: 1px solid #dee2e6;
        background-color: white;
        
        /* Smooth scrolling context */
        position: relative; 
        -webkit-overflow-scrolling: touch;
    }

    /* 2. TABLE BASE */
    .matrix-table {
        border-collapse: separate; 
        border-spacing: 0;
        min-width: 100%;
        margin-bottom: 0;
    }

    /* 3. PREVENT WRAPPING */
    .matrix-table th, 
    .matrix-table td {
        white-space: nowrap;
        vertical-align: middle;
    }

    /* 4. STICKY HEADERS (Top Row) */
    .matrix-table th {
        position: sticky;
        top: 0;
        z-index: 20; 
        background-color: #f8f9fa;
        border-bottom: 2px solid #dee2e6;
        padding: 0.5rem;
        text-align: center;
        box-shadow: 0 2px 2px -1px rgba(0, 0, 0, 0.1);
    }

    /* 5. STICKY FIRST COLUMN (Left Column) */
    .matrix-table td.sticky-col {
        position: sticky;
        left: 0;
        z-index: 10; 
        
        /* Solid background prevents bleed-through */
        background-color: #fff !important; 
        border-right: 2px solid #dee2e6;
        font-weight: 500;
        min-width: 200px; /* Slightly narrower than before for better mobile fit */
        box-shadow: 2px 0 2px -1px rgba(0, 0, 0, 0.1);
    }

    /* 6. CORNER CELL (Top-Left Intersection) */
    .matrix-table th.corner-header {
        position: sticky;
        left: 0;
        top: 0;
        z-index: 30; 
        background-color: #e9ecef !important;
        border-right: 2px solid #dee2e6;
        min-width: 200px;
    }

    /* 7. ROW HOVER */
    .matrix-table tr:hover td { 
        background-color: #f1f3f5; 
    }
    .matrix-table tr:hover td.sticky-col { 
        background-color: #e9ecef !important; 
    }

    /* Sim Controls */
    .sim-control {
        cursor: pointer;
        font-size: 0.75rem;
        padding: 4px 8px;
        border-radius: 4px;
        border: 1px solid #ced4da;
        margin: 2px;
        display: block;
        width: 100%;
        text-align: center;
    }
    .sim-control:hover { filter: brightness(0.95); }
    .sim-control.active-win {
        background-color: #198754; 
        color: white;
        border-color: #198754;
    }
    .sim-control.active-loss {
        opacity: 0.4;
        text-decoration: line-through;
    }
    
    /* Colors */
    .cell-win { background-color: #d1e7dd !important; color: #0f5132; }
    .cell-loss { background-color: #f8d7da !important; color: #842029; }
</style>

<div class="container-fluid mt-3 px-4">
    <div class="d-flex justify-content-between align-items-end mb-3">
        
        @* LEFT SIDE: Title + Pool Selector *@
        <div class="d-flex flex-column gap-2">
            <div class="d-flex align-items-center gap-3">
                <h1 class="h3 fw-bold mb-0"><i class="bi bi-grid-3x3-gap-fill text-primary"></i> Scenario Matrix</h1>
                <span class="badge bg-danger">Admin Preview</span>
            </div>

            @* POOL SELECTOR *@
            @if(poolList.Count > 1)
            {
                <div class="d-flex align-items-center gap-2">
                    <span class="text-muted small fw-bold">Pool:</span>
                    <select class="form-select form-select-sm shadow-sm" style="width: auto; min-width: 200px;" @onchange="OnPoolChanged">
                        @foreach(var pool in poolList)
                        {
                            <option value="@pool.Id" selected="@(pool.Id == selectedPoolId)">@pool.Name</option>
                        }
                    </select>
                </div>
            }
        </div>

        @* RIGHT SIDE: Actions *@
        <div>
             @if (simulatedWinners.Any())
             {
                <button class="btn btn-outline-danger btn-sm" @onclick="ResetSimulation">
                    <i class="bi bi-arrow-counterclockwise"></i> Reset Scenarios
                </button>
             }
        </div>
    </div>

    @if (isLoading)
    {
        <div class="d-flex justify-content-center py-5">
            <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>
        </div>
    }
    else
    {
        <div class="matrix-container shadow-sm">
            <table class="table mb-0 matrix-table table-bordered">
                <thead>
                    <tr>
                        <th class="corner-header">
                            <div class="d-flex justify-content-between text-muted small">
                                <span>Player</span>
                                <span>Proj. Score</span>
                            </div>
                        </th>
                        @foreach (var game in games)
                        {
                            <th>
                                <div class="small fw-bold mb-1" style="font-size: 0.7rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="@game.BowlName">
                                    @game.BowlName
                                </div>
                                <div class="badge bg-light text-secondary border mb-2">@game.PointValue pts</div>
                                
                                @if (game.Status == GameStatus.Final)
                                {
                                    @* FINAL: Static Badge *@
                                    <div class="d-flex flex-column gap-1">
                                        <span class="badge @(GetRealWinner(game) == game.TeamHome ? "bg-success" : "bg-secondary bg-opacity-25 text-dark")">
                                            @game.TeamHome
                                        </span>
                                        <span class="badge @(GetRealWinner(game) == game.TeamAway ? "bg-success" : "bg-secondary bg-opacity-25 text-dark")">
                                            @game.TeamAway
                                        </span>
                                    </div>
                                }
                                else
                                {
                                    @* FUTURE: Controls *@
                                    var options = GetSelectableTeams(game);
                                    
                                    @if(options.Count <= 2) 
                                    {
                                        @* Simple Toggle for Head-to-Head *@
                                        <div class="d-flex flex-column gap-1">
                                            @foreach(var team in options)
                                            {
                                                <div class="sim-control @GetSimClass(game.Id, team)" 
                                                     @onclick="() => ToggleSimWinner(game.Id, team)">
                                                    @team
                                                </div>
                                            }
                                        </div>
                                    }
                                    else
                                    {
                                        @* Dropdown for Playoffs/Many Options *@
                                        <select class="form-select form-select-sm" style="font-size: 0.75rem;" 
                                                value="@(simulatedWinners.ContainsKey(game.Id) ? simulatedWinners[game.Id] : "")"
                                                @onchange="@(e => SetSimWinner(game.Id, e.Value?.ToString()))">
                                            <option value="">-- Select Winner --</option>
                                            @foreach(var team in options)
                                            {
                                                <option value="@team">@team</option>
                                            }
                                        </select>
                                    }
                                }
                            </th>
                        }
                    </tr>
                </thead>
                <tbody>
                    @foreach (var row in projectedStandings)
                    {
                        <tr>
                            <td class="sticky-col">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="text-truncate" style="max-width: 160px;" title="@row.Entry.PlayerName">
                                        <span class="text-muted small me-1">@row.Rank.</span>
                                        @row.Entry.PlayerName
                                    </span>
                                    <span class="badge bg-primary rounded-pill">@row.Score</span>
                                </div>
                            </td>

                            @foreach (var game in games)
                            {
                                var pick = row.Entry.Picks != null && row.Entry.Picks.ContainsKey(game.Id) ? row.Entry.Picks[game.Id] : "";
                                <td class="text-center @GetCellClass(game, pick)">
                                    @if (!string.IsNullOrEmpty(pick))
                                    {
                                        <span style="font-size: 0.85rem;">@pick</span>
                                    }
                                    else
                                    {
                                        <span class="text-muted">-</span>
                                    }
                                </td>
                            }
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>

@code {
    private bool isLoading = true;
    private List<BowlGame> games = new();
    
    // Raw Data
    private List<BracketEntry> allEntries = new();
    private List<BowlPool> poolList = new();
    
    // Filtered State
    private string selectedPoolId = "";
    private List<BracketEntry> filteredEntries = new();
    
    // Simulation State
    private Dictionary<string, string> simulatedWinners = new();
    private List<LeaderboardRow> projectedStandings = new();

    // Smart Bracket Map: Key = TargetGameId, Value = List of Games that feed into it
    private ILookup<string, BowlGame>? _feederMap;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var gamesTask = Http.GetFromJsonAsync<List<BowlGame>>("api/GetGames");
            var entriesTask = Http.GetFromJsonAsync<List<BracketEntry>>("api/GetEntries");
            var poolsTask = Http.GetFromJsonAsync<List<BowlPool>>("api/GetPools");

            await Task.WhenAll(gamesTask, entriesTask, poolsTask);

            games = (await gamesTask ?? new()).OrderBy(g => g.StartTime).ToList();
            allEntries = await entriesTask ?? new();
            poolList = await poolsTask ?? new();

            // Build the Bracket Tree (Reverse Lookup)
            // matches any game where NextGameId is not null
            _feederMap = games
                .Where(g => !string.IsNullOrEmpty(g.NextGameId))
                .ToLookup(g => g.NextGameId!);

            // Default to the first pool if available
            if (poolList.Any())
            {
                selectedPoolId = poolList.First().Id;
            }
            
            UpdateFilteredEntries();
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex.Message);
        }
        finally { isLoading = false; }
    }

    // --- FILTERING LOGIC ---
    
    private void OnPoolChanged(ChangeEventArgs e)
    {
        selectedPoolId = e.Value?.ToString() ?? "";
        UpdateFilteredEntries();
    }

    private void UpdateFilteredEntries()
    {
        if (string.IsNullOrEmpty(selectedPoolId))
        {
            filteredEntries = new();
        }
        else
        {
            filteredEntries = allEntries.Where(e => e.PoolId == selectedPoolId).ToList();
        }
        Recalculate();
    }

    // --- SMART BRACKET LOGIC ---

    /// <summary>
    /// Returns the valid teams for a specific game slot based on the current simulation state.
    /// </summary>
    /// <summary>
    /// Returns the valid teams for a specific game slot based on the current simulation state.
    /// </summary>
    private List<string> GetSelectableTeams(BowlGame game)
    {
        // FIX: Use GetEntrantsForGame (Inputs) instead of GetPotentialWinnersForGame (Outputs).
        // This ensures that even if I pick a winner, the UI still shows me all the options 
        // so I can toggle my decision easily.
        var entrants = GetEntrantsForGame(game);
        return entrants.OrderBy(t => t).ToList();
    }

    /// <summary>
    /// Recursive function to find who could win a specific game.
    /// </summary>
    private IEnumerable<string> GetPotentialWinnersForGame(BowlGame game)
    {
        // 1. If Real Life says it's over, that's the only option.
        if (game.Status == GameStatus.Final)
        {
            var realWinner = GetRealWinner(game);
            return string.IsNullOrEmpty(realWinner) ? Enumerable.Empty<string>() : new[] { realWinner };
        }

        // 2. If User has Simulated a winner, that team "advances" (is the output of this node).
        if (simulatedWinners.TryGetValue(game.Id, out var simPick))
        {
            return new[] { simPick };
        }

        // 3. If Undecided, the potential winners are the ENTRANTS of this game.
        // (i.e., anyone playing in this game could win it).
        return GetEntrantsForGame(game);
    }

    /// <summary>
    /// Determines who is playing in a game (Entrants).
    /// Entrants = (Winners of Feeder Games) + (Fixed Seeds like 'Alabama')
    /// </summary>
    private IEnumerable<string> GetEntrantsForGame(BowlGame game)
    {
        var entrants = new HashSet<string>();

        // A. Fixed Teams (Root nodes or pre-seeded slots)
        // If the database has a concrete name (not TBD), it's an entrant.
        if (!string.IsNullOrEmpty(game.TeamHome) && !game.TeamHome.Equals("TBD", StringComparison.OrdinalIgnoreCase))
            entrants.Add(game.TeamHome);
            
        if (!string.IsNullOrEmpty(game.TeamAway) && !game.TeamAway.Equals("TBD", StringComparison.OrdinalIgnoreCase))
            entrants.Add(game.TeamAway);

        // B. Feeder Games (Recursive Step)
        // Look for any games that point to this one as their 'NextGameId'
        if (_feederMap != null && _feederMap.Contains(game.Id))
        {
            foreach (var feeder in _feederMap[game.Id])
            {
                // The potential winners of the feeder game become the entrants of this game
                var incoming = GetPotentialWinnersForGame(feeder);
                foreach (var team in incoming) entrants.Add(team);
            }
        }

        return entrants;
    }

    // --- INTERACTION ---

    private void ToggleSimWinner(string gameId, string team)
    {
        if (simulatedWinners.ContainsKey(gameId) && simulatedWinners[gameId] == team)
            simulatedWinners.Remove(gameId);
        else
            simulatedWinners[gameId] = team;
            
        // Check for invalid downstream picks (e.g. I picked Team A in Final, but switched Semi to Team B)
        // In a complex app we might auto-remove them, but simply recalculating scores handles the math correctly.
        // Visual cleanup could happen here if desired.
            
        Recalculate();
    }

    private void SetSimWinner(string gameId, string? team)
    {
        if (string.IsNullOrEmpty(team))
            simulatedWinners.Remove(gameId);
        else
            simulatedWinners[gameId] = team;
            
        Recalculate();
    }

    private void ResetSimulation()
    {
        simulatedWinners.Clear();
        Recalculate();
    }

    private void Recalculate()
    {
        projectedStandings = WhatIfScoringEngine.Calculate(games, filteredEntries, simulatedWinners);
    }

    // --- STYLING HELPERS ---

    private string GetSimClass(string gameId, string team)
    {
        if (!simulatedWinners.ContainsKey(gameId)) return "bg-white"; 
        
        if (simulatedWinners[gameId] == team) return "active-win"; 
        return "active-loss"; 
    }

    private string GetRealWinner(BowlGame game)
    {
        if (game.Status != GameStatus.Final) return "";
        int h = game.TeamHomeScore ?? 0;
        int a = game.TeamAwayScore ?? 0;
        if (h > a) return game.TeamHome;
        if (a > h) return game.TeamAway;
        return "";
    }

    private string GetCellClass(BowlGame game, string pick)
    {
        if (string.IsNullOrEmpty(pick)) return "";
        string winner = "";
        
        if (game.Status == GameStatus.Final) winner = GetRealWinner(game);
        else if (simulatedWinners.ContainsKey(game.Id)) winner = simulatedWinners[game.Id];

        if (!string.IsNullOrEmpty(winner))
        {
            return string.Equals(pick, winner, StringComparison.OrdinalIgnoreCase) ? "cell-win" : "cell-loss";
        }
        return "";
    }
}
