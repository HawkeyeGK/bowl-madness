@page "/admin/debug-raw"
@using BowlPoolManager.Core.Domain
@using BowlPoolManager.Core.Dtos
@using Newtonsoft.Json
@inject HttpClient Http

<h3>Score Update Diagnostic Tool</h3>

<div class="card mb-4">
    <div class="card-body">
        <button class="btn btn-primary" @onclick="RunDiagnostic" disabled="@IsLoading">
            @(IsLoading ? "Running..." : "Run Matching Diagnostic")
        </button>
        <p class="mt-2 text-muted">This will compare local database games with the live Scoreboard API and report mismatches.</p>
    </div>
</div>

@if (Logs.Any())
{
    <div class="list-group">
        @foreach (var log in Logs)
        {
            <div class="list-group-item @(log.IsError ? "list-group-item-danger" : (log.IsMatch ? "list-group-item-success" : ""))">
                <strong>@log.Title</strong><br/>
                <small>@log.Message</small>
            </div>
        }
    </div>
}

@code {
    private bool IsLoading = false;
    private List<LogEntry> Logs = new();

    private async Task RunDiagnostic()
    {
        IsLoading = true;
        Logs.Clear();
        try
        {
            // 1. Fetch Local Games
            Logs.Add(new LogEntry("System", "Fetching local games from Cosmos DB..."));
            var localGames = await Http.GetFromJsonAsync<List<BowlGame>>("api/GetGames");
            
            // 2. Fetch API Games
            Logs.Add(new LogEntry("System", "Fetching live scoreboard data..."));
            var apiJson = await Http.GetStringAsync("api/GetRawCfbdGames?source=scoreboard");
            var apiGames = JsonConvert.DeserializeObject<List<CfbdGameDto>>(apiJson);

            if (localGames == null || apiGames == null)
            {
                Logs.Add(new LogEntry("Error", "Failed to retrieve one or both datasets.", true));
                return;
            }

            // 3. Simulate PerformScoreUpdate logic
            foreach (var local in localGames.Where(g => !string.IsNullOrEmpty(g.ExternalId)))
            {
                var apiMatch = apiGames.FirstOrDefault(x => x.Id.ToString() == local.ExternalId);
                
                if (apiMatch == null)
                {
                    Logs.Add(new LogEntry(local.BowlName, $"❌ FAIL: ExternalId '{local.ExternalId}' not found in API results.", true));
                    continue;
                }

                // Check Home Team
                bool homeMatch = string.Equals(apiMatch.HomeTeam, local.ApiHomeTeam, StringComparison.OrdinalIgnoreCase);
                string homeStatus = homeMatch ? "✅ MATCH" : $"❌ MISMATCH (API: '{apiMatch.HomeTeam}' vs DB: '{local.ApiHomeTeam}')";

                // Check Away Team
                bool awayMatch = string.Equals(apiMatch.AwayTeam, local.ApiAwayTeam, StringComparison.OrdinalIgnoreCase);
                string awayStatus = awayMatch ? "✅ MATCH" : $"❌ MISMATCH (API: '{apiMatch.AwayTeam}' vs DB: '{local.ApiAwayTeam}')";

                Logs.Add(new LogEntry(local.BowlName, $"ID Found. Home: {homeStatus} | Away: {awayStatus}") 
                { 
                    IsMatch = homeMatch && awayMatch 
                });
            }
        }
        catch (Exception ex)
        {
            Logs.Add(new LogEntry("Exception", ex.Message, true));
        }
        finally
        {
            IsLoading = false;
        }
    }

    public class LogEntry
    {
        public string Title { get; set; }
        public string Message { get; set; }
        public bool IsError { get; set; }
        public bool IsMatch { get; set; }
        public LogEntry(string t, string m, bool e = false) { Title = t; Message = m; IsError = e; }
    }
}
