@page "/admin/debug-raw"
@using BowlPoolManager.Core.Domain
@using BowlPoolManager.Core.Dtos
@using Newtonsoft.Json
@inject HttpClient Http

<PageTitle>Debug API</PageTitle>

<div class="container-fluid mt-3 px-4">
    <div class="d-flex justify-content-between align-items-end mb-3">
        <div class="d-flex flex-column gap-2">
            <div class="d-flex align-items-center gap-3">
                <h1 class="h3 fw-bold mb-0"><i class="bi bi-bug-fill text-primary"></i> Score Diagnostics</h1>
            </div>
        </div>
    </div>

<div class="card mb-4">
    <div class="card-body">
        <button class="btn btn-primary" @onclick="RunDiagnostic" disabled="@IsLoading">
            @(IsLoading ? "Running..." : "Run Matching Diagnostic")
        </button>
        <p class="mt-2 text-muted">This will compare local database games with the live Scoreboard API using the Server's "Swap-Aware" logic.</p>
    </div>
</div>

@if (Logs.Any())
{
    <div class="list-group">
        @foreach (var log in Logs)
        {
            <div class="list-group-item @(log.IsError ? "list-group-item-danger" : (log.IsMatch ? "list-group-item-success" : ""))">
                <strong>@log.Title</strong><br/>
                <small>@log.Message</small>
            </div>
        }
    </div>
    </div>
}

@code {
    private bool IsLoading = false;
    private List<LogEntry> Logs = new();

    private async Task RunDiagnostic()
    {
        IsLoading = true;
        Logs.Clear();
        try
        {
            // 1. Fetch Local Games
            Logs.Add(new LogEntry("System", "Fetching local games from Cosmos DB..."));
            var localGames = await Http.GetFromJsonAsync<List<BowlGame>>("api/GetGames");
            
            // 2. Fetch API Games
            Logs.Add(new LogEntry("System", "Fetching live scoreboard data..."));
            var apiJson = await Http.GetStringAsync("api/GetRawCfbdGames?source=scoreboard");
            var apiGames = JsonConvert.DeserializeObject<List<CfbdGameDto>>(apiJson);

            if (localGames == null || apiGames == null)
            {
                Logs.Add(new LogEntry("Error", "Failed to retrieve one or both datasets.", true));
                return;
            }

            // 3. Simulate PerformScoreUpdate logic (Swap-Aware)
            foreach (var local in localGames.Where(g => !string.IsNullOrEmpty(g.ExternalId)))
            {
                var apiMatch = apiGames.FirstOrDefault(x => x.Id.ToString() == local.ExternalId);
                
                if (apiMatch == null)
                {
                    Logs.Add(new LogEntry(local.BowlName, $"❌ FAIL: ExternalId '{local.ExternalId}' not found in API results.", true));
                    continue;
                }

                // Helper to check both slots
                string CheckTeam(string? dbTeam, string? apiHome, string? apiAway)
                {
                    if (string.IsNullOrEmpty(dbTeam)) return "⚠️ SKIPPED (No DB Team)";
                    
                    if (string.Equals(dbTeam, apiHome, StringComparison.OrdinalIgnoreCase)) return "✅ MATCH (Direct)";
                    if (string.Equals(dbTeam, apiAway, StringComparison.OrdinalIgnoreCase)) return "✅ MATCH (Swapped)";
                    
                    return $"❌ MISMATCH (DB: '{dbTeam}' not found in API Game)";
                }

                string homeStatus = CheckTeam(local.ApiHomeTeam, apiMatch.HomeTeam, apiMatch.AwayTeam);
                string awayStatus = CheckTeam(local.ApiAwayTeam, apiMatch.HomeTeam, apiMatch.AwayTeam);

                bool isMatch = homeStatus.Contains("MATCH") && awayStatus.Contains("MATCH");

                Logs.Add(new LogEntry(local.BowlName, $"ID Found. Home: {homeStatus} | Away: {awayStatus}") 
                { 
                    IsMatch = isMatch 
                });
            }
        }
        catch (Exception ex)
        {
            Logs.Add(new LogEntry("Exception", ex.Message, true));
        }
        finally
        {
            IsLoading = false;
        }
    }

    public class LogEntry
    {
        public string Title { get; set; }
        public string Message { get; set; }
        public bool IsError { get; set; }
        public bool IsMatch { get; set; }
        public LogEntry(string t, string m, bool e = false) { Title = t; Message = m; IsError = e; }
    }
}
