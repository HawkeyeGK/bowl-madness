@page "/admin/linker"
@using BowlPoolManager.Core.Domain
@using BowlPoolManager.Core.Dtos
@using BowlPoolManager.Client.Services
@inject ISeasonService SeasonService
@inject IConfigurationService ConfigurationService
@inject HttpClient Http
@inject NavigationManager Nav

@inject NavigationManager Nav

<PageTitle>Game Linker</PageTitle>

<div class="container-fluid mt-3 px-4">
    <div class="d-flex justify-content-between align-items-end mb-3">
        <div class="d-flex flex-column gap-2">
            <div class="d-flex align-items-center gap-3">
                <h1 class="h3 fw-bold mb-0"><i class="bi bi-link-45deg text-primary"></i> Game Linker</h1>
            </div>
        </div>
    </div>

@if (IsLoading)
{
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
}
else
{
    @if (!LocalGames.Any())
    {
        <div class="alert alert-warning">No games found for the current season.</div>
    }
    else
    {
        <div class="table-responsive">
            <table class="table table-striped table-hover align-middle">
                <thead class="table-dark">
                    <tr>
                        <th>Local Game</th>
                        <th>Date</th>
                        <th style="min-width: 300px;">Link Map (Local &rarr; API)</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var game in LocalGames)
                    {
                        <tr class="@(IsLinked(game) ? "table-success" : "")">
                            <td>
                                <strong>@game.BowlName</strong><br/>
                                <span class="text-muted small">@game.TeamHome vs @game.TeamAway</span>
                            </td>
                            <td>@game.StartTime.ToLocalTime().ToString("MMM dd, h:mm tt")</td>
                            <td>
                                @if(IsLinked(game))
                                {
                                    <div class="bg-white rounded p-1 border shadow-sm" style="max-width: 350px;">
                                        <table class="table table-sm table-borderless mb-0" style="font-size: 0.85rem;">
                                            <tbody>
                                                <tr>
                                                    <td class="text-end fw-bold py-0 pe-1">@game.TeamHome</td>
                                                    <td class="text-center text-muted py-0 px-1">&rarr;</td>
                                                    <td class="text-start text-success fw-bold py-0 ps-1">@game.ApiHomeTeam</td>
                                                </tr>
                                                <tr>
                                                    <td class="text-end fw-bold py-0 pe-1">@game.TeamAway</td>
                                                    <td class="text-center text-muted py-0 px-1">&rarr;</td>
                                                    <td class="text-start text-success fw-bold py-0 ps-1">@game.ApiAwayTeam</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                }
                                else
                                {
                                    <span class="badge bg-warning text-dark">Unlinked</span>
                                }
                            </td>
                            <td>
                                <button class="btn btn-outline-primary btn-sm" @onclick="() => OpenLinkModal(game)">
                                    @(IsLinked(game) ? "Edit Link" : "Link Game")
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
}
</div>

@if (ShowModal)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Link Game: @SelectedLocalGame?.BowlName</h5>
                    <button type="button" class="btn-close" @onclick="CloseModal"></button>
                </div>
                <div class="modal-body">
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">1. Select Matching API Game:</label>
                        <select class="form-select" @onchange="OnApiGameSelected">
                            <option value="">-- Choose Game --</option>
                            @foreach (var ext in ExternalGames.OrderBy(x => x.HomeTeam))
                            {
                                <option value="@ext.Id" selected="@(SelectedApiGame?.Id == ext.Id)">
                                    @ext.HomeTeam vs @ext.AwayTeam @(!string.IsNullOrEmpty(ext.Notes) ? $"({ext.Notes})" : "")
                                </option>
                            }
                        </select>
                    </div>

                    @if (SelectedApiGame != null && SelectedLocalGame != null)
                    {
                        <div class="card bg-light">
                            <div class="card-header fw-bold small text-uppercase">
                                2. Map Teams
                            </div>
                            <div class="card-body">
                                <p class="small text-muted mb-3">
                                    Match your local teams to the names provided by the API.
                                </p>

                                <div class="row align-items-center mb-3">
                                    <div class="col-4 text-end fw-bold">
                                        @SelectedLocalGame.TeamHome
                                    </div>
                                    <div class="col-1 text-center">
                                        <span class="oi oi-arrow-right text-muted"></span>
                                    </div>
                                    <div class="col-7">
                                        <select class="form-select" @bind="ProposedApiHome">
                                            <option value="">-- Select API Team --</option>
                                            @foreach(var team in AvailableApiTeams)
                                            {
                                                <option value="@team">@team</option>
                                            }
                                        </select>
                                    </div>
                                </div>

                                <div class="row align-items-center">
                                    <div class="col-4 text-end fw-bold">
                                        @SelectedLocalGame.TeamAway
                                    </div>
                                    <div class="col-1 text-center">
                                        <span class="oi oi-arrow-right text-muted"></span>
                                    </div>
                                    <div class="col-7">
                                        <select class="form-select" @bind="ProposedApiAway">
                                            <option value="">-- Select API Team --</option>
                                            @foreach(var team in AvailableApiTeams)
                                            {
                                                <option value="@team">@team</option>
                                            }
                                        </select>
                                    </div>
                                </div>

                            </div>
                        </div>
                    }

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseModal">Cancel</button>
                    <button type="button" class="btn btn-primary" 
                            disabled="@(!CanSave || IsSaving)"
                            @onclick="SaveLink">
                        @if (IsSaving) { <span>Saving...</span> } else { <span>Confirm Link</span> }
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private bool IsLoading = true;
    private bool IsSaving = false;
    private bool ShowModal = false;
    
    private BowlGame? SelectedLocalGame;
    private CfbdGameDto? SelectedApiGame;

    private List<string> AvailableApiTeams = new();
    private string ProposedApiHome = "";
    private string ProposedApiAway = "";

    private List<BowlGame> LocalGames = new();
    private List<CfbdGameDto> ExternalGames = new();
    
    // Packet 2: Team Data
    private List<TeamInfo> AllTeams = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        IsLoading = true;
        try
        {
            var seasons = await SeasonService.GetSeasonsAsync();
            var currentSeason = seasons.FirstOrDefault(s => s.IsCurrent);

            var url = "api/GetGames";
            if (currentSeason != null)
            {
                url += $"?seasonId={currentSeason.Id}";
            }

            // Parallel load
            var gamesTask = Http.GetFromJsonAsync<List<BowlGame>>(url);
            var cfbdTask = Http.GetFromJsonAsync<List<CfbdGameDto>>("api/GetRawCfbdGames?source=scoreboard");
            var teamsTask = ConfigurationService.GetTeamsAsync();

            await Task.WhenAll(gamesTask, cfbdTask, teamsTask);

            LocalGames = await gamesTask ?? new();
            ExternalGames = await cfbdTask ?? new();
            AllTeams = await teamsTask ?? new();

            // Populate empty bracket slots with winners from previous rounds
            ResolveAdvancingTeams();
        }
        catch (Exception ex) { Console.WriteLine($"Error: {ex.Message}"); }
        finally { IsLoading = false; }
    }

    private void ResolveAdvancingTeams()
    {
        // Iterate through all games to find those that are Final and have a "NextGame"
        foreach (var feederGame in LocalGames.Where(g => g.Status == GameStatus.Final && !string.IsNullOrEmpty(g.NextGameId)))
        {
            var winner = feederGame.WinningTeamName;
            if (string.IsNullOrEmpty(winner)) continue;

            // Find the target game
            var targetGame = LocalGames.FirstOrDefault(g => g.Id == feederGame.NextGameId);
            if (targetGame == null) continue;

            // Determine if the winner is already in the target game
            bool alreadySeated = (targetGame.TeamHome == winner || targetGame.TeamAway == winner);

            if (!alreadySeated)
            {
                // Place the winner in the first available empty slot
                if (string.IsNullOrEmpty(targetGame.TeamHome))
                {
                    targetGame.TeamHome = winner;
                }
                else if (string.IsNullOrEmpty(targetGame.TeamAway))
                {
                    targetGame.TeamAway = winner;
                }
            }
        }
    }

    private bool IsLinked(BowlGame game) => !string.IsNullOrEmpty(game.ExternalId);

    private bool CanSave => SelectedApiGame != null 
                            && !string.IsNullOrEmpty(ProposedApiHome) 
                            && !string.IsNullOrEmpty(ProposedApiAway)
                            && ProposedApiHome != ProposedApiAway;

    private void OpenLinkModal(BowlGame game)
    {
        SelectedLocalGame = game;
        SelectedApiGame = null;
        AvailableApiTeams.Clear();
        
        // Preserve existing values for editing
        ProposedApiHome = game.ApiHomeTeam ?? "";
        ProposedApiAway = game.ApiAwayTeam ?? "";

        if (!string.IsNullOrEmpty(game.ExternalId))
        {
            var match = ExternalGames.FirstOrDefault(x => x.Id.ToString() == game.ExternalId);
            if (match != null)
            {
                SelectApiGameInternal(match);
                // Ensure edit values aren't overwritten by auto-match if they exist
                if (!string.IsNullOrEmpty(game.ApiHomeTeam)) ProposedApiHome = game.ApiHomeTeam;
                if (!string.IsNullOrEmpty(game.ApiAwayTeam)) ProposedApiAway = game.ApiAwayTeam;
            }
        }
        
        ShowModal = true;
    }

    private void CloseModal()
    {
        ShowModal = false;
        SelectedLocalGame = null;
        SelectedApiGame = null;
    }

    private void OnApiGameSelected(ChangeEventArgs e)
    {
        var idStr = e.Value?.ToString();
        if (int.TryParse(idStr, out int id))
        {
            var match = ExternalGames.FirstOrDefault(x => x.Id == id);
            SelectApiGameInternal(match);
        }
        else
        {
            SelectedApiGame = null;
            AvailableApiTeams.Clear();
        }
    }

    private void SelectApiGameInternal(CfbdGameDto? match)
    {
        SelectedApiGame = match;
        AvailableApiTeams.Clear();
        if (match != null)
        {
            var h = match.HomeTeam;
            var a = match.AwayTeam;
            if (!string.IsNullOrEmpty(h)) AvailableApiTeams.Add(h);
            if (!string.IsNullOrEmpty(a)) AvailableApiTeams.Add(a);
            
            // Only auto-default if they are currently empty
            if (string.IsNullOrEmpty(ProposedApiHome) && !string.IsNullOrEmpty(h)) ProposedApiHome = h;
            if (string.IsNullOrEmpty(ProposedApiAway) && !string.IsNullOrEmpty(a)) ProposedApiAway = a;
        }
    }

    private async Task SaveLink()
    {
        if (SelectedLocalGame == null || SelectedApiGame == null) return;

        IsSaving = true;
        SelectedLocalGame.ExternalId = SelectedApiGame.Id.ToString();
        
        // --- RICH TEAM DATA DENORMALIZATION ---
        // 1. Home Team
        var homeTeam = AllTeams.FirstOrDefault(t => t.SchoolId == SelectedApiGame.HomeId);
        if (homeTeam == null) 
            homeTeam = AllTeams.FirstOrDefault(t => t.School == ProposedApiHome || t.School == SelectedApiGame.HomeTeam);

        if (homeTeam != null)
        {
            SelectedLocalGame.TeamHomeId = homeTeam.SchoolId;
            SelectedLocalGame.HomeTeamInfo = homeTeam.ToDenormalized();
            // Ensure name matches exactly if we found a rich object (optional, but keeps data clean)
            // SelectedLocalGame.ApiHomeTeam = homeTeam.School; // Use ProposedApiHome instead to respect user choice
        }

        // 2. Away Team
        var awayTeam = AllTeams.FirstOrDefault(t => t.SchoolId == SelectedApiGame.AwayId);
        if (awayTeam == null) 
             awayTeam = AllTeams.FirstOrDefault(t => t.School == ProposedApiAway || t.School == SelectedApiGame.AwayTeam);

        if (awayTeam != null)
        {
            SelectedLocalGame.TeamAwayId = awayTeam.SchoolId;
            SelectedLocalGame.AwayTeamInfo = awayTeam.ToDenormalized();
        }
        // --------------------------------------

        SelectedLocalGame.ApiHomeTeam = ProposedApiHome;
        SelectedLocalGame.ApiAwayTeam = ProposedApiAway;

        try
        {
            var response = await Http.PostAsJsonAsync("api/SaveGame", SelectedLocalGame);
            if (response.IsSuccessStatusCode) CloseModal();
        }
        catch (Exception ex) { Console.WriteLine($"Error: {ex.Message}"); }
        finally { IsSaving = false; }
    }
}
