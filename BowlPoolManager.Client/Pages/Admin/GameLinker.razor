@page "/admin/linker"
@using BowlPoolManager.Core.Domain
@using BowlPoolManager.Core.Dtos
@inject HttpClient Http
@inject NavigationManager Nav

<h3 class="mb-4">ðŸ”— Game Linker</h3>

@if (IsLoading)
{
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
}
else
{
    <div class="table-responsive">
        <table class="table table-striped table-hover align-middle">
            <thead class="table-dark">
                <tr>
                    <th>Local Game</th>
                    <th>Date</th>
                    <th style="min-width: 300px;">Link Map (Local &rarr; API)</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var game in LocalGames)
                {
                    <tr class="@(IsLinked(game) ? "table-success" : "")">
                        <td>
                            <strong>@game.BowlName</strong><br/>
                            <span class="text-muted small">@game.TeamHome vs @game.TeamAway</span>
                        </td>
                        <td>@game.StartTime.ToLocalTime().ToString("MMM dd, h:mm tt")</td>
                        <td>
                            @if(IsLinked(game))
                            {
                                <div class="bg-white rounded p-1 border shadow-sm" style="max-width: 350px;">
                                    <table class="table table-sm table-borderless mb-0" style="font-size: 0.85rem;">
                                        <tbody>
                                            <tr>
                                                <td class="text-end fw-bold py-0 pe-1">@game.TeamHome</td>
                                                <td class="text-center text-muted py-0 px-1">&rarr;</td>
                                                <td class="text-start text-success fw-bold py-0 ps-1">@game.ApiHomeTeam</td>
                                            </tr>
                                            <tr>
                                                <td class="text-end fw-bold py-0 pe-1">@game.TeamAway</td>
                                                <td class="text-center text-muted py-0 px-1">&rarr;</td>
                                                <td class="text-start text-success fw-bold py-0 ps-1">@game.ApiAwayTeam</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            }
                            else
                            {
                                <span class="badge bg-warning text-dark">Unlinked</span>
                            }
                        </td>
                        <td>
                            <button class="btn btn-outline-primary btn-sm" @onclick="() => OpenLinkModal(game)">
                                @(IsLinked(game) ? "Edit Link" : "Link Game")
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}

@if (ShowModal)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Link Game: @SelectedLocalGame?.BowlName</h5>
                    <button type="button" class="btn-close" @onclick="CloseModal"></button>
                </div>
                <div class="modal-body">
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">1. Select Matching API Game:</label>
                        <select class="form-select" @onchange="OnApiGameSelected">
                            <option value="">-- Choose Game --</option>
                            @foreach (var ext in ExternalGames.OrderBy(x => x.HomeTeam))
                            {
                                <option value="@ext.Id" selected="@(SelectedApiGame?.Id == ext.Id)">
                                    @ext.HomeTeam vs @ext.AwayTeam (@ext.Notes)
                                </option>
                            }
                        </select>
                    </div>

                    @if (SelectedApiGame != null && SelectedLocalGame != null)
                    {
                        <div class="card bg-light">
                            <div class="card-header fw-bold small text-uppercase">
                                2. Map Teams
                            </div>
                            <div class="card-body">
                                <p class="small text-muted mb-3">
                                    Match your local teams to the names provided by the API.
                                </p>

                                <div class="row align-items-center mb-3">
                                    <div class="col-4 text-end fw-bold">
                                        @SelectedLocalGame.TeamHome
                                    </div>
                                    <div class="col-1 text-center">
                                        <span class="oi oi-arrow-right text-muted"></span>
                                    </div>
                                    <div class="col-7">
                                        <select class="form-select" @bind="ProposedApiHome">
                                            <option value="">-- Select API Team --</option>
                                            @foreach(var team in AvailableApiTeams)
                                            {
                                                <option value="@team">@team</option>
                                            }
                                        </select>
                                    </div>
                                </div>

                                <div class="row align-items-center">
                                    <div class="col-4 text-end fw-bold">
                                        @SelectedLocalGame.TeamAway
                                    </div>
                                    <div class="col-1 text-center">
                                        <span class="oi oi-arrow-right text-muted"></span>
                                    </div>
                                    <div class="col-7">
                                        <select class="form-select" @bind="ProposedApiAway">
                                            <option value="">-- Select API Team --</option>
                                            @foreach(var team in AvailableApiTeams)
                                            {
                                                <option value="@team">@team</option>
                                            }
                                        </select>
                                    </div>
                                </div>

                            </div>
                        </div>
                    }

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseModal">Cancel</button>
                    <button type="button" class="btn btn-primary" 
                            disabled="@(!CanSave || IsSaving)"
                            @onclick="SaveLink">
                        @if (IsSaving) { <span>Saving...</span> } else { <span>Confirm Link</span> }
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private bool IsLoading = true;
    private bool IsSaving = false;
    private bool ShowModal = false;
    
    private BowlGame? SelectedLocalGame;
    private CfbdGameDto? SelectedApiGame;

    private List<string> AvailableApiTeams = new();
    private string ProposedApiHome = "";
    private string ProposedApiAway = "";

    private List<BowlGame> LocalGames = new();
    private List<CfbdGameDto> ExternalGames = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        IsLoading = true;
        try
        {
            LocalGames = await Http.GetFromJsonAsync<List<BowlGame>>("api/GetGames") ?? new();
            // Use the scoreboard source to get full names (e.g. "Oklahoma Sooners")
            ExternalGames = await Http.GetFromJsonAsync<List<CfbdGameDto>>("api/GetRawCfbdGames?source=scoreboard") ?? new();
        }
        catch (Exception ex) { Console.WriteLine($"Error: {ex.Message}"); }
        finally { IsLoading = false; }
    }

    private bool IsLinked(BowlGame game) => !string.IsNullOrEmpty(game.ExternalId);

    private bool CanSave => SelectedApiGame != null 
                            && !string.IsNullOrEmpty(ProposedApiHome) 
                            && !string.IsNullOrEmpty(ProposedApiAway)
                            && ProposedApiHome != ProposedApiAway;

    private void OpenLinkModal(BowlGame game)
    {
        SelectedLocalGame = game;
        SelectedApiGame = null;
        AvailableApiTeams.Clear();
        ProposedApiHome = "";
        ProposedApiAway = "";
        
        if (!string.IsNullOrEmpty(game.ExternalId))
        {
            var match = ExternalGames.FirstOrDefault(x => x.Id.ToString() == game.ExternalId);
            if (match != null)
            {
                SelectApiGameInternal(match);
                // Use existing stored values if they exist, otherwise default to match order
                ProposedApiHome = !string.IsNullOrEmpty(game.ApiHomeTeam) ? game.ApiHomeTeam : (match.HomeTeam ?? "");
                ProposedApiAway = !string.IsNullOrEmpty(game.ApiAwayTeam) ? game.ApiAwayTeam : (match.AwayTeam ?? "");
            }
        }
        
        ShowModal = true;
    }

    private void CloseModal()
    {
        ShowModal = false;
        SelectedLocalGame = null;
        SelectedApiGame = null;
    }

    private void OnApiGameSelected(ChangeEventArgs e)
    {
        var idStr = e.Value?.ToString();
        if (int.TryParse(idStr, out int id))
        {
            var match = ExternalGames.FirstOrDefault(x => x.Id == id);
            SelectApiGameInternal(match);
        }
        else
        {
            SelectedApiGame = null;
            AvailableApiTeams.Clear();
        }
    }

    private void SelectApiGameInternal(CfbdGameDto? match)
    {
        SelectedApiGame = match;
        AvailableApiTeams.Clear();
        if (match != null)
        {
            var hName = match.HomeTeam;
            var aName = match.AwayTeam;

            if (!string.IsNullOrEmpty(hName)) AvailableApiTeams.Add(hName);
            if (!string.IsNullOrEmpty(aName)) AvailableApiTeams.Add(aName);
            
            // Only set defaults if we aren't already editing an existing link (checked by caller mostly, but safe here)
            // Default mapping: First local team -> First API team (Home), Second -> Second (Away)
            if (string.IsNullOrEmpty(ProposedApiHome) && !string.IsNullOrEmpty(hName)) 
                ProposedApiHome = hName;
            
            if (string.IsNullOrEmpty(ProposedApiAway) && !string.IsNullOrEmpty(aName)) 
                ProposedApiAway = aName;
        }
    }

    private async Task SaveLink()
    {
        if (SelectedLocalGame == null || SelectedApiGame == null) return;

        IsSaving = true;
        SelectedLocalGame.ExternalId = SelectedApiGame.Id.ToString();
        SelectedLocalGame.ApiHomeTeam = ProposedApiHome;
        SelectedLocalGame.ApiAwayTeam = ProposedApiAway;

        try
        {
            var response = await Http.PostAsJsonAsync("api/SaveGame", SelectedLocalGame);
            if (response.IsSuccessStatusCode) CloseModal();
        }
        catch (Exception ex) { Console.WriteLine($"Error: {ex.Message}"); }
        finally { IsSaving = false; }
    }
}
