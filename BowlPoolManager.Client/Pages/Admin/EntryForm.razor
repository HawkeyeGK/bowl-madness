@page "/admin/entries/new"
@page "/admin/entries/edit/{Id}"
@using BowlPoolManager.Core.Domain
@using System.Net.Http.Json
@inject HttpClient Http
@inject NavigationManager Nav
@inject IJSRuntime JS

<h3>@(string.IsNullOrEmpty(Id) ? "New Entry" : "Edit Entry")</h3>

@if (Entry == null)
{
    <p>Loading...</p>
}
else
{
    <EditForm Model="Entry" OnValidSubmit="SaveEntry">
        <DataAnnotationsValidator />
        
        <div class="mb-3">
            <label class="form-label">Player Name</label>
            <InputText @bind-Value="Entry.PlayerName" class="form-control" />
        </div>

        <div class="mb-3">
            <label class="form-label">Tie Breaker Points</label>
            <InputNumber @bind-Value="Entry.TieBreakerPoints" class="form-control" />
        </div>
        
        <div class="alert alert-info">
            To edit specific picks, please use the "My Picks" interface or a dedicated Pick Editor.
        </div>

        <button type="submit" class="btn btn-primary">Save</button>
        <button type="button" class="btn btn-secondary" @onclick="Cancel">Cancel</button>

        @if (!string.IsNullOrEmpty(Id))
        {
            <button type="button" class="btn btn-danger ms-2" @onclick="DeleteEntry">Delete</button>
        }
    </EditForm>
}

@code {
    [Parameter] public string? Id { get; set; }
    private BracketEntry? Entry { get; set; }

    protected override async Task OnInitializedAsync()
    {
        if (string.IsNullOrEmpty(Id))
        {
            Entry = new BracketEntry();
        }
        else
        {
            // Edit Mode: Fetch existing
            try 
            {
                Entry = await Http.GetFromJsonAsync<BracketEntry>($"api/GetEntry?id={Id}");
            }
            catch
            {
                // Handle not found
                Nav.NavigateTo("/admin/dashboard");
            }
        }
    }

    private async Task SaveEntry()
    {
        var response = await Http.PostAsJsonAsync("api/SaveEntry", Entry);
        if (response.IsSuccessStatusCode)
        {
            Nav.NavigateTo("/admin/dashboard");
        }
        else
        {
            await JS.InvokeVoidAsync("alert", "Error saving entry.");
        }
    }

    private async Task DeleteEntry()
    {
        if (Entry == null) return;

        bool confirmed = await JS.InvokeAsync<bool>("confirm", $"Are you sure you want to delete the entry for {Entry.PlayerName}?");
        if (confirmed)
        {
            var response = await Http.DeleteAsync($"api/DeleteEntry?id={Entry.Id}");
            if (response.IsSuccessStatusCode)
            {
                Nav.NavigateTo("/admin/dashboard");
            }
            else
            {
                await JS.InvokeVoidAsync("alert", "Error deleting entry.");
            }
        }
    }

    private void Cancel()
    {
        Nav.NavigateTo("/admin/dashboard");
    }
}
