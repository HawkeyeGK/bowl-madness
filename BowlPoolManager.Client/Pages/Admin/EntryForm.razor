@page "/admin/entry"
@page "/admin/entry/{EntryId}"
@using BowlPoolManager.Core.Domain
@using BowlPoolManager.Core
@using BowlPoolManager.Core.Helpers
@using Microsoft.AspNetCore.Authorization
@using System.Net.Http.Json
@using System.Text.Json

@attribute [Authorize(Roles = "SuperAdmin,Admin")]
@inject HttpClient Http
@inject NavigationManager Nav
@inject IJSRuntime JS 

<PageTitle>@(string.IsNullOrEmpty(EntryId) ? "New" : "Edit") Bracket Entry</PageTitle>

<div class="container mt-4 pb-5 position-relative">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="bi bi-pencil-square"></i> @(string.IsNullOrEmpty(EntryId) ? "New" : "Edit") Bracket Entry</h1>
        <a href="/admin/entries" class="btn btn-outline-secondary">Back to List</a>
    </div>

    @if (isLoading)
    {
        <div class="d-flex justify-content-center">
            <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>
        </div>
    }
    else
    {
        <EditForm Model="@entry" OnValidSubmit="HandleSave">
            <DataAnnotationsValidator />
            
            @if (!string.IsNullOrEmpty(statusMessage) && string.IsNullOrEmpty(EntryId))
            {
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    @statusMessage
                    <button type="button" class="btn-close" @onclick="() => statusMessage = null"></button>
                </div>
            }

            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="alert alert-danger">@errorMessage</div>
            }

            @* PLAYER, POOL & OWNER INFO *@
            <div class="card mb-4 shadow-sm">
                <div class="card-header bg-primary text-white">Entry Details</div>
                <div class="card-body">
                    <div class="row g-3">
                        @* 1. Player Name *@
                        <div class="col-md-3">
                            <label class="form-label fw-bold">Bracket Name</label>
                            <InputText class="form-control" @bind-Value="entry.PlayerName" placeholder="e.g. John's Picks" />
                            <ValidationMessage For="@(() => entry.PlayerName)" />
                        </div>

                        @* 2. Pool Selection *@
                        <div class="col-md-3">
                            <label class="form-label fw-bold">Pool</label>
                            @if (string.IsNullOrEmpty(EntryId))
                            {
                                <InputSelect class="form-select" @bind-Value="entry.PoolId">
                                    <option value="">-- Select Pool --</option>
                                    @foreach (var p in pools.Where(p => !p.IsArchived))
                                    {
                                        <option value="@p.Id">@p.Name</option>
                                    }
                                </InputSelect>
                            }
                            else
                            {
                                <div class="input-group">
                                    <input type="text" class="form-control" value="@(pools.FirstOrDefault(p => p.Id == entry.PoolId)?.Name ?? "Unknown")" disabled />
                                    <button class="btn btn-outline-warning" type="button" @onclick="() => showMoveModal = true">
                                        <i class="bi bi-arrow-left-right"></i> Move
                                    </button>
                                </div>
                            }
                        </div>

                        @* 3. Owner Selection (NEW) *@
                        <div class="col-md-3">
                            <label class="form-label fw-bold">Owner (User)</label>
                            <InputSelect class="form-select" @bind-Value="entry.UserId">
                                <option value="">-- Unassigned --</option>
                                @foreach (var u in users)
                                {
                                    <option value="@u.Id">@u.Email</option>
                                }
                            </InputSelect>
                            <div class="form-text small">Who manages this bracket?</div>
                        </div>
                    </div>
                </div>
            </div>

            @* GAME SELECTION (MYPICKS STYLE) *@
            @if (!string.IsNullOrEmpty(entry.PoolId))
            {
                <div class="card shadow-sm mb-5">
                    <div class="card-header bg-dark text-white fw-bold">
                        Picks (@(entry.Picks?.Count ?? 0) / @ValidGames.Count Selected)
                    </div>
                    <ul class="list-group list-group-flush">
                        @foreach (var game in ValidGames.OrderBy(g => g.IsPlayoff).ThenBy(g => g.StartTime))
                        {
                            string pick = "";
                            if (entry.Picks?.TryGetValue(game.Id, out var p) == true)
                            {
                                pick = p;
                            }
                            
                            bool isSelected = !string.IsNullOrEmpty(pick);
                            var slots = GetMatchupSlots(game);
                            
                            <li class="list-group-item p-3 @(isSelected ? "bg-light-success" : "")">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <div>
                                        <span class="badge bg-secondary">@game.BowlName</span>
                                        @if (game.IsPlayoff)
                                        {
                                            <span class="badge bg-warning text-dark ms-1">Playoff</span>
                                        }
                                    </div>
                                    <div class="text-end">
                                        <div class="small fw-bold text-dark">
                                            @DateTimeHelper.ToCentral(game.StartTime).ToString("MMM d, h:mm tt") CT
                                        </div>
                                        <div class="small text-muted" style="font-size: 0.85em;">
                                            @game.Location 
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row g-2">
                                    <div class="col">
                                        <input type="radio" class="btn-check" name="@game.Id" id="@($"{game.Id}_home")" 
                                               checked="@(pick == slots.Home && slots.Home != "TBD")" 
                                               @onchange="@(() => UpdatePick(game.Id, slots.Home))" autocomplete="off">
                                        
                                        <label class="btn btn-outline-primary w-100 d-flex align-items-center justify-content-center h-100 @(pick == slots.Home && slots.Home != "TBD" ? "active fw-bold" : "")" 
                                               for="@($"{game.Id}_home")">
                                            @slots.Home
                                        </label>
                                    </div>

                                    <div class="col">
                                        <input type="radio" class="btn-check" name="@game.Id" id="@($"{game.Id}_away")" 
                                               checked="@(pick == slots.Away && slots.Away != "TBD")" 
                                               @onchange="@(() => UpdatePick(game.Id, slots.Away))" autocomplete="off">
                                        
                                        <label class="btn btn-outline-primary w-100 d-flex align-items-center justify-content-center h-100 @(pick == slots.Away && slots.Away != "TBD" ? "active fw-bold" : "")" 
                                               for="@($"{game.Id}_away")">
                                            @slots.Away
                                        </label>
                                    </div>
                                </div>
                            </li>
                        }
                    </ul>
                </div>

                @* TIEBREAKER *@
                <div class="card mb-4 shadow-sm border-warning">
                    <div class="card-body bg-warning bg-opacity-10">
                        @{
                            var pool = pools.FirstOrDefault(p => p.Id == entry.PoolId);
                            var tieBreakerGame = allGames.FirstOrDefault(g => g.Id == pool?.TieBreakerGameId);
                            string tbText = tieBreakerGame != null 
                                ? $"Tiebreaker: Total Points in {tieBreakerGame.BowlName} - {tieBreakerGame.TeamHome} vs {tieBreakerGame.TeamAway}"
                                : "Tiebreaker: Total Points";
                        }
                        <label class="form-label fw-bold text-dark">@tbText</label>
                        <InputNumber @bind-Value="entry.TieBreakerPoints" class="form-control" />
                    </div>
                </div>
            }

            <div class="d-grid gap-2 d-md-flex justify-content-md-end mb-5">
                <button type="button" class="btn btn-secondary me-2" @onclick="ResetForm" disabled="@isSaving">Clear / Reset</button>
                @if (!string.IsNullOrEmpty(EntryId))
                {
                    <button type="button" class="btn btn-danger me-2" @onclick="DeleteEntry" disabled="@isSaving"><i class="bi bi-trash"></i> Delete</button>
                }
                <button type="submit" class="btn btn-success btn-lg px-5" disabled="@isSaving">
                    @if (isSaving) { <span class="spinner-border spinner-border-sm me-2"></span><span>Saving...</span> }
                    else { <i class="bi bi-save"></i> <span>Save Entry</span> }
                </button>
            </div>
            
            @* AUDIT LOG *@
            @if (entry.AuditLog != null && entry.AuditLog.Any())
            {
                <div class="card mb-4 shadow-sm mt-4">
                    <div class="card-header bg-secondary text-white small py-1">
                        <i class="bi bi-clock-history me-1"></i> Audit Log
                    </div>
                    <div class="card-body bg-light p-2" style="max-height: 250px; overflow-y: auto; font-family: monospace; font-size: 0.85em;">
                        <ul class="list-unstyled mb-0">
                            @foreach (var log in entry.AuditLog.AsEnumerable().Reverse())
                            {
                                <li class="mb-1 border-bottom pb-1">@log</li>
                            }
                        </ul>
                    </div>
                </div>
            }
        </EditForm>
        
        @* MOVE MODAL *@
        @if (showMoveModal)
        {
            <div class="modal show d-block" style="background-color: rgba(0,0,0,0.5);">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Move Entry to Pool</h5>
                            <button type="button" class="btn-close" @onclick="() => showMoveModal = false"></button>
                        </div>
                        <div class="modal-body">
                            <p>Select the new pool for <strong>@entry.PlayerName</strong>:</p>
                            <select class="form-select" @bind="targetPoolId">
                                <option value="">-- Select Target Pool --</option>
                                @foreach (var p in pools.Where(p => p.Id != entry.PoolId))
                                {
                                    <option value="@p.Id">@p.Name</option>
                                }
                            </select>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" @onclick="() => showMoveModal = false">Cancel</button>
                            <button type="button" class="btn btn-warning" @onclick="ExecuteMove">Confirm Move</button>
                        </div>
                    </div>
                </div>
            </div>
        }

        @if (showToast)
        {
            <div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 1050">
                <div class="toast show align-items-center text-white bg-success border-0 shadow" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="d-flex">
                        <div class="toast-body fs-6"><i class="bi bi-check-circle-fill me-2"></i> @toastMessage</div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" @onclick="() => showToast = false"></button>
                    </div>
                </div>
            </div>
        }
    }
</div>

@code {
    [Parameter] public string? EntryId { get; set; }

    private List<BowlGame> allGames = new();
    private List<BowlPool> pools = new();
    private List<UserProfile> users = new();
    private BracketEntry entry = new BracketEntry();
    private string? statusMessage;
    private string? errorMessage;
    private bool isLoading = true;
    private bool isSaving = false;
    private bool showToast = false;
    private string toastMessage = "";
    
    // Move Modal
    private bool showMoveModal = false;
    private string targetPoolId = "";

    private List<BowlGame> ValidGames 
    {
        get 
        {
            if (string.IsNullOrEmpty(entry.PoolId)) return new List<BowlGame>();
            
            var targetPool = pools.FirstOrDefault(p => p.Id == entry.PoolId);
            if (targetPool != null && targetPool.GameIds != null && targetPool.GameIds.Any())
            {
                return allGames.Where(g => targetPool.GameIds.Contains(g.Id)).ToList();
            }
            
            return allGames;
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        try
        {
            isLoading = true;
            var gamesTask = Http.GetFromJsonAsync<List<BowlGame>>("api/GetGames");
            var poolsTask = Http.GetFromJsonAsync<List<BowlPool>>("api/GetPools");
            var usersTask = Http.GetFromJsonAsync<List<UserProfile>>("api/GetUsers"); // Fetch Users
            
            await Task.WhenAll(gamesTask, poolsTask, usersTask);
            
            allGames = await gamesTask ?? new();
            pools = await poolsTask ?? new();
            users = await usersTask ?? new();

            if (!string.IsNullOrEmpty(EntryId))
            {
                var existingEntry = await Http.GetFromJsonAsync<BracketEntry>($"api/GetEntry?id={EntryId}");
                if (existingEntry != null)
                {
                    entry = existingEntry;
                    if (entry.Picks == null) entry.Picks = new Dictionary<string, string>();
                }
                else
                {
                    errorMessage = "Entry not found.";
                }
            }
            else
            {
                // Set default pool if only one active exists
                var activePools = pools.Where(p => !p.IsArchived).ToList();
                if (activePools.Count == 1) entry.PoolId = activePools[0].Id;
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading data: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private void UpdatePick(string gameId, string selection) 
    { 
        if (entry.Picks == null) entry.Picks = new Dictionary<string, string>(); 
        if (string.IsNullOrEmpty(selection)) 
        { 
            if (entry.Picks.ContainsKey(gameId)) entry.Picks.Remove(gameId); 
        } 
        else 
        { 
            entry.Picks[gameId] = selection; 
        } 
        StateHasChanged(); 
    }

    private (string Home, string Away) GetMatchupSlots(BowlGame game)
    {
        string home = game.TeamHome;
        string away = game.TeamAway;

        if (game.IsPlayoff)
        {
             var feeders = allGames.Where(g => g.NextGameId == game.Id).OrderBy(g => g.StartTime).ToList();
             var feederQueue = new Queue<BowlGame>(feeders);

             if (string.IsNullOrWhiteSpace(home) || home.Equals("TBD", StringComparison.OrdinalIgnoreCase))
             {
                 if (feederQueue.TryDequeue(out var f1))
                 {
                     if (entry.Picks != null && entry.Picks.TryGetValue(f1.Id, out var w1)) home = w1;
                     else home = $"Winner of {f1.BowlName}";
                 }
                 else home = "TBD";
             }

             if (string.IsNullOrWhiteSpace(away) || away.Equals("TBD", StringComparison.OrdinalIgnoreCase))
             {
                 if (feederQueue.TryDequeue(out var f2))
                 {
                     if (entry.Picks != null && entry.Picks.TryGetValue(f2.Id, out var w2)) away = w2;
                     else away = $"Winner of {f2.BowlName}";
                 }
                 else away = "TBD";
             }
        }

        if (string.IsNullOrWhiteSpace(home)) home = "TBD";
        if (string.IsNullOrWhiteSpace(away)) away = "TBD";
        
        return (home, away);
    }

    private async Task ExecuteMove()
    {
        if (string.IsNullOrEmpty(targetPoolId)) return;
        
        try 
        {
            var response = await Http.PostAsync($"api/MoveEntry?entryId={entry.Id}&newPoolId={targetPoolId}", null);
            if (response.IsSuccessStatusCode)
            {
                entry.PoolId = targetPoolId; // Update local state
                showMoveModal = false;
                toastMessage = "Entry moved successfully.";
                showToast = true;
            }
            else 
            {
                string msg = await response.Content.ReadAsStringAsync();
                await JS.InvokeVoidAsync("alert", $"Move Failed: {msg}");
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error: {ex.Message}");
        }
    }

    private async Task HandleSave()
    {
        if (string.IsNullOrEmpty(entry.PoolId))
        {
            errorMessage = "Please select a pool.";
            return;
        }
        
        statusMessage = null; errorMessage = null; showToast = false; isSaving = true;
        try
        {
            // Use CreateEntry instead of SaveEntry
            var response = await Http.PostAsJsonAsync("api/CreateEntry", entry);
            if (response.IsSuccessStatusCode)
            {
                toastMessage = "Changes saved successfully!";
                showToast = true;
                if (string.IsNullOrEmpty(EntryId)) { statusMessage = $"Entry for {entry.PlayerName} saved!"; ResetForm(); }
                _ = Task.Delay(3000).ContinueWith(t => { showToast = false; InvokeAsync(StateHasChanged); });
            }
            else 
            { 
                 var errorText = await response.Content.ReadAsStringAsync();
                 errorMessage = $"Failed to save entry: {errorText}"; 
            }
        }
        catch (Exception ex) { errorMessage = $"Error: {ex.Message}"; }
        finally { isSaving = false; }
    }

    private async Task DeleteEntry()
    {
        if (string.IsNullOrEmpty(EntryId)) return;
        bool confirmed = await JS.InvokeAsync<bool>("confirm", $"Are you sure you want to delete the entry for {entry.PlayerName}?");
        if (confirmed) {
            isSaving = true;
            try {
                var response = await Http.DeleteAsync($"api/DeleteEntry?id={EntryId}");
                if (response.IsSuccessStatusCode) { Nav.NavigateTo("/admin/entries"); } else { errorMessage = "Error deleting entry."; }
            } catch(Exception ex) { errorMessage = $"Error: {ex.Message}"; } finally { isSaving = false; }
        }
    }

    private void ResetForm()
    {
        entry = new BracketEntry();
        // Re-apply default if only one active exists
        var activePools = pools.Where(p => !p.IsArchived).ToList();
        if (activePools.Count == 1) entry.PoolId = activePools[0].Id;
        
        if (!string.IsNullOrEmpty(EntryId)) { Nav.NavigateTo("/admin/entries"); }
    }
}
