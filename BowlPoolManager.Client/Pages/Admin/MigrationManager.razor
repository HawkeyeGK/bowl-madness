@page "/admin/migration"
@using BowlPoolManager.Core.Dtos
@using BowlPoolManager.Core.Domain
@using BowlPoolManager.Client.Services
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Roles = "SuperAdmin")]
@inject HttpClient Http
@inject IPoolService PoolService
@inject ISeasonService SeasonService
@inject IConfigurationService ConfigurationService
@inject IJSRuntime JS

<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="text-white mb-0">Migration Wizard</h3>
        @if (isLoading)
        {
            <div class="spinner-border text-light" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        }
    </div>

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @errorMessage
            <button type="button" class="btn-close" @onclick="() => errorMessage = null" aria-label="Close"></button>
        </div>
    }

    @if (currentStep == MigrationStep.Configuration)
    {
        <div class="card bg-dark text-white shadow-sm border-secondary mb-4">
            <div class="card-header bg-secondary bg-opacity-25 border-secondary">
                <h5 class="mb-0">Step 1: Configuration</h5>
            </div>
            <div class="card-body">
                <p class="card-text">
                    This wizard will scan the legacy database container for all Games, Pools, and Bracket Entries.
                    You will then be able to map historic Seasons, Pools, Games, and Teams to the new system structure.
                </p>
                <div class="alert alert-info border-0">
                    <i class="bi bi-info-circle me-2"></i>
                    Ensure your legacy connection string is configured in <code>local.settings.json</code> or App Configuration.
                </div>
            </div>

            @if (analysisResult != null && !analysisResult.LegacySeasonIds.Any()) 
            {
               <div class="alert alert-warning m-3">
                   <h6>No Seasons Found</h6>
                   <p>The analysis ran but found no season IDs. Here is the raw data from the first entry found (if any):</p>
                   <pre class="bg-dark text-light p-2 rounded">@analysisResult.DebugInfo</pre>
               </div>
            }
            <div class="card-footer bg-transparent border-secondary text-end">
                <button class="btn btn-primary" @onclick="AnalyzeLegacyData">
                    Analyze Legacy Data <i class="bi bi-arrow-right ms-1"></i>
                </button>
            </div>
        </div>
    }

    @if (currentStep == MigrationStep.SeasonMapping)
    {
        <div class="card bg-dark text-white shadow-sm border-secondary mb-4">
            <div class="card-header bg-secondary bg-opacity-25 border-secondary d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Step 2: Map Seasons</h5>
                <small class="text-light opacity-75">Found @analysisResult?.LegacySeasonIds?.Count legacy seasons</small>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-dark table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Legacy Season ID</th>
                                <th>Target Season</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var oldSid in analysisResult?.LegacySeasonIds ?? new List<string>())
                            {
                                <tr>
                                    <td>@oldSid</td>
                                    <td>
                                        <select class="form-select form-select-sm" @bind="seasonMapping[oldSid]">
                                            <option value="">-- Skip --</option>
                                            @if (seasons != null)
                                            {
                                                foreach (var s in seasons)
                                                {
                                                    // Auto-select if IDs match? optional improvement
                                                    <option value="@s.Id">@s.Name (@s.SeasonId)</option>
                                                }
                                            }
                                        </select>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="card-footer bg-transparent border-secondary d-flex justify-content-between">
                <button class="btn btn-outline-secondary" @onclick="() => currentStep = MigrationStep.Configuration">Back</button>
                <button class="btn btn-primary" @onclick="ProceedToPoolMapping">Next: Map Pools</button>
            </div>
        </div>
    }

    @if (currentStep == MigrationStep.PoolMapping)
    {
        <div class="card bg-dark text-white shadow-sm border-secondary mb-4">
            <div class="card-header bg-secondary bg-opacity-25 border-secondary d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Step 3: Map Pools</h5>
                <small class="text-light opacity-75">Found @analysisResult?.LegacyPools?.Count legacy pools</small>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-dark table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Legacy Season</th>
                                <th>Legacy Pool ID</th>
                                <th>Target Pool</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var legacyPool in analysisResult?.LegacyPools ?? new List<LegacyPoolDto>())
                            {
                                // Only show if the season is mapped
                                if (seasonMapping.TryGetValue(legacyPool.SeasonId, out var targetSid) && !string.IsNullOrEmpty(targetSid)) 
                                {
                                    <tr>
                                        <td>@legacyPool.SeasonId</td>
                                        <td>@legacyPool.PoolId</td>
                                        <td>
                                            <select class="form-select form-select-sm" @bind="poolMapping[legacyPool.PoolId]">
                                                <option value="">-- Select Pool --</option>
                                                @if (pools != null)
                                                {
                                                    foreach (var pool in pools.Where(p => p.SeasonId == targetSid))
                                                    {
                                                        <option value="@pool.Id">@pool.Name</option>
                                                    }
                                                }
                                            </select>
                                        </td>
                                    </tr>
                                }
                            }
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="card-footer bg-transparent border-secondary d-flex justify-content-between">
                <button class="btn btn-outline-secondary" @onclick="() => currentStep = MigrationStep.SeasonMapping">Back</button>
                <button class="btn btn-primary" @onclick="ProceedToGameMapping">Next: Map Games</button>
            </div>
        </div>
    }

    @if (currentStep == MigrationStep.GameMapping)
    {
        <div class="card bg-dark text-white shadow-sm border-secondary mb-4">
            <div class="card-header bg-secondary bg-opacity-25 border-secondary d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Step 4: Map Games</h5>
                <div>
                     <button class="btn btn-sm btn-outline-info me-2" @onclick="AutoMapGames">Auto-Map</button>
                     <small class="text-light opacity-75">Found @analysisResult?.LegacyGames.Count legacy games</small>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-dark table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Legacy Season</th>
                                <th>Legacy Game</th>
                                <th>Target Game</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var legacyGame in analysisResult?.LegacyGames ?? new List<LegacyGameDto>())
                            {
                                // Only show if game's season matches a mapped season
                                // Note: legacyGame.SeasonId needs to be used here
                                if (seasonMapping.TryGetValue(legacyGame.SeasonId, out var targetSid) && !string.IsNullOrEmpty(targetSid))
                                {
                                    <tr>
                                        <td>@legacyGame.SeasonId</td>
                                        <td>
                                            <div>@legacyGame.Description</div>
                                            <small class="text-muted">@legacyGame.StartTime.ToShortDateString()</small>
                                        </td>
                                        <td>
                                            <select class="form-select form-select-sm" @bind="gameMapping[legacyGame.Id]">
                                                <option value="">-- Skip --</option>
                                                @if (targetGames != null)
                                                {
                                                     // Filter target games by the mapped Target Season ID
                                                     foreach (var game in targetGames.Where(g => g.SeasonId == targetSid))
                                                     {
                                                        <option value="@game.Id">@game.BowlName: @game.TeamHome vs @game.TeamAway</option>
                                                     }
                                                }
                                            </select>
                                        </td>
                                    </tr>
                                }
                            }
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="card-footer bg-transparent border-secondary d-flex justify-content-between">
                <button class="btn btn-outline-secondary" @onclick="() => currentStep = MigrationStep.PoolMapping">Back</button>
                <button class="btn btn-primary" @onclick="() => currentStep = MigrationStep.TeamMapping">Next: Map Teams</button>
            </div>
        </div>
    }

    @if (currentStep == MigrationStep.TeamMapping)
    {
        <div class="card bg-dark text-white shadow-sm border-secondary mb-4">
            <div class="card-header bg-secondary bg-opacity-25 border-secondary d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Step 3: Map Teams</h5>
                 <div>
                     <button class="btn btn-sm btn-outline-info me-2" @onclick="AutoMapTeams">Auto-Clean Names</button>
                     <small class="text-light opacity-75">Found @analysisResult?.LegacyTeamNames.Count unique teams</small>
                </div>
            </div>
            <div class="card-body p-0">
                 <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
                    <table class="table table-dark table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Legacy Team Name</th>
                                <th>Target Team Name (New)</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var oldName in analysisResult?.LegacyTeamNames ?? new List<string>())
                            {
                                <tr>
                                    <td>@oldName</td>
                                    <td>
                                        <select class="form-select form-select-sm" @bind="teamMapping[oldName]">
                                            <option value="">-- Select Team --</option>
                                            @foreach (var team in AllTeams)
                                            {
                                                <option value="@team.School">@team.School</option>
                                            }
                                        </select>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
             <div class="card-footer bg-transparent border-secondary d-flex justify-content-between">
                <button class="btn btn-outline-secondary" @onclick="() => currentStep = MigrationStep.GameMapping">Back</button>
                <button class="btn btn-success" @onclick="ExecuteMigration">
                    <i class="bi bi-play-circle-fill me-1"></i> Execute Migration
                </button>
            </div>
        </div>
    }
    
    @if (currentStep == MigrationStep.Complete)
    {
         <div class="card bg-success text-white shadow-sm border-0 mb-4">
             <div class="card-body text-center p-5">
                 <i class="bi bi-check-circle-fill display-1 mb-3"></i>
                 <h2>Migration Complete!</h2>
                 <p class="lead">Successfully migrated entries.</p>
                 <div class="mt-4">
                     <h5>Summary:</h5>
                     <ul class="list-unstyled">
                         <li>Total Legacy Entries: @analysisResult?.LegacyEntryCount</li>
                         <li>Migrated: @migratedCount</li>
                     </ul>
                 </div>
                 <button class="btn btn-light mt-3" @onclick="ResetWizard">Start Over</button>
             </div>
         </div>
    }

</div>

@code {
    private enum MigrationStep { Configuration, SeasonMapping, PoolMapping, GameMapping, TeamMapping, Complete }
    private MigrationStep currentStep = MigrationStep.Configuration;

    private List<Season>? seasons;
    private List<BowlPool>? pools;
    private List<BowlGame>? targetGames; // Note: This might need to be a dictionary or loaded per mapping

    private string targetSeasonId = "";
    private string targetPoolId = "";
    
    private bool isLoading = false;
    private string? errorMessage;
    private string? executionSummary;

    private MigrationAnalysisResult? analysisResult;
    private Dictionary<string, string> seasonMapping = new();
    private Dictionary<string, string> poolMapping = new();
    private Dictionary<string, string> gameMapping = new();
    private Dictionary<string, string> teamMapping = new();
    
    private int migratedCount = 0;
    private List<TeamInfo> AllTeams = new();

    // private bool CanAnalyze => !string.IsNullOrEmpty(targetSeasonId) && !string.IsNullOrEmpty(targetPoolId);

    protected override async Task OnInitializedAsync()
    {
        try
        {
            isLoading = true;
            await LoadTeams();
            seasons = await SeasonService.GetSeasonsAsync();
            var poolsList = await PoolService.GetPoolsAsync();
            // Filter pools? maybe just show all or let user pick.
            pools = poolsList;
            
            // Default to most recent season
            /*
            if (seasons != null && seasons.Any())
            {
                var currentSeason = await SeasonService.GetCurrentSeasonAsync();
                if (currentSeason != null)
                {
                    targetSeasonId = currentSeason.Id;
                    // await LoadTargetGames(targetSeasonId);
                }
            }
            */
        }
        catch (Exception ex)
        {
            errorMessage = $"Error initializing: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    /*
    private async Task OnSeasonChanged(ChangeEventArgs e)
    {
        targetSeasonId = e.Value?.ToString() ?? "";
        if (!string.IsNullOrEmpty(targetSeasonId))
        {
            await LoadTargetGames(targetSeasonId);
        }
        else 
        {
            targetGames = null;
        }
    }
    */

    private async Task LoadTargetGames(string seasonId)
    {
        try 
        {
            targetGames = await PoolService.GetGamesAsync(seasonId);
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading games: {ex.Message}";
        }
    }

    private async Task LoadTeams()
    {
        try
        {
            AllTeams = await ConfigurationService.GetTeamsAsync() ?? new();
            AllTeams = AllTeams.OrderBy(t => t.School).ToList();
        }
        catch(Exception ex) 
        {
            errorMessage = $"Error loading teams: {ex.Message}";
        }
    }

    private async Task AnalyzeLegacyData()
    {
        try
        {
            isLoading = true;
            errorMessage = null;

            var request = new MigrationAnalysisRequest { SourceSeasonId = "2024" }; // Optional, currently unused by backend
            var response = await Http.PostAsJsonAsync("api/migration/analyze", request);

            if (response.IsSuccessStatusCode)
            {
                analysisResult = await response.Content.ReadFromJsonAsync<MigrationAnalysisResult>();
                if (analysisResult != null)
                {
                    // Initialize Mappings
                    seasonMapping = new Dictionary<string, string>();
                    if (analysisResult.LegacySeasonIds != null)
                    {
                        foreach (var sid in analysisResult.LegacySeasonIds)
                        {
                            seasonMapping[sid] = ""; // User must select
                        }
                    }

                    poolMapping = new Dictionary<string, string>(); // Will be populated in next step logic
                    gameMapping = new Dictionary<string, string>();
                    foreach (var game in analysisResult.LegacyGames)
                    {
                        gameMapping[game.Id] = ""; 
                    }

                    teamMapping = new Dictionary<string, string>();
                    foreach (var team in analysisResult.LegacyTeamNames)
                    {
                        teamMapping[team] = "";
                    }

                    currentStep = MigrationStep.SeasonMapping;
                }
            }
            else
            {
                errorMessage = $"Analysis failed: {response.ReasonPhrase}";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error analyzing data: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private void AutoMapGames()
    {
        if (targetGames == null || analysisResult == null) return;

        foreach (var legacyGame in analysisResult.LegacyGames)
        {
            // Simple heuristic mapping
            // Try to find a target game with similar Home/Away teams
            var match = targetGames.FirstOrDefault(tg => 
                (tg.TeamHome.Contains(legacyGame.HomeTeam, StringComparison.OrdinalIgnoreCase) || legacyGame.HomeTeam.Contains(tg.TeamHome, StringComparison.OrdinalIgnoreCase)) &&
                (tg.TeamAway.Contains(legacyGame.AwayTeam, StringComparison.OrdinalIgnoreCase) || legacyGame.AwayTeam.Contains(tg.TeamAway, StringComparison.OrdinalIgnoreCase))
            );
            
            if (match != null)
            {
                gameMapping[legacyGame.Id] = match.Id;
            }
        }
    }

    private void AutoMapTeams()
    {
        if (analysisResult == null || !AllTeams.Any()) return;

        foreach (var oldName in analysisResult.LegacyTeamNames)
        {
            // 1. Clean the name (remove leading seeds like "12 BYU" -> "BYU")
            var cleanName = oldName;
            var parts = oldName.Split(' ');
            if (parts.Length > 1 && int.TryParse(parts[0], out _))
            {
                cleanName = string.Join(" ", parts.Skip(1));
            } else if (parts.Length > 1 && parts[0].StartsWith("(") && parts[0].EndsWith(")"))
            {
                 // Handle (12) BYU style
                 cleanName = string.Join(" ", parts.Skip(1));
            }

            // 2. Try Exact Match
            var match = AllTeams.FirstOrDefault(t => t.School.Equals(cleanName, StringComparison.OrdinalIgnoreCase) || 
                                                     t.Abbreviation.Equals(cleanName, StringComparison.OrdinalIgnoreCase));

            // 3. Try Contains/Fuzzy
            if (match == null)
            {
                match = AllTeams.FirstOrDefault(t => t.School.Contains(cleanName, StringComparison.OrdinalIgnoreCase) || 
                                                     cleanName.Contains(t.School, StringComparison.OrdinalIgnoreCase));
            }
            
            // 4. Try Mascot
            if (match == null)
            {
                 match = AllTeams.FirstOrDefault(t => (t.Mascot != null && cleanName.Contains(t.Mascot, StringComparison.OrdinalIgnoreCase)));
            }
            
            if (match != null)
            {
                teamMapping[oldName] = match.School;
            }
        }
    }

    private void ProceedToPoolMapping() 
    {
        // Ensure keys exist for all legacy pools to prevent KeyNotFoundException in bind
        if (analysisResult?.LegacyPools != null)
        {
            foreach (var pool in analysisResult.LegacyPools)
            {
                if (!poolMapping.ContainsKey(pool.PoolId))
                {
                    poolMapping[pool.PoolId] = "";
                }
            }
        }
        currentStep = MigrationStep.PoolMapping;
    }

    private async Task ProceedToGameMapping() 
    {
        // Load target games for all selected target seasons
        isLoading = true;
        try 
        {
            var distinctTargetSeasons = seasonMapping.Values.Where(v => !string.IsNullOrEmpty(v)).Distinct();
            targetGames = new List<BowlGame>();
            
            foreach(var sid in distinctTargetSeasons)
            {
               var games = await PoolService.GetGamesAsync(sid);
               if (games != null) targetGames.AddRange(games);
            }
        }
        catch(Exception ex)
        {
            errorMessage = $"Error loading target games: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }

        currentStep = MigrationStep.GameMapping;
    }

    private async Task ExecuteMigration()
    {
        if (!await JS.InvokeAsync<bool>("confirm", "Are you sure you want to execute migrations? Use Test Data first to verify.")) return;

        try
        {
            isLoading = true;
            errorMessage = null;

            var request = new MigrationExecutionRequest
            {
                TargetPoolId = targetPoolId,
                TargetSeasonId = targetSeasonId,
                SeasonMapping = seasonMapping, // Added
                PoolMapping = poolMapping,
                GameMapping = gameMapping,
                TeamMapping = teamMapping
            };

            var response = await Http.PostAsJsonAsync("api/migration/execute", request);
            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<dynamic>();
                migratedCount = (int)result.GetProperty("migratedCount").GetInt32();
                executionSummary = $"Migration Completed! Migrated: {migratedCount}, Errors: {result.GetProperty("errorCount")}";
                currentStep = MigrationStep.Complete;
            }
            else 
            {
                errorMessage = $"Migration failed: {response.ReasonPhrase}";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error executing migration: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }
 
    private void ResetWizard()
    {
        currentStep = MigrationStep.Configuration;
        analysisResult = null;
        seasonMapping.Clear();
        poolMapping.Clear();
        gameMapping.Clear();
        teamMapping.Clear();
        migratedCount = 0;
    }
}
