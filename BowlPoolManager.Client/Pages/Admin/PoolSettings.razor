@page "/admin/pools"
@using Microsoft.AspNetCore.Authorization
@using BowlPoolManager.Core.Domain
@using BowlPoolManager.Client.Helpers
@attribute [Authorize(Roles = "SuperAdmin")]
@inject HttpClient Http

<PageTitle>Pool Administration</PageTitle>

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="text-primary"><i class="bi bi-collection-play me-2"></i>Pool Settings</h2>
        <button class="btn btn-sm btn-outline-success" @onclick="CreateNewPool">
            <i class="bi bi-plus-lg"></i> New Pool
        </button>
    </div>

    @if (IsLoading)
    {
        <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>
    }
    else
    {
        <div class="table-responsive shadow-sm">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Name</th>
                        <th>Season</th>
                        <th>Invite Code</th>
                        <th>Lock Date (Central)</th>
                        <th>Status</th>
                        <th class="text-end">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var pool in Pools.OrderByDescending(p => p.Season))
                    {
                        <tr>
                            <td>
                                @if (EditingPool == pool)
                                {
                                    <input type="text" class="form-control form-control-sm" @bind="pool.Name" placeholder="Pool Name" />
                                }
                                else
                                {
                                    <span class="fw-bold">@pool.Name</span>
                                }
                            </td>
                            <td>
                                @if (EditingPool == pool)
                                {
                                    <input type="number" class="form-control form-control-sm" style="width: 80px;" @bind="pool.Season" />
                                }
                                else
                                {
                                    @pool.Season
                                }
                            </td>
                            <td>
                                @if (EditingPool == pool)
                                {
                                    <input type="text" class="form-control form-control-sm" @bind="pool.InviteCode" placeholder="Code" />
                                }
                                else
                                {
                                    <code class="text-primary">@pool.InviteCode</code>
                                }
                            </td>
                            <td>
                                @if (EditingPool == pool)
                                {
                                     <input type="datetime-local" class="form-control form-control-sm" value="@BindLockDate(pool)" @onchange="@((ChangeEventArgs e) => UpdateLockDate(pool, e.Value?.ToString()))" />
                                }
                                else
                                {
                                    @DateTimeHelper.ToCentral(pool.LockDate).ToString("g")
                                }
                            </td>
                            <td>
                                @if (DateTime.UtcNow > pool.LockDate)
                                {
                                    <span class="badge bg-danger">Locked</span>
                                }
                                else
                                {
                                    <span class="badge bg-success">Open</span>
                                }
                            </td>
                            <td class="text-end">
                                @if (EditingPool == pool)
                                {
                                    <button class="btn btn-sm btn-success me-1" @onclick="() => SavePool(pool)">
                                        <i class="bi bi-check-lg"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary" @onclick="CancelEdit">
                                        <i class="bi bi-x-lg"></i>
                                    </button>
                                }
                                else
                                {
                                    <button class="btn btn-sm btn-outline-primary" @onclick="() => EditPool(pool)">
                                        <i class="bi bi-pencil"></i> Edit
                                    </button>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>

@code {
    private bool IsLoading = false;
    private List<BowlPool> Pools = new();
    private BowlPool? EditingPool = null;

    protected override async Task OnInitializedAsync()
    {
        await LoadPools();
    }

    private async Task LoadPools()
    {
        IsLoading = true;
        try
        {
            Pools = await Http.GetFromJsonAsync<List<BowlPool>>("api/GetPools") ?? new();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading pools: {ex.Message}");
        }
        finally
        {
            IsLoading = false;
        }
    }

    private void CreateNewPool()
    {
        var newPool = new BowlPool 
        { 
            Id = Guid.NewGuid().ToString(), 
            Name = $"Bowl Madness {DateTime.Now.Year + 1}", 
            Season = DateTime.Now.Year + 1, 
            LockDate = DateTime.UtcNow.AddDays(14),
            InviteCode = "BOWL" + (DateTime.Now.Year + 1)
        };
        Pools.Insert(0, newPool);
        EditingPool = newPool;
    }

    private void EditPool(BowlPool pool)
    {
        EditingPool = pool;
    }

    private void CancelEdit()
    {
        EditingPool = null;
        _ = LoadPools(); 
    }

    private string BindLockDate(BowlPool pool)
    {
        return DateTimeHelper.ToCentral(pool.LockDate).ToString("yyyy-MM-ddTHH:mm");
    }

    private void UpdateLockDate(BowlPool pool, string? val)
    {
        if (DateTime.TryParse(val, out DateTime localDt))
        {
            pool.LockDate = DateTimeHelper.FromCentral(localDt);
        }
    }

    private async Task SavePool(BowlPool pool)
    {
        try
        {
            var response = await Http.PostAsJsonAsync("api/CreatePool", pool);
            if (response.IsSuccessStatusCode)
            {
                EditingPool = null;
            }
            else
            {
                Console.WriteLine("Save failed");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error saving pool: {ex.Message}");
        }
    }
}
