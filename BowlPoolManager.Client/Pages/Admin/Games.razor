@page "/admin/games"
@using BowlPoolManager.Core.Domain
@using BowlPoolManager.Core
@using BowlPoolManager.Client.Helpers
@using Microsoft.AspNetCore.Authorization
@using System.Net.Http.Json
@using System.Text.Json
@using Microsoft.JSInterop
@attribute [Authorize(Roles = Constants.Roles.SuperAdmin)]
@inject HttpClient Http
@inject IJSRuntime JS

<PageTitle>Game Management</PageTitle>

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Bowl Game Schedule</h1>
        <span class="badge bg-danger">Super Admin Zone</span>
    </div>

    @* ID for Anchor Scrolling *@
    <div id="gameEditor" class="card mb-5 shadow-sm">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0">@(string.IsNullOrEmpty(newGame.Id) || newGame.Id == Guid.Empty.ToString() ? "Add Game" : "Edit Game")</h5>
        </div>
        <div class="card-body">
            <EditForm Model="@newGame" OnValidSubmit="HandleSaveGame">
                <DataAnnotationsValidator />
                
                <div class="row g-3 mb-3">
                    <div class="col-md-3">
                        <label for="bowlName" class="form-label">Bowl Name</label>
                        <InputText id="bowlName" class="form-control" @bind-Value="newGame.BowlName" placeholder="e.g. Potato Bowl" />
                    </div>
                    
                    <div class="col-md-6">
                        <label for="startTime" class="form-label">Start Time (Central)</label>
                        <InputText id="startTime" class="form-control" @bind-Value="startTimeString" type="datetime-local" />
                    </div>

                    <div class="col-md-3">
                        <label for="pointValue" class="form-label">Points</label>
                        <InputNumber id="pointValue" class="form-control" @bind-Value="newGame.PointValue" />
                    </div>
                </div>

                <div class="row g-3 mb-3">
                    <div class="col-md-3">
                        <label for="teamHome" class="form-label">Home Team</label>
                        <InputText id="teamHome" class="form-control" @bind-Value="newGame.TeamHome" placeholder="Home Team" />
                    </div>
                    <div class="col-md-3">
                        <label for="teamAway" class="form-label">Away Team</label>
                        <InputText id="teamAway" class="form-control" @bind-Value="newGame.TeamAway" placeholder="Away Team" />
                    </div>
                    <div class="col-md-3">
                        <label for="location" class="form-label">Location</label>
                        <InputText id="location" class="form-control" @bind-Value="newGame.Location" placeholder="Stadium/City" />
                    </div>
                    <div class="col-md-3">
                        <label for="television" class="form-label">Television</label>
                        <InputText id="television" class="form-control" @bind-Value="newGame.Television" placeholder="Network" />
                    </div>
                </div>

                <div class="form-check form-switch mb-3">
                    <InputCheckbox id="isPlayoff" class="form-check-input" @bind-Value="newGame.IsPlayoff" />
                    <label class="form-check-label fw-bold" for="isPlayoff">Is Playoff Game?</label>
                </div>

                @if (newGame.IsPlayoff)
                {
                    <div class="p-3 mb-3 border rounded bg-light">
                        <h6 class="text-primary mb-3">Playoff Configuration</h6>
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label for="round" class="form-label">Round</label>
                                <InputSelect id="round" class="form-select" @bind-Value="newGame.Round">
                                    <option value="@PlayoffRound.Round1">Round 1 (First Round)</option>
                                    <option value="@PlayoffRound.QuarterFinal">Round 2 (Quarterfinals)</option>
                                    <option value="@PlayoffRound.SemiFinal">Round 3 (Semifinals)</option>
                                    <option value="@PlayoffRound.Championship">Round 4 (Championship)</option>
                                </InputSelect>
                            </div>

                            <div class="col-md-2">
                                <label for="homeSeed" class="form-label">Home Seed</label>
                                <InputNumber id="homeSeed" class="form-control" @bind-Value="newGame.TeamHomeSeed" />
                            </div>
                            <div class="col-md-2">
                                <label for="awaySeed" class="form-label">Away Seed</label>
                                <InputNumber id="awaySeed" class="form-control" @bind-Value="newGame.TeamAwaySeed" />
                            </div>
                            <div class="col-12 mt-1">
                                <div class="form-text text-muted small">
                                    <i class="bi bi-info-circle"></i> Enter seeds for Round 1 or Bye teams. Leave blank if the team is determined by a previous game result.
                                </div>
                            </div>

                            <div class="col-md-5">
                                <label for="nextGame" class="form-label">Winner Advances To</label>
                                <InputSelect id="nextGame" class="form-select" @bind-Value="newGame.NextGameId">
                                    <option value="">-- Unlinked / Select Later --</option>
                                    @if (games != null)
                                    {
                                        @foreach (var g in games.Where(x => x.Id != newGame.Id).OrderBy(x => x.StartTime))
                                        {
                                            <option value="@g.Id">@g.BowlName</option>
                                        }
                                    }
                                </InputSelect>
                            </div>
                        </div>
                    </div>
                }

                <div class="mt-3 text-end">
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-save"></i> Save Game
                    </button>
                    <button type="button" class="btn btn-secondary ms-2" @onclick="ResetForm">
                        Reset
                    </button>
                </div>
            </EditForm>
        </div>
    </div>

    <h3 class="mb-3">All Bowl Games</h3>
    @if (games == null)
    {
        <div class="alert alert-info">Loading games...</div>
    }
    else if (!games.Any())
    {
        <div class="alert alert-warning">No games have been scheduled yet.</div>
    }
    else
    {
        <div class="table-responsive">
            <table class="table table-striped table-hover border align-middle">
                <thead class="table-light">
                    <tr>
                        <th>Game</th>
                        <th>Matchup</th>
                        <th>Time (Central)</th>
                        <th>Loc/TV</th>
                        <th>Pts</th>
                        <th>Details</th>
                        <th class="text-end">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var game in games)
                    {
                        var isFuture = game.StartTime > DateTime.UtcNow;
                        <tr class="@(game.IsPlayoff ? "table-warning" : "")">
                            <td>
                                <strong>@game.BowlName</strong>
                                @if(game.IsPlayoff)
                                {
                                    <div class="small text-muted">Round @((int)game.Round)</div>
                                }
                            </td>
                            <td>
                                <div>
                                    @if(game.TeamHomeSeed.HasValue) { <span class="badge bg-secondary me-1">@game.TeamHomeSeed</span> }
                                    @game.TeamHome
                                </div>
                                <div class="text-muted small">vs</div>
                                <div>
                                    @if(game.TeamAwaySeed.HasValue) { <span class="badge bg-secondary me-1">@game.TeamAwaySeed</span> }
                                    @game.TeamAway
                                </div>
                            </td>
                            <td>
                                @DateTimeHelper.ToCentral(game.StartTime).ToString("MMM d, h:mm tt") CT
                            </td>
                            <td>
                                <div class="small"><i class="bi bi-geo-alt"></i> @game.Location</div>
                                <div class="small"><i class="bi bi-tv"></i> @game.Television</div>
                            </td>
                            <td>@game.PointValue</td>
                            <td class="small">
                                @if(game.IsPlayoff && !string.IsNullOrEmpty(game.NextGameId))
                                {
                                    // Try to find name of next game
                                    var next = games.FirstOrDefault(x => x.Id == game.NextGameId);
                                    if(next != null)
                                    {
                                        <div><i class="bi bi-arrow-right"></i> @next.BowlName</div>
                                    }
                                }
                                else if (game.IsPlayoff && game.Round != PlayoffRound.Championship) 
                                {
                                    <span class="badge bg-danger">Unlinked</span>
                                }
                                else if (game.IsPlayoff)
                                {
                                    <span class="text-muted">Championship</span>
                                }
                                else
                                {
                                    <span class="badge bg-light text-dark border">Standard</span>
                                }
                            </td>
                            <td class="text-end">
                                <button class="btn btn-sm btn-outline-primary" @onclick="() => EditGame(game)">Edit</button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>

@code {
    private List<BowlGame>? games;
    private BowlGame newGame = new BowlGame { PointValue = 1 };
    
    // Initialize to tomorrow at noon Central
    private string startTimeString = "";

    protected override async Task OnInitializedAsync()
    {
        ResetForm();
        await LoadGames();
    }

    private void ResetForm()
    {
        newGame = new BowlGame { PointValue = 1 };
        var tomorrowCentral = DateTimeHelper.ToCentral(DateTime.UtcNow.AddDays(1));
        startTimeString = tomorrowCentral.ToString("yyyy-MM-ddTHH:mm");
        StateHasChanged();
    }

    private async Task LoadGames()
    {
        try
        {
            games = await Http.GetFromJsonAsync<List<BowlGame>>("api/GetGames");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[Game Admin] Error loading games: {ex.Message}");
        }
    }

    private async Task EditGame(BowlGame game)
    {
        var json = JsonSerializer.Serialize(game);
        newGame = JsonSerializer.Deserialize<BowlGame>(json) ?? new BowlGame();

        var centralTime = DateTimeHelper.ToCentral(newGame.StartTime);
        startTimeString = centralTime.ToString("yyyy-MM-ddTHH:mm");

        // UI FIX: Scroll to the top so the user sees the form
        await JS.InvokeVoidAsync("window.scrollTo", 0, 0);
        StateHasChanged();
    }

    private async Task HandleSaveGame()
    {
        // 1. Manually update StartTime from the InputText string
        if (DateTime.TryParse(startTimeString, out DateTime parsedLocal))
        {
            // REFACTORED: Use Helper to convert "wall clock" Central time back to UTC
            newGame.StartTime = DateTimeHelper.FromCentral(parsedLocal);
        }
        else
        {
            Console.WriteLine("Invalid Date/Time entered.");
            return;
        }

        try 
        {
            var response = await Http.PostAsJsonAsync("api/SaveGame", newGame);
            if (response.IsSuccessStatusCode)
            {
                ResetForm();
                await LoadGames();
                // UI FIX: Feedback scroll
                await JS.InvokeVoidAsync("window.scrollTo", 0, 0);
            }
            else
            {
                Console.WriteLine($"[Game Admin] Game save failed: {response.StatusCode}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[Game Admin] Error saving game: {ex.Message}");
        }
    }
}
