@page "/admin/games"
@using BowlPoolManager.Core.Domain
@using BowlPoolManager.Core

@using BowlPoolManager.Client.Services
@using Microsoft.AspNetCore.Authorization
@using System.Net.Http.Json
@using System.Text.Json
@using Microsoft.JSInterop
@attribute [Authorize(Roles = Constants.Roles.SuperAdmin)]
@inject HttpClient Http
@inject IJSRuntime JS
@inject ISeasonService SeasonService
@inject IConfigurationService ConfigurationService


<PageTitle>Game Management</PageTitle>

<div class="container-fluid mt-3 px-4">
    <div class="d-flex justify-content-between align-items-end mb-3">
        <div class="d-flex flex-column gap-2">
            <div class="d-flex align-items-center gap-3">
                <h1 class="h3 fw-bold mb-0"><i class="bi bi-calendar-event text-primary"></i> Bowl Game Schedule</h1>
            </div>
        </div>
        <span class="badge bg-danger">Super Admin Zone</span>
    </div>

    @* Season Selector *@
    <div class="row mb-4">
        <div class="col-md-4">
            <label class="form-label fw-bold">Select Season:</label>
            <select class="form-select" value="@selectedSeasonId" @onchange="OnSeasonChanged">
                @if (seasons != null)
                {
                    @foreach (var s in seasons)
                    {
                        <option value="@s.Id">@s.Name</option>
                    }
                }
            </select>
        </div>
    </div>

    @* ID for Anchor Scrolling *@
    <div id="gameEditor" class="card mb-5 shadow-sm">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0">@(string.IsNullOrEmpty(newGame.Id) || newGame.Id == Guid.Empty.ToString() ? "Add Game" : "Edit Game")</h5>
        </div>
        <div class="card-body">
            <EditForm Model="@newGame" OnValidSubmit="HandleSaveGame">
                <DataAnnotationsValidator />
                
                <div class="row g-3 mb-3">
                    <div class="col-md-3">
                        <label for="bowlName" class="form-label">Bowl Name</label>
                        <InputText id="bowlName" class="form-control" @bind-Value="newGame.BowlName" placeholder="e.g. Potato Bowl" />
                    </div>
                    
                    <div class="col-md-6">
                        <label for="startTime" class="form-label">Start Time (Central)</label>
                        <InputText id="startTime" class="form-control" @bind-Value="startTimeString" type="datetime-local" />
                    </div>

                    <div class="col-md-3">
                        <label for="pointValue" class="form-label">Points</label>
                        <InputNumber id="pointValue" class="form-control" @bind-Value="newGame.PointValue" />
                    </div>
                </div>

                <div class="row g-3 mb-3">
                    <div class="col-md-3">
                        <label for="teamHome" class="form-label">Home Team</label>
                        <div class="input-group">
                            <select id="teamHome" class="form-select" value="@newGame.TeamHomeId" @onchange="OnHomeTeamChanged">
                                <option value="">-- Select Team --</option>
                                @foreach (var team in AllTeams)
                                {
                                    <option value="@team.SchoolId">@team.School</option>
                                }
                            </select>
                            <button type="button" class="btn btn-outline-danger" @onclick="ClearHomeTeam" title="Clear Home Team">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </div>
                        @* Fallback/Display for verification *@
                        <div class="form-text text-muted small">
                            Selected: @(string.IsNullOrEmpty(newGame.TeamHome) ? "None" : newGame.TeamHome)
                        </div>
                    </div>
                    <div class="col-md-3">
                        <label for="teamAway" class="form-label">Away Team</label>
                        <div class="input-group">
                            <select id="teamAway" class="form-select" value="@newGame.TeamAwayId" @onchange="OnAwayTeamChanged">
                                <option value="">-- Select Team --</option>
                                @foreach (var team in AllTeams)
                                {
                                    <option value="@team.SchoolId">@team.School</option>
                                }
                            </select>
                            <button type="button" class="btn btn-outline-danger" @onclick="ClearAwayTeam" title="Clear Away Team">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </div>
                         <div class="form-text text-muted small">
                            Selected: @(string.IsNullOrEmpty(newGame.TeamAway) ? "None" : newGame.TeamAway)
                        </div>
                    </div>
                    <div class="col-md-3">
                        <label for="location" class="form-label">Location</label>
                        <InputText id="location" class="form-control" @bind-Value="newGame.Location" placeholder="Stadium/City" />
                    </div>
                    <div class="col-md-3">
                        <label for="television" class="form-label">Television</label>
                        <InputText id="television" class="form-control" @bind-Value="newGame.Television" placeholder="Network" />
                    </div>
                </div>

                <div class="form-check form-switch mb-3">
                    <InputCheckbox id="isPlayoff" class="form-check-input" @bind-Value="newGame.IsPlayoff" />
                    <label class="form-check-label fw-bold" for="isPlayoff">Is Playoff Game?</label>
                </div>

                @if (newGame.IsPlayoff)
                {
                    <div class="p-3 mb-3 border rounded bg-light">
                        <h6 class="text-primary mb-3">Playoff Configuration</h6>
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label for="round" class="form-label">Round</label>
                                <InputSelect id="round" class="form-select" @bind-Value="newGame.Round">
                                    <option value="@PlayoffRound.Round1">Round 1 (First Round)</option>
                                    <option value="@PlayoffRound.QuarterFinal">Round 2 (Quarterfinals)</option>
                                    <option value="@PlayoffRound.SemiFinal">Round 3 (Semifinals)</option>
                                    <option value="@PlayoffRound.Championship">Round 4 (Championship)</option>
                                </InputSelect>
                            </div>

                            <div class="col-md-2">
                                <label for="homeSeed" class="form-label">Home Seed</label>
                                <InputNumber id="homeSeed" class="form-control" @bind-Value="newGame.TeamHomeSeed" />
                            </div>
                            <div class="col-md-2">
                                <label for="awaySeed" class="form-label">Away Seed</label>
                                <InputNumber id="awaySeed" class="form-control" @bind-Value="newGame.TeamAwaySeed" />
                            </div>
                            <div class="col-12 mt-1">
                                <div class="form-text text-muted small">
                                    <i class="bi bi-info-circle"></i> Enter seeds for Round 1 or Bye teams. Leave blank if the team is determined by a previous game result.
                                </div>
                            </div>

                            <div class="col-md-5">
                                <label for="nextGame" class="form-label">Winner Advances To</label>
                                <InputSelect id="nextGame" class="form-select" @bind-Value="newGame.NextGameId">
                                    <option value="">-- Unlinked / Select Later --</option>
                                    @if (games != null)
                                    {
                                        @foreach (var g in games.Where(x => x.Id != newGame.Id).OrderBy(x => x.StartTime))
                                        {
                                            <option value="@g.Id">@g.BowlName</option>
                                        }
                                    }
                                </InputSelect>
                            </div>
                        </div>
                    </div>
                }

                <div class="mt-3 text-end">
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-save"></i> Save Game
                    </button>
                    <button type="button" class="btn btn-secondary ms-2" @onclick="ResetForm">
                        Reset
                    </button>
                </div>
            </EditForm>
        </div>
    </div>

    <h3 class="mb-3">All Bowl Games</h3>
    @if (games == null)
    {
        <div class="alert alert-info">Loading games...</div>
    }
    else if (!games.Any())
    {
        <div class="alert alert-warning">No games have been scheduled yet.</div>
    }
    else
    {
        <div class="table-responsive">
            <table class="table table-striped table-hover border align-middle">
                <thead class="table-light">
                    <tr>
                        <th>Game</th>
                        <th>Matchup</th>
                        <th>Time (Central)</th>
                        <th>Loc/TV</th>
                        <th>Pts</th>
                        <th>Details</th>
                        <th class="text-end">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var game in games)
                    {
                        var isFuture = game.StartTime > DateTime.UtcNow;
                        <tr class="@(game.IsPlayoff ? "table-warning" : "")">
                            <td>
                                <strong>@game.BowlName</strong>
                                @if(game.IsPlayoff)
                                {
                                    <div class="small text-muted">Round @((int)game.Round)</div>
                                }
                            </td>
                            <td>
                                <div>
                                    @if(game.TeamHomeSeed.HasValue) { <span class="badge bg-secondary me-1">@game.TeamHomeSeed</span> }
                                    @game.TeamHome
                                </div>
                                <div class="text-muted small">vs</div>
                                <div>
                                    @if(game.TeamAwaySeed.HasValue) { <span class="badge bg-secondary me-1">@game.TeamAwaySeed</span> }
                                    @game.TeamAway
                                </div>
                            </td>
                            <td>
                                @DateTimeHelper.ToCentral(game.StartTime).ToString("MMM d, yyyy, h:mm tt") CT
                            </td>
                            <td>
                                <div class="small"><i class="bi bi-geo-alt"></i> @game.Location</div>
                                <div class="small"><i class="bi bi-tv"></i> @game.Television</div>
                            </td>
                            <td>@game.PointValue</td>
                            <td class="small">
                                @if(game.IsPlayoff && !string.IsNullOrEmpty(game.NextGameId))
                                {
                                    // Try to find name of next game
                                    var next = games.FirstOrDefault(x => x.Id == game.NextGameId);
                                    if(next != null)
                                    {
                                        <div><i class="bi bi-arrow-right"></i> @next.BowlName</div>
                                    }
                                }
                                else if (game.IsPlayoff && game.Round != PlayoffRound.Championship) 
                                {
                                    <span class="badge bg-danger">Unlinked</span>
                                }
                                else if (game.IsPlayoff)
                                {
                                    <span class="text-muted">Championship</span>
                                }
                                else
                                {
                                    <span class="badge bg-light text-dark border">Standard</span>
                                }
                            </td>
                            <td class="text-end">
                                <button class="btn btn-sm btn-outline-primary me-1" @onclick="() => EditGame(game)">Edit</button>
                                <button class="btn btn-sm btn-outline-danger" @onclick="() => DeleteGame(game)">Delete</button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>

@code {
    private List<BowlGame>? games;
    private List<Season>? seasons;
    private List<TeamInfo> AllTeams = new(); // Packet 3
    private string selectedSeasonId = "";
    private BowlGame newGame = new BowlGame { PointValue = 1 };
    
    // Initialize to tomorrow at noon Central
    private string startTimeString = "";

    protected override async Task OnInitializedAsync()
    {
        await LoadSeasons();
        
        // Parallel load
        var gamesTask = LoadGames();
        var teamsTask = LoadTeams();
        await Task.WhenAll(gamesTask, teamsTask);

        ResetForm();
    }

    private void ResetForm()
    {
        newGame = new BowlGame { PointValue = 1 };
        // Default to selected season if available
        if (!string.IsNullOrEmpty(selectedSeasonId))
        {
            newGame.SeasonId = selectedSeasonId;
        }
        var tomorrowCentral = DateTimeHelper.ToCentral(DateTime.UtcNow.AddDays(1));
        startTimeString = tomorrowCentral.ToString("yyyy-MM-ddTHH:mm");
        StateHasChanged();
    }

    private async Task LoadGames()
    {
        try
        {
            var url = "api/GetGames";
            if (!string.IsNullOrEmpty(selectedSeasonId))
            {
                url += $"?seasonId={selectedSeasonId}";
            }
            games = await Http.GetFromJsonAsync<List<BowlGame>>(url);
            if (games != null)
            {
                games = games.OrderBy(g => g.StartTime).ToList();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[Game Admin] Error loading games: {ex.Message}");
        }
    }

    private async Task LoadTeams()
    {
        try
        {
            AllTeams = await ConfigurationService.GetTeamsAsync() ?? new();
            AllTeams = AllTeams.OrderBy(t => t.School).ToList();
        }
        catch(Exception ex) 
        {
             Console.WriteLine($"[Game Admin] Error loading teams: {ex.Message}");
        }
    }

    private async Task LoadSeasons()
    {
        try
        {
            seasons = await SeasonService.GetSeasonsAsync();
            var current = seasons.FirstOrDefault(s => s.IsCurrent);
            if (current != null)
            {
                selectedSeasonId = current.Id;
            }
            else if (seasons.Any())
            {
                selectedSeasonId = seasons.First().Id;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[Game Admin] Error loading seasons: {ex.Message}");
        }
    }

    private async Task OnSeasonChanged(ChangeEventArgs e)
    {
        selectedSeasonId = e.Value?.ToString() ?? "";
        await LoadGames();
        ResetForm(); // Update the new game SeasonId default
    }

    private void OnHomeTeamChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int id))
        {
            var team = AllTeams.FirstOrDefault(t => t.SchoolId == id);
            if (team != null)
            {
                newGame.TeamHomeId = team.SchoolId;
                newGame.TeamHome = team.School;
                newGame.HomeTeamInfo = team.ToDenormalized();
            }
        }
        else
        {
            // Reset if empty
            newGame.TeamHomeId = null;
            newGame.TeamHome = "";
            newGame.HomeTeamInfo = null;
        }
    }

    private void OnAwayTeamChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int id))
        {
            var team = AllTeams.FirstOrDefault(t => t.SchoolId == id);
            if (team != null)
            {
                newGame.TeamAwayId = team.SchoolId;
                newGame.TeamAway = team.School;
                newGame.AwayTeamInfo = team.ToDenormalized();
            }
        }
        else
        {
             // Reset if empty
            newGame.TeamAwayId = null;
            newGame.TeamAway = "";
            newGame.AwayTeamInfo = null;
        }
    }

    private void ClearHomeTeam()
    {
        newGame.TeamHomeId = null;
        newGame.TeamHome = "";
        newGame.HomeTeamInfo = null;
        newGame.TeamHomeSeed = null;
    }

    private void ClearAwayTeam()
    {
        newGame.TeamAwayId = null;
        newGame.TeamAway = "";
        newGame.AwayTeamInfo = null;
        newGame.TeamAwaySeed = null;
    }

    private async Task EditGame(BowlGame game)
    {
        var json = JsonSerializer.Serialize(game);
        newGame = JsonSerializer.Deserialize<BowlGame>(json) ?? new BowlGame();

        var centralTime = DateTimeHelper.ToCentral(newGame.StartTime);
        startTimeString = centralTime.ToString("yyyy-MM-ddTHH:mm");

        // UI FIX: Scroll to the top so the user sees the form
        await JS.InvokeVoidAsync("window.scrollTo", 0, 0);
        StateHasChanged();
    }

    private async Task HandleSaveGame()
    {
        // 1. Manually update StartTime from the InputText string
        if (DateTime.TryParse(startTimeString, out DateTime parsedLocal))
        {
            // REFACTORED: Use Helper to convert "wall clock" Central time back to UTC
            newGame.StartTime = DateTimeHelper.FromCentral(parsedLocal);
        }
        else
        {
            Console.WriteLine("Invalid Date/Time entered.");
            return;
        }

        try 
        {
            var response = await Http.PostAsJsonAsync("api/SaveGame", newGame);
            if (response.IsSuccessStatusCode)
            {
                ResetForm();
                await LoadGames();
                // UI FIX: Feedback scroll
                await JS.InvokeVoidAsync("window.scrollTo", 0, 0);
            }
            else
            {
                Console.WriteLine($"[Game Admin] Game save failed: {response.StatusCode}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[Game Admin] Error saving game: {ex.Message}");
        }
    }

    private async Task DeleteGame(BowlGame game)
    {
        var confirmed = await JS.InvokeAsync<bool>("confirm", $"Are you sure you want to delete '{game.BowlName}'? This action cannot be undone.");
        if (!confirmed) return;

        try
        {
            var response = await Http.DeleteAsync($"api/DeleteGame/{game.Id}?seasonId={game.SeasonId}");
            if (response.IsSuccessStatusCode)
            {
                await LoadGames();
            }
            else
            {
                Console.WriteLine($"[Game Admin] Game delete failed: {response.StatusCode}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[Game Admin] Error deleting game: {ex.Message}");
        }
    }
}
