@page "/admin/games"
@using BowlPoolManager.Core.Domain
@using BowlPoolManager.Core
@using Microsoft.AspNetCore.Authorization
@using System.Net.Http.Json
@attribute [Authorize(Roles = Constants.Roles.SuperAdmin)]
@inject HttpClient Http

<PageTitle>Game Management</PageTitle>

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Bowl Game Schedule</h1>
        <span class="badge bg-danger">Super Admin Zone</span>
    </div>

    <div class="card mb-5 shadow-sm">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0">Add Standard Bowl Game (Non-Playoff)</h5>
        </div>
        <div class="card-body">
            <EditForm Model="@newGame" OnValidSubmit="HandleSaveGame">
                <DataAnnotationsValidator />
                
                <div class="row g-3">
                    <div class="col-md-3">
                        <label for="bowlName" class="form-label">Bowl Name</label>
                        <InputText id="bowlName" class="form-control" @bind-Value="newGame.BowlName" placeholder="e.g. Potato Bowl" />
                    </div>
                    
                    <div class="col-md-3">
                        <label for="teamHome" class="form-label">Home Team</label>
                        <InputText id="teamHome" class="form-control" @bind-Value="newGame.TeamHome" placeholder="Home Team" />
                    </div>
                    <div class="col-md-3">
                        <label for="teamAway" class="form-label">Away Team</label>
                        <InputText id="teamAway" class="form-control" @bind-Value="newGame.TeamAway" placeholder="Away Team" />
                    </div>

                    <div class="col-md-3">
                        <label for="pointValue" class="form-label">Points</label>
                        <InputNumber id="pointValue" class="form-control" @bind-Value="newGame.PointValue" />
                    </div>

                    <div class="col-md-6">
                        <label for="startTime" class="form-label">Start Time (Central)</label>
                        <InputText id="startTime" class="form-control" @bind-Value="startTimeString" type="datetime-local" />
                    </div>

                    <div class="col-md-3">
                        <label for="location" class="form-label">Location</label>
                        <InputText id="location" class="form-control" @bind-Value="newGame.Location" placeholder="Stadium/City" />
                    </div>
                    <div class="col-md-3">
                        <label for="television" class="form-label">Television</label>
                        <InputText id="television" class="form-control" @bind-Value="newGame.Television" placeholder="Network" />
                    </div>
                </div>

                <div class="mt-3 text-end">
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-calendar-plus"></i> Save Game
                    </button>
                </div>
            </EditForm>
        </div>
    </div>

    <h3 class="mb-3">All Bowl Games</h3>
    @if (games == null)
    {
        <div class="alert alert-info">Loading games...</div>
    }
    else if (!games.Any())
    {
        <div class="alert alert-warning">No games have been scheduled yet.</div>
    }
    else
    {
        <div class="table-responsive">
            <table class="table table-striped table-hover border">
                <thead class="table-light">
                    <tr>
                        <th>Game</th>
                        <th>Matchup</th>
                        <th>Time (UTC)</th>
                        <th>Loc/TV</th>
                        <th>Points</th>
                        <th>Type</th>
                        <th class="text-end">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var game in games)
                    {
                        <tr>
                            <td><strong>@game.BowlName</strong></td>
                            <td>
                                @game.TeamHome @if(game.TeamHomeSeed.HasValue) { <span class="badge bg-primary">#@game.TeamHomeSeed</span> }
                                vs 
                                @game.TeamAway @if(game.TeamAwaySeed.HasValue) { <span class="badge bg-primary">#@game.TeamAwaySeed</span> }
                            </td>
                            <td>
                                @{
                                    var centralTime = TimeZoneInfo.ConvertTimeFromUtc(game.StartTime, CentralTimeZone);
                                }
                                @centralTime.ToString("MMM d, yyyy h:mm tt")
                            </td>
                            <td>
                                <div><small><i class="bi bi-geo-alt"></i> @game.Location</small></div>
                                <div><small><i class="bi bi-tv"></i> @game.Television</small></div>
                            </td>
                            <td>@game.PointValue</td>
                            <td>
                                @if(game.IsPlayoff)
                                {
                                    <span class="badge bg-warning text-dark">Playoff R-@game.Round</span>
                                }
                                else
                                {
                                    <span class="badge bg-secondary">Standard</span>
                                }
                            </td>
                            <td class="text-end">
                                <button class="btn btn-sm btn-outline-primary" disabled title="Coming Soon">Edit</button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>

@code {
    private List<BowlGame>? games;
    private BowlGame newGame = new BowlGame { PointValue = 1 };
    // Initialize to tomorrow at noon Central
    private string startTimeString = ""; 

    // Helper for Central Time - Try IANA first (better for WASM), fall back to Windows
    private TimeZoneInfo CentralTimeZone
    {
        get
        {
            try
            {
                return TimeZoneInfo.FindSystemTimeZoneById("America/Chicago");
            }
            catch
            {
                try 
                {
                    return TimeZoneInfo.FindSystemTimeZoneById("Central Standard Time");
                }
                catch
                {
                    // Fallback to local if nothing else works to prevent crash
                    Console.WriteLine("Warning: Could not find Central Time zone. Defaulting to Local.");
                    return TimeZoneInfo.Local;
                }
            }
        }
    }

    protected override async Task OnInitializedAsync()
    {
        // Set initial default time in Central
        var tomorrowCentral = TimeZoneInfo.ConvertTimeFromUtc(DateTime.UtcNow.AddDays(1), CentralTimeZone);
        startTimeString = tomorrowCentral.ToString("yyyy-MM-ddTHH:mm");
        
        await LoadGames();
    }

    private async Task LoadGames()
    {
        try
        {
            // Note: The API is called "GetGames", so we'll use that as the route suffix.
            games = await Http.GetFromJsonAsync<List<BowlGame>>("api/GetGames");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[Game Admin] Error loading games: {ex.Message}");
        }
    }

    private async Task HandleSaveGame()
    {
        // 1. Manually update StartTime from the InputText string (Treating input as Central)
        if (DateTime.TryParse(startTimeString, out DateTime parsedLocal))
        {
            // The parser might treat it as Unspecified, which is what we want for "wall clock time" in Central.
            // Convert that "wall clock" Central time to UTC.
             newGame.StartTime = TimeZoneInfo.ConvertTimeToUtc(parsedLocal, CentralTimeZone);
        }
        else
        {
            Console.WriteLine("Invalid Date/Time entered.");
            return;
        }

        try 
        {
            // This hits the SuperAdmin-protected SaveGame endpoint
            var response = await Http.PostAsJsonAsync("api/SaveGame", newGame);
            
            if (response.IsSuccessStatusCode)
            {
                // Reset form and reload list
                newGame = new BowlGame { PointValue = 1 };
                var tomorrowCentral = TimeZoneInfo.ConvertTimeFromUtc(DateTime.UtcNow.AddDays(1), CentralTimeZone);
                startTimeString = tomorrowCentral.ToString("yyyy-MM-ddTHH:mm");
                
                await LoadGames();
            }
            else
            {
                // In a production app, we would log the failure details from the response body
                Console.WriteLine($"[Game Admin] Game save failed: {response.StatusCode}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[Game Admin] Error saving game: {ex.Message}");
        }
    }
}
