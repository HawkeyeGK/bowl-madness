@page "/print-bracket"
@layout BowlPoolManager.Client.Layout.PrintLayout
@using BowlPoolManager.Core.Domain
@using BowlPoolManager.Core
@inject HttpClient Http

<PageTitle>Printable Bracket</PageTitle>

@if (games == null)
{
    <div class="p-5 text-center">Loading Bracket...</div>
}
else
{
    <div class="text-center mb-2 no-print d-flex gap-2 justify-content-center">
        <button class="btn btn-primary btn-sm" onclick="window.print()">
            <i class="bi bi-printer"></i> Print (Landscape)
        </button>
        <a href="/" class="btn btn-outline-secondary btn-sm">Back to Home</a>
    </div>

    <div class="print-wrapper">
        <div class="header-row">
            <div class="inputs-area">
                <div class="input-group">
                    <span class="label">Player Name:</span>
                    <div class="line" style="width: 250px;"></div>
                </div>
                <div class="input-group">
                    <span class="label">Tiebreaker (Total Pts):</span>
                    <div class="line" style="width: 80px;"></div>
                </div>
            </div>
            <div class="title-area">
                <h1 class="m-0">BOWL MADNESS 2025</h1>
                <div class="sub-text">Circle the winner for every game.</div>
            </div>
        </div>

        <div class="standard-grid">
            @foreach (var game in GetStandardGames())
            {
                <div class="game-box">
                    <div class="game-header">
                        <span class="bowl-name">@game.BowlName</span>
                    </div>
                    <div class="game-meta">
                        @FormatCompact(game)
                    </div>
                    <div class="matchup">
                        <div class="team">@game.TeamHome</div>
                        <div class="vs">vs</div>
                        <div class="team">@game.TeamAway</div>
                    </div>
                </div>
            }
        </div>

        <div class="bracket-section">
            <div class="bracket-title">The Playoffs</div>
            
            <div class="bracket-container">
                <div class="round-col">
                    <div class="round-header">First Round</div>
                    @foreach (var game in GetPlayoffGames(PlayoffRound.Round1))
                    {
                        <div class="match-card">
                            <div class="game-meta-row">@game.BowlName <span class="meta-right">@FormatTimeShort(game.StartTime) (@game.Television)</span></div>
                            <div class="team-slot">@game.TeamHome</div>
                            <div class="team-slot">@game.TeamAway</div>
                        </div>
                    }
                </div>

                <div class="round-col">
                    <div class="round-header">Quarterfinals</div>
                    @foreach (var game in GetPlayoffGames(PlayoffRound.QuarterFinal))
                    {
                        <div class="match-card">
                            <div class="game-meta-row">@game.BowlName <span class="meta-right">@FormatTimeShort(game.StartTime)</span></div>
                            <div class="team-slot">@(string.IsNullOrEmpty(game.TeamHome) ? "Rd 1 Winner" : game.TeamHome)</div>
                            <div class="team-slot">@(string.IsNullOrEmpty(game.TeamAway) ? "Rd 1 Winner" : game.TeamAway)</div>
                        </div>
                    }
                </div>

                <div class="round-col">
                    <div class="round-header">Semifinals</div>
                    @foreach (var game in GetPlayoffGames(PlayoffRound.SemiFinal))
                    {
                        <div class="match-card spacer-lg">
                            <div class="game-meta-row">@game.BowlName</div>
                            <div class="team-slot">QF Winner</div>
                            <div class="team-slot">QF Winner</div>
                        </div>
                    }
                </div>

                <div class="round-col">
                    <div class="round-header">Championship</div>
                    @foreach (var game in GetPlayoffGames(PlayoffRound.Championship))
                    {
                        <div class="match-card champ-card">
                            <div class="game-meta-row text-center">@game.BowlName</div>
                            <div class="team-slot">Semi Winner</div>
                            <div class="team-slot">Semi Winner</div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
}

<style>
    /* RESET & PRINT SETTINGS */
    :root {
        --border-color: #888;
        --bg-color: #f8f9fa;
    }
    @@media print {
        @@page { size: landscape; margin: 0.25in; }
        body { zoom: 95%; background-color: white !important; }
        .no-print { display: none !important; }
        .game-box { break-inside: avoid; background-color: transparent !important; border-color: #000 !important; }
        .match-card { background-color: transparent !important; }
    }

    .print-wrapper { font-family: 'Arial Narrow', sans-serif; color: #000; max-width: 100%; }

    /* HEADER */
    .header-row { display: flex; justify-content: space-between; align-items: flex-end; border-bottom: 2px solid #000; padding-bottom: 5px; margin-bottom: 8px; }
    .inputs-area { display: flex; gap: 20px; }
    .input-group { display: flex; align-items: flex-end; gap: 5px; }
    .input-group .label { font-weight: bold; font-size: 0.9rem; }
    .input-group .line { border-bottom: 1px solid #000; height: 1px; }
    .title-area { text-align: right; }
    .title-area h1 { font-size: 1.5rem; font-weight: 900; line-height: 1; }
    .sub-text { font-size: 0.8rem; font-style: italic; }

    /* STANDARD GRID (Dense) */
    .standard-grid {
        display: grid;
        grid-template-columns: repeat(5, 1fr); /* 5 Columns */
        gap: 6px;
        margin-bottom: 10px;
    }
    .game-box {
        border: 1px solid var(--border-color);
        padding: 3px 5px;
        font-size: 0.75rem;
        background-color: var(--bg-color);
    }
    .game-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ddd; padding-bottom: 1px; margin-bottom: 1px; }
    .bowl-name { font-weight: 800; text-transform: uppercase; font-size: 0.7rem; color: #000; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .game-meta { font-size: 0.65rem; color: #444; margin-bottom: 2px; white-space: nowrap; overflow: hidden; }
    
    .matchup { display: flex; flex-direction: column; justify-content: center; line-height: 1.1; }
    .team { font-weight: 600; font-size: 0.8rem; }
    .vs { font-size: 0.6rem; color: #888; text-align: center; margin: 1px 0; display: none; } /* Hidden to save space, implied by stacking */

    /* BRACKET SECTION */
    .bracket-section { border-top: 2px solid #000; padding-top: 5px; margin-top: 5px; }
    .bracket-title { text-align: center; font-weight: 800; text-transform: uppercase; font-size: 0.9rem; margin-bottom: 5px; }
    
    .bracket-container {
        display: flex;
        justify-content: space-between;
        height: 320px; /* Constrained height */
    }
    .round-col {
        display: flex;
        flex-direction: column;
        justify-content: space-around;
        flex: 1;
        margin: 0 4px;
        position: relative;
    }
    .round-header { text-align: center; font-weight: bold; font-size: 0.75rem; text-transform: uppercase; background: #eee; border: 1px solid #ccc; margin-bottom: 5px; }

    .match-card {
        border: 1px solid #000;
        padding: 2px 4px;
        position: relative;
        font-size: 0.75rem;
        background: #fff;
    }
    .game-meta-row { font-size: 0.65rem; font-weight: bold; border-bottom: 1px solid #ccc; margin-bottom: 2px; display: flex; justify-content: space-between; }
    .meta-right { font-weight: normal; font-size: 0.6rem; }
    
    .team-slot { border-bottom: 1px solid #eee; height: 16px; line-height: 16px; overflow: hidden; white-space: nowrap; }
    .champ-card { border: 2px solid #000; height: 60px; justify-content: center; display: flex; flex-direction: column; }

    /* Connectors */
    .round-col:not(:last-child) .match-card::after {
        content: ''; position: absolute; right: -6px; top: 50%;
        width: 6px; height: 1px; background: #000;
    }
</style>

@code {
    private List<BowlGame>? games;

    protected override async Task OnInitializedAsync()
    {
        try 
        {
            var allGames = await Http.GetFromJsonAsync<List<BowlGame>>("api/GetGames");
            games = allGames?.OrderBy(g => g.StartTime).ToList();
        }
        catch(Exception ex) { Console.WriteLine(ex.Message); }
    }

    private List<BowlGame> GetStandardGames() => games?.Where(g => !g.IsPlayoff).ToList() ?? new();
    private List<BowlGame> GetPlayoffGames(PlayoffRound round) => games?.Where(g => g.IsPlayoff && g.Round == round).OrderBy(g => g.StartTime).ToList() ?? new();

    private string FormatTimeShort(DateTime utc) => utc.ToLocalTime().ToString("MMM d h:mm tt");

    private string FormatCompact(BowlGame g)
    {
        // Example: Dec 17 2:00p (ESPN) - Miami
        var time = g.StartTime.ToLocalTime();
        var loc = string.IsNullOrEmpty(g.Location) ? "" : $" - {g.Location}";
        var tv = string.IsNullOrEmpty(g.Television) ? "" : $" ({g.Television})";
        return $"{time:MMM d h:mm tt}{tv}{loc}";
    }
}
