@page "/print-bracket"
@layout BowlPoolManager.Client.Layout.PrintLayout
@using BowlPoolManager.Core.Domain
@using BowlPoolManager.Core
@using BowlPoolManager.Client.Helpers
@inject HttpClient Http

<PageTitle>Printable Bracket</PageTitle>

@if (games == null)
{
    <div class="p-5 text-center">Loading Bracket...</div>
}
else
{
    <div class="text-center mb-2 no-print d-flex gap-2 justify-content-center">
        <button class="btn btn-primary btn-sm" onclick="window.print()">
            <i class="bi bi-printer"></i> Print (Landscape)
        </button>
        <a href="/" class="btn btn-outline-secondary btn-sm">Back to Home</a>
    </div>

    <div class="print-wrapper">
        <div class="header-row">
            <div class="inputs-area">
                <div class="input-group">
                    <span class="label">Name:</span>
                    <div class="line" style="width: 300px;"></div>
                </div>
                <div class="input-group">
                    <span class="label">Email:</span>
                    <div class="line" style="width: 300px;"></div>
                </div>
            </div>
            <div class="title-area">
                <h1 class="m-0">BOWL MADNESS 2025</h1>
                <div class="url-text">Bowl-Madness.com</div>
            </div>
        </div>

        <div class="standard-grid">
            @foreach (var game in standardGames)
            {
                <div class="game-box">
                    <div class="game-header">
                        <span class="bowl-name">@game.BowlName</span>
                    </div>
                    <div class="game-meta">
                        @FormatCompact(game)
                    </div>
                    <div class="matchup">
                        <div class="team">@game.TeamHome</div>
                        <div class="vs">vs</div>
                        <div class="team">@game.TeamAway</div>
                    </div>
                </div>
            }
        </div>

        <div class="bracket-section">
            <div class="bracket-container">
                @* ROUND 1 *@
                <div class="round-col">
                    <div class="round-header">First Round</div>
                    @foreach (var game in round1Games)
                    {
                        <div class="match-card">
                            <div class="game-meta-row">@game.BowlName <span class="meta-right">@FormatTimeShort(game.StartTime)</span></div>
                            <div class="team-slot">@game.TeamHome</div>
                            <div class="team-slot">@game.TeamAway</div>
                        </div>
                    }
                </div>

                @* QUARTERFINALS *@
                <div class="round-col">
                    <div class="round-header">Quarterfinals</div>
                    @foreach (var game in quarterGames)
                    {
                        <div class="match-card">
                            <div class="game-meta-row">@game.BowlName <span class="meta-right">@FormatTimeShort(game.StartTime)</span></div>
                            <div class="team-slot">@RenderSlot(game.TeamHome)</div>
                            <div class="team-slot">@RenderSlot(game.TeamAway)</div>
                        </div>
                    }
                </div>

                @* SEMIFINALS *@
                <div class="round-col">
                    <div class="round-header">Semifinals</div>
                    @foreach (var game in semiGames)
                    {
                        <div class="match-card spacer-lg">
                            <div class="game-meta-row">@game.BowlName</div>
                            <div class="team-slot">_________________</div>
                            <div class="team-slot">_________________</div>
                        </div>
                    }
                </div>

                @* CHAMPIONSHIP *@
                <div class="round-col center-vertical">
                    <div class="round-header">Championship</div>
                    @foreach (var game in champGames)
                    {
                        <div class="match-card champ-card">
                            <div class="game-meta-row text-center">@game.BowlName</div>
                            <div class="team-slot">_________________</div>
                            <div class="team-slot">_________________</div>
                            
                            <div class="champ-line">
                                <span class="small fw-bold me-1">CHAMPION:</span>
                                <span class="line-draw">_________________</span>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>

        <div class="rules-footer">
            <div class="rules-content">
                <strong>Standard Bowls:</strong> Circle the winner (@GetPointValue(false) pt each).<br/>
                <strong>Playoffs:</strong> Write winners on lines in NEXT bracket.<br/>
                <strong>Scoring:</strong> 
                First Round: @GetPointValue(true, PlayoffRound.Round1) | 
                Quarterfinals: @GetPointValue(true, PlayoffRound.QuarterFinal) | 
                Semifinals: @GetPointValue(true, PlayoffRound.SemiFinal) | 
                Championship: @GetPointValue(true, PlayoffRound.Championship) pts.
            </div>
            
            <div class="tiebreaker-row">
                <span class="fw-bold">Tiebreaker: Total points in the ReliaQuest Bowl (Iowa vs Vanderbilt)</span>
                <div class="line" style="width: 80px;"></div>
            </div>
        </div>
    </div>
}

<style>
    /* RESET & PRINT SETTINGS */
    :root { --border-color: #888; --bg-color: #f8f9fa; }
    @@media print {
        @@page { size: landscape; margin: 0.25in; }
        body { zoom: 95%; background-color: white !important; }
        .no-print { display: none !important; }
        .game-box { break-inside: avoid; background-color: transparent !important; border-color: #000 !important; }
        .match-card { background-color: transparent !important; }
    }

    .print-wrapper { font-family: 'Arial Narrow', sans-serif; color: #000; max-width: 100%; }

    /* HEADER */
    .header-row { display: flex; justify-content: space-between; align-items: flex-end; border-bottom: 2px solid #000; padding-bottom: 5px; margin-bottom: 6px; }
    .inputs-area { display: flex; gap: 20px; width: 70%; }
    .input-group { display: flex; align-items: flex-end; gap: 5px; }
    .input-group .label { font-weight: bold; font-size: 0.85rem; white-space: nowrap; }
    .input-group .line { border-bottom: 1px solid #000; height: 1px; }
    .title-area { text-align: right; }
    .title-area h1 { font-size: 1.4rem; font-weight: 900; line-height: 1; margin: 0; }
    .url-text { font-size: 0.9rem; font-weight: bold; text-transform: uppercase; color: #444; }

    /* STANDARD GRID (Dense) */
    .standard-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; margin-bottom: 8px; }
    .game-box { border: 1px solid var(--border-color); padding: 2px 4px; font-size: 0.7rem; background-color: var(--bg-color); }
    .game-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ddd; }
    .bowl-name { font-weight: 800; text-transform: uppercase; font-size: 0.65rem; color: #000; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .game-meta { font-size: 0.6rem; color: #444; margin-bottom: 1px; white-space: nowrap; overflow: hidden; }
    .matchup { display: flex; flex-direction: column; justify-content: center; line-height: 1.1; font-weight: 600; font-size: 0.75rem; }
    .vs { display: none; }

    /* BRACKET SECTION */
    .bracket-section { border-top: 2px solid #000; padding-top: 5px; margin-top: 5px; position: relative; }
    .bracket-container { display: flex; justify-content: space-between; height: 300px; }
    .round-col { display: flex; flex-direction: column; justify-content: space-around; flex: 1; margin: 0 4px; position: relative; }
    .round-col.center-vertical { justify-content: center; } 
    
    .round-header { text-align: center; font-weight: bold; font-size: 0.7rem; text-transform: uppercase; background: #eee; border: 1px solid #ccc; margin-bottom: 4px; }
    .center-vertical .round-header { position: absolute; top: 0; width: 100%; }

    .match-card { border: 1px solid #000; padding: 2px 4px; position: relative; font-size: 0.7rem; background: #fff; }
    .game-meta-row { font-size: 0.6rem; font-weight: bold; border-bottom: 1px solid #ccc; margin-bottom: 2px; display: flex; justify-content: space-between; }
    .meta-right { font-weight: normal; font-size: 0.55rem; }
    
    .team-slot { border-bottom: 1px solid #eee; height: 16px; line-height: 16px; overflow: hidden; white-space: nowrap; margin-bottom: 1px; }
    .champ-card { border: 2px solid #000; height: auto; min-height: 90px; padding-bottom: 5px; display: flex; flex-direction: column; justify-content: space-between; }
    .champ-line { margin-top: 8px; text-align: center; border-top: 1px dotted #ccc; padding-top: 4px; }
    .line-draw { font-weight: bold; }

    .round-col:not(:last-child) .match-card::after { content: ''; position: absolute; right: -6px; top: 50%; width: 6px; height: 1px; background: #000; }

    /* RULES FOOTER */
    .rules-footer { margin-top: 8px; border-top: 1px double #000; padding-top: 4px; font-size: 0.75rem; }
    .rules-content { margin-bottom: 10px; line-height: 1.4; }
    
    .tiebreaker-row { display: flex; align-items: flex-end; gap: 10px; }
    .tiebreaker-row .line { border-bottom: 1px solid #000; height: 1px; }
</style>

@code {
    private List<BowlGame>? games;
    
    // Sorted Lists for Bracket Display
    private List<BowlGame> standardGames = new();
    private List<BowlGame> round1Games = new();
    private List<BowlGame> quarterGames = new();
    private List<BowlGame> semiGames = new();
    private List<BowlGame> champGames = new();

    protected override async Task OnInitializedAsync()
    {
        try 
        {
            var allGames = await Http.GetFromJsonAsync<List<BowlGame>>("api/GetGames");
            games = allGames ?? new();
            PrepareBracket();
        }
        catch(Exception ex) { Console.WriteLine(ex.Message); }
    }

    private void PrepareBracket()
    {
        if (games == null) return;

        // 1. Standard Games (No specific order needed, just time)
        standardGames = games.Where(g => !g.IsPlayoff).OrderBy(g => g.StartTime).ToList();

        // 2. Championship (The Anchor)
        champGames = games.Where(g => g.IsPlayoff && g.Round == PlayoffRound.Championship).OrderBy(g => g.StartTime).ToList();

        // 3. Semis - Sort by which Champ game they feed into
        semiGames = SortRoundByNext(PlayoffRound.SemiFinal, champGames);

        // 4. Quarters - Sort by which Semi they feed into
        quarterGames = SortRoundByNext(PlayoffRound.QuarterFinal, semiGames);

        // 5. Round 1 - Sort by which Quarter they feed into
        round1Games = SortRoundByNext(PlayoffRound.Round1, quarterGames);
    }

    // Helper: Sorts current round based on the order of the games in the next round
    private List<BowlGame> SortRoundByNext(PlayoffRound currentRound, List<BowlGame> nextRoundSorted)
    {
        var roundGames = games!.Where(g => g.IsPlayoff && g.Round == currentRound).ToList();

        return roundGames.OrderBy(g => 
        {
            // Find index of the target game in the next round's sorted list
            var targetIndex = nextRoundSorted.FindIndex(next => next.Id == g.NextGameId);
            // If unlinked, push to bottom
            return targetIndex == -1 ? int.MaxValue : targetIndex;
        })
        .ThenBy(g => g.StartTime) // Secondary sort for pairs feeding the same game
        .ToList();
    }

    // Replaces explicit "CT" append with DateTimeHelper logic + suffix
    private string FormatTimeShort(DateTime utc) => DateTimeHelper.ToCentral(utc).ToString("MMM d h:mm tt") + " CT";

    private string FormatCompact(BowlGame g)
    {
        var time = DateTimeHelper.ToCentral(g.StartTime);
        var loc = string.IsNullOrEmpty(g.Location) ? "" : $" - {g.Location}";
        var tv = string.IsNullOrEmpty(g.Television) ? "" : $" ({g.Television})";
        return $"{time:MMM d h:mm tt} CT{tv}{loc}";
    }

    private string RenderSlot(string? teamName) => string.IsNullOrEmpty(teamName) ? "_________________" : teamName;
    
    private string GetPointValue(bool isPlayoff, PlayoffRound? round = null)
    {
        if (games == null) return "0";
        BowlGame? sample = !isPlayoff 
            ? games.FirstOrDefault(g => !g.IsPlayoff)
            : games.FirstOrDefault(g => g.IsPlayoff && g.Round == round);
        return sample != null ? sample.PointValue.ToString() : "-";
    }
}
