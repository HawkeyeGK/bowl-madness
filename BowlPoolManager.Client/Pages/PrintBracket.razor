@page "/print-bracket"
@page "/print-bracket/{EntryId}"
@layout BowlPoolManager.Client.Layout.PrintLayout
@using BowlPoolManager.Core.Domain
@using BowlPoolManager.Core

@inject HttpClient Http

@inject NavigationManager Nav
@inject IJSRuntime JSRuntime

<PageTitle>Printable Bracket</PageTitle>

@if (games == null)
{
    <div class="p-5 text-center">Loading Bracket...</div>
}
else
{
    <div class="text-center mb-2 no-print d-flex gap-2 justify-content-center align-items-center">
        @if (string.IsNullOrEmpty(EntryId) && pools.Count > 1)
        {
            <select class="form-select form-select-sm w-auto" @onchange="OnPoolChanged">
                @foreach (var pool in pools)
                {
                    <option value="@pool.Id" selected="@(pool.Id == currentPool?.Id)">@pool.Name</option>
                }
            </select>
        }
        <button class="btn btn-primary btn-sm" onclick="window.print()">
            <i class="bi bi-printer"></i> Print (Landscape)
        </button>
        <a href="/" class="btn btn-outline-secondary btn-sm">Back to Home</a>
    </div>

    <div class="print-wrapper">
        <div class="header-row">
             <div class="inputs-area">
                <div class="input-group">
                    <span class="label">Name:</span>
                    <div class="line" style="width: 300px;">
                        @if(userEntry != null) { <span class="handwritten">@userEntry.PlayerName</span> }
                    </div>
                </div>
                <div class="input-group">
                    <span class="label">Email:</span>
                    <div class="line" style="width: 300px;"></div>
                 </div>
            </div>
            <div class="title-area">
                <h1 class="m-0">BOWL MADNESS @DateTime.Now.Year</h1>
                <div class="url-text">Bowl-Madness.com</div>
            </div>
        </div>

        <div class="standard-grid">
            @foreach (var game in standardGames)
            {
                <div class="game-box">
                    <div class="game-header">
                        <span class="bowl-name">@game.BowlName</span>
                     </div>
                    <div class="game-meta">
                        @FormatCompact(game)
                    </div>
                    
                    <div class="matchup">
                        <div class="team @GetPickClass(game, game.TeamHome)">@game.TeamHome</div>
                        <div class="vs">vs</div>
                        <div class="team @GetPickClass(game, game.TeamAway)">@game.TeamAway</div>
                    </div>
                </div>
            }
        </div>

        <div class="bracket-section">
            <div class="bracket-container">
                @* ROUND 1 *@
                <div class="round-col">
                     <div class="round-header">First Round</div>
                     <div class="games-container">
                        @foreach (var game in round1Games)
                        {
                            <div class="match-card">
                                 <div class="game-meta-row">@game.BowlName <span class="meta-right">@FormatTimeShort(game.StartTime)</span></div>
                                <div class="team-slot @GetPickClass(game, game.TeamHome)">@game.TeamHome</div>
                                <div class="team-slot @GetPickClass(game, game.TeamAway)">@game.TeamAway</div>
                             </div>
                        }
                    </div>
                </div>

                @* QUARTERFINALS *@
                <div class="round-col">
                    <div class="round-header">Quarterfinals</div>
                    <div class="games-container">
                        @foreach (var game in quarterGames)
                        {
                            var participants = GetParticipants(game);
                            <div class="match-card">
                                <div class="game-meta-row">@game.BowlName <span class="meta-right">@FormatTimeShort(game.StartTime)</span></div>
                                <div class="team-slot @GetPickClass(game, participants.Top)">@RenderSlot(participants.Top)</div>
                                <div class="team-slot @GetPickClass(game, participants.Bottom)">@RenderSlot(participants.Bottom)</div>
                             </div>
                        }
                    </div>
                </div>

                @* SEMIFINALS *@
                <div class="round-col">
                     <div class="round-header">Semifinals</div>
                     <div class="games-container">
                        @foreach (var game in semiGames)
                        {
                            var participants = GetParticipants(game);
                            <div class="match-card spacer-lg">
                                <div class="game-meta-row">@game.BowlName</div>
                                <div class="team-slot @GetPickClass(game, participants.Top)">@RenderSlot(participants.Top)</div>
                                <div class="team-slot @GetPickClass(game, participants.Bottom)">@RenderSlot(participants.Bottom)</div>
                             </div>
                        }
                    </div>
                </div>

                @* CHAMPIONSHIP *@
                <div class="round-col center-vertical">
                     <div class="round-header">Championship</div>
                     <div class="games-container">
                        @foreach (var game in champGames)
                        {
                            var participants = GetParticipants(game);
                            <div class="match-card champ-card">
                                <div class="game-meta-row text-center">@game.BowlName</div>
                                <div class="team-slot @GetPickClass(game, participants.Top)">@RenderSlot(participants.Top)</div>
                                <div class="team-slot @GetPickClass(game, participants.Bottom)">@RenderSlot(participants.Bottom)</div>
                                 
                                <div class="champ-line">
                                    <span class="small fw-bold me-1">CHAMPION:</span>
                                     @if (userEntry != null && userEntry.Picks != null && userEntry.Picks.TryGetValue(game.Id, out var winner))
                                    {
                                        <span class="line-draw handwritten text-danger">@winner</span>
                                     }
                                    else
                                    {
                                         <span class="line-draw">_________________</span>
                                    }
                                </div>
                             </div>
                        }
                    </div>
                </div>
            </div>
        </div>

        <div class="rules-footer">
            <div class="rules-content">
                 <strong>Standard Bowls:</strong> Circle the winner (@GetPointValue(false) pt each).<br/>
                <strong>Playoffs:</strong> Write winners on lines in NEXT bracket.<br/>
                <strong>Scoring:</strong> 
                First Round: @GetPointValue(true, PlayoffRound.Round1) |
                Quarterfinals: @GetPointValue(true, PlayoffRound.QuarterFinal) | 
                Semifinals: @GetPointValue(true, PlayoffRound.SemiFinal) | 
                Championship: @GetPointValue(true, PlayoffRound.Championship) pts.
            </div>
            
            <div class="tiebreaker-row">
                <span class="fw-bold">Tiebreaker: Total points in the ReliaQuest Bowl (Iowa vs Vanderbilt)</span>
                <div class="line" style="width: 80px; text-align: center;">
                     @if(userEntry != null) { <span class="handwritten">@userEntry.TieBreakerPoints</span> }
                 </div>
            </div>
        </div>
    </div>
}

<style>
    /* ... (KEEP STYLES AS IS) ... */
    :root { --border-color: #888; --bg-color: #f8f9fa; }
    @@media print {
        @@page { size: landscape; margin: 0.25in; }
        body { zoom: 95%; background-color: white !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        .no-print { display: none !important; }
        .game-box { break-inside: avoid; background-color: transparent !important; border-color: #000 !important; }
        .match-card { background-color: transparent !important; }
        .user-pick-correct { box-shadow: inset 0 0 0 2px #198754 !important; background-color: #d1e7dd !important; font-weight: bold; }
        .user-pick-incorrect { box-shadow: inset 0 0 0 2px #dc3545 !important; background-color: #f8d7da !important; font-weight: bold; }
        .user-pick-pending { box-shadow: inset 0 0 0 2px #0d6efd !important; background-color: #cfe2ff !important; font-weight: bold; }
        .handwritten { color: #dc3545 !important; font-weight: bold; font-family: "Courier New", Courier, monospace; }
    }
    .print-wrapper { font-family: 'Arial Narrow', sans-serif; color: #000; max-width: 100%; }
    .user-pick-correct { box-shadow: inset 0 0 0 2px #198754; background-color: #d1e7dd; font-weight: bold; border-radius: 3px; padding-left: 2px; }
    .user-pick-incorrect { box-shadow: inset 0 0 0 2px #dc3545; background-color: #f8d7da; font-weight: bold; border-radius: 3px; padding-left: 2px; }
    .user-pick-pending { box-shadow: inset 0 0 0 2px #0d6efd; background-color: #cfe2ff; font-weight: bold; border-radius: 3px; padding-left: 2px; }
    .handwritten { color: #dc3545; font-weight: 800; font-family: "Courier New", Courier, monospace; font-size: 1.1em; letter-spacing: -0.5px; }
    .header-row { display: flex; justify-content: space-between; align-items: flex-end; border-bottom: 2px solid #000; padding-bottom: 5px; margin-bottom: 6px; }
    .inputs-area { display: flex; gap: 20px; width: 70%; }
    .input-group { display: flex; align-items: flex-end; gap: 5px; }
    .input-group .label { font-weight: bold; font-size: 0.85rem; white-space: nowrap; }
    .input-group .line { border-bottom: 1px solid #000; height: 18px; line-height: 18px; padding-left: 5px; }
    .title-area { text-align: right; }
    .title-area h1 { font-size: 1.4rem; font-weight: 900; line-height: 1; margin: 0; }
    .url-text { font-size: 0.9rem; font-weight: bold; text-transform: uppercase; color: #444; }
    .standard-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; margin-bottom: 8px; }
    .game-box { border: 1px solid var(--border-color); padding: 2px 4px; font-size: 0.7rem; background-color: var(--bg-color); }
    .game-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ddd; }
    .bowl-name { font-weight: 800; text-transform: uppercase; font-size: 0.65rem; color: #000; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .game-meta { font-size: 0.6rem; color: #444; margin-bottom: 1px; white-space: nowrap; overflow: hidden; }
    .matchup { display: flex; flex-direction: column; justify-content: center; line-height: 1.1; font-weight: 600; font-size: 0.75rem; }
    .vs { display: none; }
    .team { padding: 1px 2px; }
    .bracket-section { border-top: 2px solid #000; padding-top: 5px; margin-top: 5px; position: relative; }
    .bracket-container { display: flex; justify-content: space-between; height: 300px; }
    .round-col { display: flex; flex-direction: column; flex: 1; margin: 0 4px; position: relative; }
    .games-container { display: flex; flex-direction: column; justify-content: space-around; flex: 1; }
    .round-col.center-vertical { justify-content: flex-start; } 
    .round-header { text-align: center; font-weight: bold; font-size: 0.7rem; text-transform: uppercase; background: #eee; border: 1px solid #ccc; margin-bottom: 4px; height: 18px; line-height: 16px; }
    .center-vertical .round-header { position: relative; top: auto; width: 100%; }
    .match-card { border: 1px solid #000; padding: 2px 4px; position: relative; font-size: 0.7rem; background: #fff; }
    .game-meta-row { font-size: 0.6rem; font-weight: bold; border-bottom: 1px solid #ccc; margin-bottom: 2px; display: flex; justify-content: space-between; }
    .meta-right { font-weight: normal; font-size: 0.55rem; }
    .team-slot { border-bottom: 1px solid #eee; height: 18px; line-height: 16px; overflow: hidden; white-space: nowrap; margin-bottom: 1px; }
    .champ-card { border: 2px solid #000; height: auto; min-height: 90px; padding-bottom: 5px; display: flex; flex-direction: column; justify-content: space-between; }
    .champ-line { margin-top: 8px; text-align: center; border-top: 1px dotted #ccc; padding-top: 4px; }
    .line-draw { font-weight: bold; }
    .round-col:not(:last-child) .match-card::after { content: ''; position: absolute; right: -6px; top: 50%; width: 6px; height: 1px; background: #000; }
    .rules-footer { margin-top: 8px; border-top: 1px double #000; padding-top: 4px; font-size: 0.75rem; }
    .rules-content { margin-bottom: 10px; line-height: 1.4; }
    .tiebreaker-row { display: flex; align-items: flex-end; gap: 10px; }
    .tiebreaker-row .line { border-bottom: 1px solid #000; height: 18px; }
</style>

@code {
    [Parameter] public string? EntryId { get; set; }

    [SupplyParameterFromQuery(Name = "poolId")]
    public string? QueryPoolId { get; set; }

    private List<BowlGame>? games;
    private List<BowlGame> allSeasonGames = new();
    private List<BowlPool> pools = new();
    private BowlPool? currentPool;
    private BracketEntry? userEntry;
    
    private List<BowlGame> standardGames = new();
    private List<BowlGame> round1Games = new();
    private List<BowlGame> quarterGames = new();
    private List<BowlGame> semiGames = new();
    private List<BowlGame> champGames = new();

    protected override async Task OnInitializedAsync()
    {
        try 
        {
            var poolsTask = Http.GetFromJsonAsync<List<BowlPool>>("api/GetPools");
            var gamesTask = Http.GetFromJsonAsync<List<BowlGame>>("api/GetGames");
            var entryTask = FetchEntry();
            var myEntriesTask = FetchMyEntriesSafe(); // Needed for fallback logic if EntryId is null

            await Task.WhenAll(poolsTask, gamesTask, entryTask, myEntriesTask);

            pools = await poolsTask ?? new();
            allSeasonGames = await gamesTask ?? new();
            
            // Only active pools for the selector
            pools = pools.Where(p => !p.IsArchived).ToList();

            // 1. DETERMINE POOL
            if (!string.IsNullOrEmpty(EntryId) && userEntry != null)
            {
                // Locked to Entry's pool
                currentPool = pools.FirstOrDefault(p => p.Id == userEntry.PoolId);
            }
            else
            {
                // Blank Bracket Logic
                if (!string.IsNullOrEmpty(QueryPoolId))
                {
                     currentPool = pools.FirstOrDefault(p => p.Id == QueryPoolId);
                }
                else
                {
                    // Try Local Storage
                     try
                    {
                        var savedPoolId = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "lastSelectedPoolId");
                        if (!string.IsNullOrEmpty(savedPoolId))
                        {
                            currentPool = pools.FirstOrDefault(p => p.Id == savedPoolId);
                        }
                    }
                    catch { /* Ignore */ }

                    // Fallback to My Entries
                    if (currentPool == null)
                    {
                        var myEntries = await myEntriesTask;
                        if (myEntries.Any())
                        {
                             var lastEntry = myEntries.OrderByDescending(e => e.CreatedOn).First();
                             currentPool = pools.FirstOrDefault(p => p.Id == lastEntry.PoolId);
                        }
                    }
                }
            }

            // Fallback Default
            if (currentPool == null) currentPool = pools.FirstOrDefault();

            PrepareBracket();
        }
        catch(Exception ex) { Console.WriteLine(ex.Message); }
    }

    private async Task<List<BracketEntry>> FetchMyEntriesSafe()
    {
        try 
        {
             // We can check local storage or auth state if needed, but the API handles the auth check
             // This needs to be safe because the user might not be logged in
             return await Http.GetFromJsonAsync<List<BracketEntry>>("api/GetMyEntries") ?? new();
        }
        catch { return new(); }
    }

    private async Task OnPoolChanged(ChangeEventArgs e)
    {
        var poolId = e.Value?.ToString();
        if (string.IsNullOrEmpty(poolId)) return;

        currentPool = pools.FirstOrDefault(p => p.Id == poolId);
        if (currentPool != null)
        {
            await JSRuntime.InvokeVoidAsync("localStorage.setItem", "lastSelectedPoolId", currentPool.Id);
            PrepareBracket();
        }
    }

    private async Task FetchEntry()
    {
        if (!string.IsNullOrEmpty(EntryId))
        {
            try 
            {
                userEntry = await Http.GetFromJsonAsync<BracketEntry>($"api/GetEntry?id={EntryId}");
            }
            catch { }
        }
    }

    private void PrepareBracket()
    {
        if (currentPool == null) return;
        
        // Filter games based on the selected pool
        if (currentPool.GameIds != null && currentPool.GameIds.Any())
        {
            games = allSeasonGames.Where(g => currentPool.GameIds.Contains(g.Id)).ToList();
        }
        else
        {
            games = allSeasonGames.ToList();
        }

        // Global Safety: Ensure we ONLY show games for the pool's season
        games = games.Where(g => g.SeasonId == currentPool.SeasonId).ToList();

        standardGames = games.Where(g => !g.IsPlayoff).OrderBy(g => g.StartTime).ToList();
        champGames = games.Where(g => g.IsPlayoff && g.Round == PlayoffRound.Championship).OrderBy(g => g.StartTime).ToList();
        semiGames = SortRoundByNext(PlayoffRound.SemiFinal, champGames);
        quarterGames = SortRoundByNext(PlayoffRound.QuarterFinal, semiGames);
        round1Games = SortRoundByNext(PlayoffRound.Round1, quarterGames);
        
        StateHasChanged();
    }

    private List<BowlGame> SortRoundByNext(PlayoffRound currentRound, List<BowlGame> nextRoundSorted)
    {
        var roundGames = games!.Where(g => g.IsPlayoff && g.Round == currentRound).ToList();
        return roundGames.OrderBy(g => 
        {
            var targetIndex = nextRoundSorted.FindIndex(next => next.Id == g.NextGameId);
            return targetIndex == -1 ? int.MaxValue : targetIndex;
        }).ThenBy(g => g.StartTime).ToList();
    }

    private string GetPickClass(BowlGame game, string? teamName)
    {
        if (userEntry == null || userEntry.Picks == null || string.IsNullOrEmpty(teamName)) return "";
        
        if (userEntry.Picks.TryGetValue(game.Id, out var pick) && pick == teamName)
        {
            if (game.IsFinal)
            {
                return string.Equals(pick, game.WinningTeamName, StringComparison.OrdinalIgnoreCase) 
                    ? "user-pick-correct" 
                    : "user-pick-incorrect";
            }
            // Pending/Future Game
            return "user-pick-pending";
        }
        return "";
    }

    private (string? Top, string? Bottom) GetParticipants(BowlGame game)
    {
        string? top = game.TeamHome;
        string? bottom = game.TeamAway;

        bool topNeedsFill = string.IsNullOrEmpty(top) || top == "TBD";
        bool bottomNeedsFill = string.IsNullOrEmpty(bottom) || bottom == "TBD";
        
        if (topNeedsFill || bottomNeedsFill)
        {
            var feeders = games!.Where(g => g.NextGameId == game.Id).OrderBy(g => g.StartTime).ToList();
            var feederQueue = new Queue<BowlGame>(feeders);

            if (topNeedsFill && feederQueue.Count > 0)
            {
                top = GetWinnerOf(feederQueue.Dequeue());
            }

            if (bottomNeedsFill && feederQueue.Count > 0)
            {
                bottom = GetWinnerOf(feederQueue.Dequeue());
            }
        }
        return (top, bottom);
    }

    private string? GetWinnerOf(BowlGame game)
    {
        if (userEntry != null && userEntry.Picks != null && userEntry.Picks.TryGetValue(game.Id, out var winner)) return winner;
        return null;
    }


    private string FormatTimeShort(DateTime utc) => DateTimeHelper.ToCentral(utc).ToString("MMM d h:mm tt") + " CT";
    private string FormatCompact(BowlGame g)
    {
        var time = DateTimeHelper.ToCentral(g.StartTime);
        var loc = string.IsNullOrEmpty(g.Location) ? "" : $" - {g.Location}";
        var tv = string.IsNullOrEmpty(g.Television) ? "" : $" ({g.Television})";
        return $"{time:MMM d h:mm tt} CT{tv}{loc}";
    }

    private string RenderSlot(string? teamName) => string.IsNullOrEmpty(teamName) ? "_________________" : teamName;
    private string GetPointValue(bool isPlayoff, PlayoffRound? round = null)
    {
        if (games == null) return "0";
        BowlGame? sample = !isPlayoff 
            ? games.FirstOrDefault(g => !g.IsPlayoff)
            : games.FirstOrDefault(g => g.IsPlayoff && g.Round == round);
        return sample != null ? sample.PointValue.ToString() : "-";
    }
}
